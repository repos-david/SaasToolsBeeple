<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Team wizard</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="icon" href="https://cdn.prod.website-files.com/64dc9a6f21257128d0afb983/6601688c81ef6ab1df9e63ad_favicon-beeple.png">
<style>
:root {
  --bg:#f6f8ff; --bg2:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#475569;
  --accent:#4e6bff; --accent2:#7da2ff; --accentSoft:#e9efff; --danger:#ef6b6b;
  --border:rgba(15,23,42,.10); --field:#ffffff; --fieldBorder:#e5e7eb;
  --tableHead:#eef2ff; --radius:10px; --radius-lg:14px;
  --shadow:0 4px 20px rgba(15,23,42,.08),0 1px 0 rgba(15,23,42,.04);
}
[data-theme="dark"] {
  --bg:#0b1020; --bg2:#0e1428; --card:#0f1630; --text:#e8ecff; --muted:#b8c3ef;
  --accent:#5aa2ff; --accent2:#7ec3ff; --accentSoft:#0e2244; --danger:#e66d6d;
  --border:rgba(255,255,255,.14); --field:#121b39; --fieldBorder:rgba(255,255,255,.18);
  --tableHead:#13224a; --shadow:0 8px 28px rgba(0,0,0,.35),0 1px 0 rgba(255,255,255,.04);
}
/* OVERFLOW FIX: max-width:100% on all elements + clip on root */
*,*::before,*::after { box-sizing:border-box; max-width:100%; }
html { overflow-x:clip; }
body {
  margin:0; overflow-x:clip;
  background:linear-gradient(180deg,var(--bg) 0%,var(--bg2) 100%);
  color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  font-size:15px; line-height:1.55;
  transition:background .25s,color .25s;
  -webkit-text-size-adjust:100%; text-size-adjust:100%;
}
/* TOP BAR */
.topbar { position:sticky; top:0; z-index:20; background:var(--card); border-bottom:1px solid var(--border); overflow:hidden; }
.topwrap { width:100%; max-width:980px; margin:0 auto; padding:10px 14px 6px; }
.toprow1 { display:flex; align-items:center; justify-content:space-between; gap:10px; }
.brand img { display:block; height:24px; width:auto; }
.page-title { text-align:center; font-weight:800; font-size:clamp(20px,5vw,30px); line-height:1.2; margin:6px 0 4px; }
/* theme toggle: width:auto so it does NOT stretch in flex */
.theme-toggle {
  flex-shrink:0; width:auto; display:inline-flex; align-items:center;
  white-space:nowrap; border:1px solid var(--border); background:var(--accentSoft);
  color:#18224d; padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:700; font-size:13px;
}
[data-theme="dark"] .theme-toggle { color:#dbe7ff; }
/* CONTAINER */
.container { width:100%; max-width:980px; margin:14px auto 36px; padding:0 12px; display:grid; gap:14px; }
/* CARDS */
.card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:16px; box-shadow:var(--shadow); overflow:hidden; min-width:0; }
.card h2 { margin:0 0 10px; font-size:17px; }
.sub { color:var(--muted); font-size:13px; margin-top:4px; }
@media(max-width:400px){ .card{padding:12px;} }
/* FORM ELEMENTS (inputs/selects/textareas ONLY — not buttons) */
input,select,textarea {
  display:block; width:100%; padding:11px 12px;
  border:1px solid var(--fieldBorder); border-radius:var(--radius);
  background:var(--field); color:var(--text); font-family:inherit;
  font-size:16px; /* 16px prevents iOS auto-zoom */ line-height:1.4;
  transition:border-color .15s,box-shadow .15s;
  -webkit-appearance:none; appearance:none;
}
input::placeholder,textarea::placeholder { color:var(--muted); opacity:.6; }
input:focus,select:focus,textarea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(78,107,255,.18); }
select {
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' stroke-width='1.8' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:right 12px center; padding-right:36px; cursor:pointer;
}
/* LABELS */
label { display:block; font-weight:600; font-size:13px; color:var(--muted); margin:14px 0 5px; }
label:first-child { margin-top:4px; }
.required::after { content:" *"; color:var(--accent); }
/* BUTTONS — intentionally separate, width:auto by default */
.btn {
  display:inline-flex; align-items:center; justify-content:center;
  width:auto; border:none; border-radius:var(--radius);
  padding:11px 18px; font-family:inherit; font-size:14px; font-weight:700; line-height:1.2;
  cursor:pointer; min-height:44px; white-space:nowrap;
  transition:filter .15s,opacity .15s;
}
.btn.primary { background:linear-gradient(160deg,var(--accent),var(--accent2)); color:#fff; }
.btn.primary:hover { filter:brightness(1.08); }
.btn.secondary { background:#edf2ff; color:#0f172a; border:1px solid var(--border); }
[data-theme="dark"] .btn.secondary { background:#1e2a45; color:#e5e7eb; }
.btn-danger { background:var(--danger); color:#fff; }
.btn-ghost { background:transparent; border:1px solid var(--border); color:var(--muted); padding:6px 12px; min-height:36px; font-size:13px; }
/* COLLAPSIBLE */
.collapsible .head { display:flex; align-items:flex-start; justify-content:space-between; gap:8px; flex-wrap:wrap; }
.collapsible .head h2 { margin-bottom:0; flex:1 1 auto; }
.collapsible .tools { display:flex; gap:6px; flex-shrink:0; }
.collapsible .body { margin-top:14px; }
.collapsed .body { display:none; }
/* GRID ROWS */
.row   { display:grid; grid-template-columns:1fr 1fr;     gap:10px; }
.row-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
@media(max-width:560px){ .row,.row-3 { grid-template-columns:1fr; } }
/* BUTTON ROW */
.btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-top:16px; }
@media(max-width:440px){ .btn-row{flex-direction:column;} .btn-row .btn{width:100%;} }
/* NOTICE */
.notice { padding:12px 14px; border:1px dashed #f59e0b; border-radius:10px; background:rgba(245,158,11,.10); color:#92400e; font-size:14px; word-break:break-word; }
[data-theme="dark"] .notice { color:#fbbf24; }
.notice b { font-weight:800; }
/* UTILITY */
.hidden { display:none !important; }
/* TABLES */
.table-wrap { width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:var(--radius); }
table { min-width:620px; width:100%; border-collapse:separate; border-spacing:0; border:1px solid var(--fieldBorder); border-radius:10px; overflow:hidden; background:var(--field); }
th,td { padding:9px 11px; border-bottom:1px solid var(--fieldBorder); vertical-align:top; white-space:nowrap; font-size:13px; }
th { background:var(--tableHead); color:#0b1740; text-align:left; font-weight:700; }
[data-theme="dark"] th { color:#d9e3ff; }
tr:last-child td { border-bottom:0; }
.table-note { padding:14px 12px; color:var(--muted); white-space:normal; font-size:13px; }
/* LOG */
pre { background:#f7f9ff; color:#111827; border:1px solid var(--fieldBorder); border-radius:var(--radius); padding:12px; font-size:12px; max-height:38vh; overflow:auto; white-space:pre-wrap; word-break:break-word; width:100%; }
[data-theme="dark"] pre { background:#070e1f; color:#c7dbff; }
/* EXPORT BTN */
#exportBtn { white-space:normal; text-align:center; font-size:12px; padding:6px 10px; min-height:36px; line-height:1.3; max-width:140px; }
/* AI LIST */
.info-list { margin:8px 0 0 18px; padding:0; }
.info-list li { margin:4px 0; word-break:break-word; }
/* ANIMATION */
@keyframes slideRight { to { opacity:0; transform:translateX(60%); } }
.slideRight { animation:slideRight .35s ease forwards; }
/* COOKIE */
.cookie { position:fixed; left:50%; bottom:14px; transform:translateX(-50%); width:min(92vw,520px); background:rgba(255,255,255,.72); backdrop-filter:blur(14px) saturate(150%); border:1px solid var(--border); box-shadow:var(--shadow); border-radius:14px; padding:14px; display:flex; align-items:center; gap:12px; z-index:30; color:#0f172a; }
[data-theme="dark"] .cookie { background:rgba(11,16,32,.72); color:#e5e7eb; }
.cookie.hide { transition:transform .35s,opacity .35s; transform:translate(-50%,130%); opacity:0; }
.cookie .msg { flex:1; font-size:14px; word-break:break-word; }
.cookie .btn { width:auto; min-width:76px; min-height:38px; }
@media(max-width:380px){ .cookie{flex-direction:column;align-items:stretch;} .cookie .btn{width:100%;} }
</style>
</head>
<body>
<div class="topbar">
  <div class="topwrap">
    <div class="toprow1">
      <div class="brand">
        <img alt="Beeple" src="https://cdn.prod.website-files.com/64dc9a6f21257128d0afb983/65f86aca8cc32ec9836e8a29_beeple-textlogo.svg">
      </div>
      <!-- Navigate to the Team Planner page (projects/enrolments browser) -->
      <a href="planning.html" title="Team Planner — browse projects, teams &amp; enrolments"
         style="display:inline-flex;align-items:center;gap:6px;text-decoration:none;
                background:var(--accent);color:#fff;border-radius:8px;
                padding:7px 12px;font-size:13px;font-weight:700;line-height:1;
                transition:filter .15s;margin-right:4px;"
         onmouseover="this.style.filter='brightness(1.1)'"
         onmouseout="this.style.filter=''">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0;"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        Planner
      </a>
      <button id="themeBtn" class="theme-toggle">Dark mode</button>
    </div>
    <div class="page-title">Team wizard</div>
  </div>
</div>
<main class="container">
  <!-- Connection -->
  <section class="card collapsible" id="sec-conn">
    <div class="head">
      <h2>Connection</h2>
      <div class="tools">
        <button class="btn btn-ghost" data-toggle="#sec-conn" data-role="collapse">Collapse</button>
        <button class="btn btn-ghost hidden" data-toggle="#sec-conn">Expand</button>
      </div>
    </div>
    <div class="body">
      <label class="required">Tenant URL</label>
      <input id="baseUrl" type="url" inputmode="url" placeholder="https://acme.beepleapp.com" autocomplete="url">
      <label class="required">API token</label>
      <input id="token" type="password" autocomplete="current-password" placeholder="API token">
      <div class="btn-row">
        <button id="loadBtn" class="btn secondary">Load tenant data</button>
        <button id="forgetBtn" class="btn btn-danger">Forget saved data</button>
      </div>
    </div>
  </section>
  <!-- Notice -->
  <div class="notice"><b>Security notice:</b> do not share your API token with anyone</div>
  <!-- Create single team -->
  <section class="card collapsible" id="sec-single">
    <div class="head">
      <h2>Create single team</h2>
      <div class="tools">
        <button class="btn btn-ghost" data-toggle="#sec-single" data-role="collapse">Collapse</button>
        <button class="btn btn-ghost hidden" data-toggle="#sec-single">Expand</button>
      </div>
    </div>
    <div class="body">
      <div id="projectBlock" class="hidden">
        <label class="required">Project</label>
        <select id="projectSelect"></select>
      </div>
      <div id="subprojectBlock" class="hidden">
        <label class="required">Subproject</label>
        <select id="subprojectSelect"></select>
      </div>
      <div class="row">
        <div>
          <label>Auto-generate name</label>
          <select id="autoName"><option value="yes" selected>Yes</option><option value="no">No</option></select>
        </div>
        <div id="teamNameWrap" class="hidden">
          <label>Team name</label>
          <input id="teamName" placeholder="Team name">
        </div>
      </div>
      <div class="row">
        <div>
          <label class="required">Volunteers needed</label>
          <input id="volNeeded" type="number" inputmode="numeric" min="0" value="1">
        </div>
        <div id="functionBlock" class="hidden">
          <label class="required">Function</label>
          <select id="functionSelect"></select>
        </div>
      </div>
      <div id="addressBlock" class="hidden">
        <label class="required">Work location</label>
        <select id="addressSelect"></select>
      </div>
      <div class="row">
        <div>
          <label class="required">Shift start (local)</label>
          <input id="shiftStart" type="datetime-local">
        </div>
        <div>
          <label class="required">Shift end (local)</label>
          <input id="shiftEnd" type="datetime-local">
        </div>
      </div>
      <div class="row">
        <div>
          <label class="required">Draft mode</label>
          <select id="draftMode"><option value="yes" selected>Yes</option><option value="no">No</option></select>
        </div>
        <div id="compBlock" class="hidden">
          <label>Team compensation</label>
          <select id="compensationSelect"></select>
        </div>
      </div>
      <label>Max travel distance (km)</label>
      <input id="maxTravelKm" type="number" inputmode="numeric" min="0">
      <label>Extra practical info</label>
      <textarea id="extraInfo" rows="3" placeholder="extra info"></textarea>
      <!-- Advanced collapsed by default -->
      <div class="collapsible collapsed" id="sec-advanced">
        <div class="head" style="margin-top:16px;">
          <h2 style="font-size:15px;margin:0;">Advanced fields</h2>
          <div class="tools">
            <button class="btn btn-ghost" data-toggle="#sec-advanced">Expand</button>
            <button class="btn btn-ghost hidden" data-toggle="#sec-advanced" data-role="collapse">Collapse</button>
          </div>
        </div>
        <div class="body">
          <div class="row">
            <div><label>Relative check-in start (HH:MM)</label><input id="relCheckinStart" placeholder="00:30"></div>
            <div><label>Relative check-in duration (HH:MM)</label><input id="relCheckinDuration" placeholder="00:15"></div>
          </div>
          <div class="row">
            <div><label>Work location specification</label><input id="locationSpec" placeholder="At the entrance"></div>
            <div><label>Minimal age</label><input id="minimalAge" type="number" inputmode="numeric" min="0" placeholder="18"></div>
          </div>
          <label>Client experience required</label>
          <select id="clientExperience">
            <option value="">(not set)</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>
      <div class="btn-row">
        <button id="queueSingleBtn" class="btn primary">Add team to the queue to preview</button>
      </div>
    </div>
  </section>
  <!-- AI -->
  <section class="card collapsible" id="sec-ai">
    <div class="head">
      <h2>Create teams from text with AI</h2>
      <div class="tools">
        <button class="btn btn-ghost" data-toggle="#sec-ai" data-role="collapse">Collapse</button>
        <button class="btn btn-ghost hidden" data-toggle="#sec-ai">Expand</button>
      </div>
    </div>
    <div class="body">
      <label>Paste your text</label>
      <textarea id="aiText" rows="7" placeholder="Example:&#10;Generate 7 teams next week for Check-in at Antwerp Expo, 09:00-13:00 and 13:00-17:00, 3 volunteers each."></textarea>
      <div class="btn-row">
        <button id="aiQueueBtn" class="btn primary">Add team(s) to the queue to preview</button>
      </div>
    </div>
  </section>
  <!-- AI feedback -->
  <section class="card collapsible" id="sec-ai-feedback">
    <div class="head">
      <h2>AI notes &amp; questions</h2>
      <div class="tools">
        <button class="btn btn-ghost" data-toggle="#sec-ai-feedback" data-role="collapse">Collapse</button>
        <button class="btn btn-ghost hidden" data-toggle="#sec-ai-feedback">Expand</button>
      </div>
    </div>
    <div class="body">
      <b>Notes</b><ul id="aiNotes" class="info-list"></ul>
      <b style="display:block;margin-top:10px;">Questions</b><ul id="aiQuestions" class="info-list"></ul>
      <p class="sub">Answer questions by editing your prompt or filling missing fields before creating.</p>
    </div>
  </section>
  <!-- Queue -->
  <section class="card collapsible" id="sec-queue">
    <div class="head">
      <h2>Preview queue</h2>
      <div class="tools">
        <button id="exportBtn" class="btn btn-ghost" title="Download CSV">Export CSV</button>
        <button class="btn btn-ghost" data-toggle="#sec-queue" data-role="collapse">Collapse</button>
        <button class="btn btn-ghost hidden" data-toggle="#sec-queue">Expand</button>
      </div>
    </div>
    <div class="body">
      <div class="table-wrap">
        <table id="queueTable">
          <thead><tr><th>#</th><th>Project</th><th>Subproject</th><th>Name</th><th>Shift</th><th>Vol.</th><th>Function</th><th>Address</th><th>Comp.</th><th>Draft</th><th>Action</th></tr></thead>
          <tbody id="queueTbody">
            <tr id="queueEmptyRow"><td class="table-note" colspan="11">No items in the queue yet.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="btn-row">
        <button id="createQueueBtn" class="btn primary">Create team(s) from queue</button>
      </div>
      <div id="queueSuccess" class="sub" style="margin-top:8px;"></div>
    </div>
  </section>
  <!-- Created -->
  <section class="card collapsible" id="sec-created">
    <div class="head">
      <h2>Created teams</h2>
      <div class="tools">
        <button class="btn btn-ghost" data-toggle="#sec-created" data-role="collapse">Collapse</button>
        <button class="btn btn-ghost hidden" data-toggle="#sec-created">Expand</button>
      </div>
    </div>
    <div class="body">
      <div class="table-wrap">
        <table>
          <thead><tr><th>ID</th><th>Project</th><th>Subproject</th><th>Name</th><th>Function</th><th>Address</th><th>Comp.</th><th>Shift</th><th>Action</th></tr></thead>
          <tbody id="createdTbody"><tr><td class="table-note" colspan="9">Nothing created yet.</td></tr></tbody>
        </table>
      </div>
      <div id="createSuccessList" class="sub" style="margin-top:8px;"></div>
    </div>
  </section>
  <!-- Logs -->
  <section class="card collapsible" id="sec-logs">
    <div class="head">
      <h2>Logs</h2>
      <div class="tools">
        <button class="btn btn-ghost" data-toggle="#sec-logs" data-role="collapse">Collapse</button>
        <button class="btn btn-ghost hidden" data-toggle="#sec-logs">Expand</button>
      </div>
    </div>
    <div class="body"><pre id="log">Ready</pre></div>
  </section>
</main>
<div id="cookie" class="cookie hidden">
  <div class="msg">This site uses cookies to save your connection settings.</div>
  <div><button id="cookieOk" class="btn secondary">OK</button></div>
</div>
<script>
const PROXY_URL = "https://coraligo.com/team-wizard/proxy.php";
const DEBUG     = new URLSearchParams(location.search).get("debug") === "1";
const els = {
  themeBtn:document.getElementById("themeBtn"),
  baseUrl:document.getElementById("baseUrl"),token:document.getElementById("token"),
  loadBtn:document.getElementById("loadBtn"),forgetBtn:document.getElementById("forgetBtn"),
  projectBlock:document.getElementById("projectBlock"),subprojectBlock:document.getElementById("subprojectBlock"),
  functionBlock:document.getElementById("functionBlock"),addressBlock:document.getElementById("addressBlock"),
  compBlock:document.getElementById("compBlock"),
  projectSelect:document.getElementById("projectSelect"),subprojectSelect:document.getElementById("subprojectSelect"),
  functionSelect:document.getElementById("functionSelect"),addressSelect:document.getElementById("addressSelect"),
  compensationSelect:document.getElementById("compensationSelect"),
  autoName:document.getElementById("autoName"),teamNameWrap:document.getElementById("teamNameWrap"),
  teamName:document.getElementById("teamName"),volNeeded:document.getElementById("volNeeded"),
  shiftStart:document.getElementById("shiftStart"),shiftEnd:document.getElementById("shiftEnd"),
  draftMode:document.getElementById("draftMode"),maxTravelKm:document.getElementById("maxTravelKm"),
  extraInfo:document.getElementById("extraInfo"),
  relCheckinStart:document.getElementById("relCheckinStart"),relCheckinDuration:document.getElementById("relCheckinDuration"),
  locationSpec:document.getElementById("locationSpec"),minimalAge:document.getElementById("minimalAge"),
  clientExperience:document.getElementById("clientExperience"),
  queueSingleBtn:document.getElementById("queueSingleBtn"),
  aiText:document.getElementById("aiText"),aiQueueBtn:document.getElementById("aiQueueBtn"),
  aiNotes:document.getElementById("aiNotes"),aiQuestions:document.getElementById("aiQuestions"),
  queueTbody:document.getElementById("queueTbody"),queueEmptyRow:document.getElementById("queueEmptyRow"),
  createQueueBtn:document.getElementById("createQueueBtn"),queueSuccess:document.getElementById("queueSuccess"),
  exportBtn:document.getElementById("exportBtn"),
  createdTbody:document.getElementById("createdTbody"),createSuccessList:document.getElementById("createSuccessList"),
  log:document.getElementById("log"),cookie:document.getElementById("cookie"),cookieOk:document.getElementById("cookieOk"),
};
const L=(...a)=>{els.log.textContent+=a.join(" ")+"\n";els.log.scrollTop=els.log.scrollHeight;};
const addGap=()=>{els.log.textContent+="\n";};
const scrollLog=()=>document.getElementById("sec-logs").scrollIntoView({behavior:"smooth",block:"end"});
const originOf=u=>{try{return new URL(u).origin;}catch{return u;}};
const base=()=>originOf(els.baseUrl.value.trim());
const tokenVal=()=>els.token.value.trim();
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":'&#39;'}[m]));}
function extractErr(e){if(!e)return"Unknown error";if(typeof e==="string")return e;if(e.message)return e.message;try{return JSON.stringify(e);}catch{return String(e);}}
function setCookie(k,v,days=365){const exp=new Date(Date.now()+days*864e5).toUTCString();document.cookie=`${k}=${encodeURIComponent(v)};expires=${exp};path=/;SameSite=Lax`;}
function getCookie(k){return document.cookie.split("; ").reduce((r,v)=>{const[n,...rest]=v.split("=");return n===k?decodeURIComponent(rest.join("=")):r;},"");}
function delCookie(k){document.cookie=`${k}=;Max-Age=0;path=/;SameSite=Lax`;}
function tenantKey(){return(base()||getCookie("beeple_last_base")||"").replace(/^https?:\/\//,"").replace(/[^\w.-]/g,"_");}
const savePerTenant=(k,v)=>{const t=tenantKey();if(t)setCookie(`beeple_${t}_${k}`,v);};
const loadPerTenant=k=>{const t=tenantKey();return t?getCookie(`beeple_${t}_${k}`):""};
function syncThemeBtn(){els.themeBtn.textContent=document.documentElement.getAttribute("data-theme")==="dark"?"Light mode":"Dark mode";}
els.themeBtn.addEventListener("click",()=>{const n=document.documentElement.getAttribute("data-theme")==="dark"?"light":"dark";document.documentElement.setAttribute("data-theme",n);localStorage.setItem("theme",n);syncThemeBtn();});
function toggleSection(el,expand){
  if(!el)return;
  if(expand===undefined)expand=el.classList.contains("collapsed");
  const xBtn=el.querySelector('[data-toggle]:not([data-role="collapse"])');
  const cBtn=el.querySelector('[data-toggle][data-role="collapse"]');
  if(expand){el.classList.remove("collapsed");if(xBtn)xBtn.classList.add("hidden");if(cBtn)cBtn.classList.remove("hidden");}
  else{el.classList.add("collapsed");if(xBtn)xBtn.classList.remove("hidden");if(cBtn)cBtn.classList.add("hidden");}
}
function proxyUrl(path){return`${PROXY_URL}?base=${encodeURIComponent(base())}&path=${encodeURIComponent(path)}${DEBUG?"&debug=1":""}`;}
async function proxyGET(path){
  L("GET",path);
  const res=await fetch(proxyUrl(path),{headers:{"X-Beeple-Token":tokenVal()}});
  const txt=await res.text();L("<-",res.status);if(txt)L(txt.length>1500?txt.slice(0,1500)+"…":txt);addGap();
  if(!res.ok)throw new Error("HTTP "+res.status+" on GET "+path);
  try{return txt?JSON.parse(txt):{};}catch{return{raw:txt};}
}
async function proxyPOST(path,payload){
  const body=JSON.stringify(payload);L("POST",path);L("Body:",body.length>1500?body.slice(0,1500)+"…":body);
  const res=await fetch(proxyUrl(path),{method:"POST",headers:{"X-Beeple-Token":tokenVal(),"Content-Type":"application/json"},body});
  const txt=await res.text();L("<-",res.status);if(txt)L(txt.length>1500?txt.slice(0,1500)+"…":txt);addGap();
  if(!res.ok){let r="HTTP "+res.status;try{const j=JSON.parse(txt);if(j&&j.error)r=j.error;}catch{}throw new Error(r);}
  try{return txt?JSON.parse(txt):{};}catch{return{raw:txt};}
}
async function proxyDELETE(path){
  L("DELETE",path);
  const res=await fetch(proxyUrl(path),{method:"DELETE",headers:{"X-Beeple-Token":tokenVal()}});
  L("<-",res.status);addGap();if(!res.ok)throw new Error("HTTP "+res.status);return true;
}
const state={maps:{projects:{},subprojects:{},functions:{},addresses:{},compensations:{}},context:{projects:[],subprojects:[],functions:[],addresses:[],team_compensations:[]},queue:[],created:[]};
function fillSelect(sel,items){sel.innerHTML="";items.forEach(it=>{const o=document.createElement("option");o.value=String(it.value);o.textContent=it.label;sel.appendChild(o);});}
async function loadTenant(){
  if(!base()||!tokenVal()){alert("Fill Tenant URL and API token first.");return;}
  setCookie("beeple_last_base",base());savePerTenant("baseUrl",base());savePerTenant("token",tokenVal());
  ["projectBlock","subprojectBlock","functionBlock","addressBlock","compBlock"].forEach(id=>els[id].classList.add("hidden"));
  try{
    const pData=await proxyGET("api/v1/admin/projects");const projects=pData.projects||[];
    fillSelect(els.projectSelect,projects.map(p=>({value:p.id,label:p.name||"Project #"+p.id})));
    state.maps.projects=Object.fromEntries(projects.map(p=>[String(p.id),p.name||"Project #"+p.id]));
    state.context.projects=projects.map(p=>({id:String(p.id),name:p.name||"Project #"+p.id}));
    if(projects.length)els.projectBlock.classList.remove("hidden");
    const allSubs=[];
    for(const p of projects){try{const sData=await proxyGET(`api/v1/admin/projects/${p.id}/subprojects`);(sData.subprojects||[]).forEach(s=>allSubs.push({id:String(s.id),name:s.name||"Sub #"+s.id,project_id:String(p.id)}));}catch(e){L("Sub err project",p.id,":",extractErr(e));}}
    state.context.subprojects=allSubs;
    const fData=await proxyGET("api/v1/admin/functions");const fns=fData.functions||fData||[];
    fillSelect(els.functionSelect,fns.map(f=>({value:f.id,label:f.name||"Function #"+f.id})));
    state.maps.functions=Object.fromEntries(fns.map(f=>[String(f.id),f.name||"Function #"+f.id]));
    state.context.functions=fns.map(f=>({id:String(f.id),name:f.name||"Function #"+f.id}));
    if(fns.length)els.functionBlock.classList.remove("hidden");
    const aData=await proxyGET("api/v1/admin/addresses");const addrs=aData.addresses||[];
    const addrL=a=>a.name||[a.street,a.number,a.city].filter(Boolean).join(" ")||"Address #"+a.id;
    fillSelect(els.addressSelect,addrs.map(a=>({value:a.id,label:addrL(a)})));
    state.maps.addresses=Object.fromEntries(addrs.map(a=>[String(a.id),addrL(a)]));
    state.context.addresses=addrs.map(a=>({id:String(a.id),name:addrL(a)}));
    if(addrs.length)els.addressBlock.classList.remove("hidden");
    const cData=await proxyGET("api/v1/admin/team_compensations");const comps=cData.team_compensations||cData||[];
    const cOpts=[{value:"",label:"(none)"}].concat(comps.map(c=>({value:c.id,label:c.name||"Comp #"+c.id})));
    fillSelect(els.compensationSelect,cOpts);
    state.maps.compensations=Object.fromEntries(cOpts.map(o=>[String(o.value),o.label]));
    state.context.team_compensations=comps.map(c=>({id:String(c.id),name:c.name||"Comp #"+c.id}));
    els.compBlock.classList.remove("hidden");
    L(`Loaded — Projects:${state.context.projects.length} Subs:${state.context.subprojects.length} Fns:${state.context.functions.length} Addrs:${state.context.addresses.length}`);
  }catch(e){alert("Load failed: "+extractErr(e));}
}
async function loadSubprojectsForProject(pid){
  if(!pid){els.subprojectBlock.classList.add("hidden");return;}
  try{
    const sData=await proxyGET(`api/v1/admin/projects/${pid}/subprojects`);const subs=sData.subprojects||[];
    if(subs.length){fillSelect(els.subprojectSelect,subs.map(s=>({value:s.id,label:s.name||"Sub #"+s.id})));state.maps.subprojects=Object.fromEntries(subs.map(s=>[String(s.id),s.name||"Sub #"+s.id]));els.subprojectBlock.classList.remove("hidden");}
    else{els.subprojectBlock.classList.add("hidden");}
  }catch(e){L("Sub load error:",extractErr(e));addGap();els.subprojectBlock.classList.add("hidden");}
}
function currentFormRow(){
  const noSub=els.subprojectBlock.classList.contains("hidden");
  return{
    projectId:els.projectSelect.value||"",subprojectId:noSub?"":(els.subprojectSelect.value||""),
    projectName:state.maps.projects[els.projectSelect.value]||"",subprojectName:state.maps.subprojects[els.subprojectSelect.value]||"",
    autoName:els.autoName.value,name:els.teamName.value,volunteers:els.volNeeded.value,
    functionId:els.functionSelect.value||"",functionName:state.maps.functions[els.functionSelect.value]||"",
    addressId:els.addressSelect.value||"",addressName:state.maps.addresses[els.addressSelect.value]||"",
    compensationId:els.compensationSelect.value||"",compensationName:state.maps.compensations[els.compensationSelect.value]||"",
    draft:els.draftMode.value,start:els.shiftStart.value,end:els.shiftEnd.value,
    maxKm:els.maxTravelKm.value,extra:els.extraInfo.value,
    relStart:els.relCheckinStart.value,relDuration:els.relCheckinDuration.value,
    locSpec:els.locationSpec.value,minAge:els.minimalAge.value,clientExp:els.clientExperience.value
  };
}
function buildApiPayload(row){
  const team={
    auto_generate_name:row.autoName==="yes",name:row.autoName==="yes"?undefined:(row.name||undefined),
    volunteers_needed:row.volunteers?parseInt(row.volunteers,10):undefined,
    function_id:row.functionId||undefined,work_location_id:row.addressId||undefined,
    team_compensation_id:row.compensationId||undefined,published:row.draft!=="yes",
    extra_practical_info:row.extra||undefined,maximum_travel_distance:row.maxKm?Number(row.maxKm):undefined,
    relative_checkin_start:row.relStart||undefined,relative_checkin_duration:row.relDuration||undefined,
    work_location_specification:row.locSpec||undefined,minimal_age:row.minAge?Number(row.minAge):undefined,
    client_experience_required:row.clientExp===""?undefined:(row.clientExp==="true"),shifts_attributes:[]
  };
  if(row.start&&row.end){const s=new Date(row.start),e=new Date(row.end);team.shifts_attributes.push({start_datetime:isNaN(s)?row.start:s.toISOString(),end_datetime:isNaN(e)?row.end:e.toISOString()});}
  Object.keys(team).forEach(k=>team[k]===undefined&&delete team[k]);
  return{team};
}
function renderQueue(){
  els.queueTbody.innerHTML="";
  if(!state.queue.length){els.queueEmptyRow.classList.remove("hidden");els.queueTbody.appendChild(els.queueEmptyRow);return;}
  els.queueEmptyRow.classList.add("hidden");
  state.queue.forEach((q,i)=>{
    const shift=(q.start&&q.end)?`${q.start} — ${q.end}`:"";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${escapeHtml(q.projectName)}</td><td>${escapeHtml(q.subprojectName)}</td><td>${q.autoName==="yes"?"(auto)":escapeHtml(q.name)}</td><td>${escapeHtml(shift)}</td><td>${escapeHtml(q.volunteers)}</td><td>${escapeHtml(q.functionName)}</td><td>${escapeHtml(q.addressName)}</td><td>${escapeHtml(q.compensationName)}</td><td>${escapeHtml(q.draft)}</td><td><button class="btn btn-ghost" data-act="remove" data-idx="${i}">Remove</button></td>`;
    els.queueTbody.appendChild(tr);
  });
}
function renderCreated(){
  els.createdTbody.innerHTML="";
  if(!state.created.length){els.createdTbody.innerHTML=`<tr><td class="table-note" colspan="9">Nothing created yet.</td></tr>`;return;}
  state.created.forEach(item=>{
    const shift=(item.start&&item.end)?`${item.start} — ${item.end}`:"";
    const tr=document.createElement("tr");tr.setAttribute("data-id",item.id);
    tr.innerHTML=`<td>${escapeHtml(item.id)}</td><td>${escapeHtml(item.projectName)}</td><td>${escapeHtml(item.subprojectName)}</td><td>${escapeHtml(item.name)}</td><td>${escapeHtml(item.functionName)}</td><td>${escapeHtml(item.addressName)}</td><td>${escapeHtml(item.compensationName)}</td><td>${escapeHtml(shift)}</td><td><button class="btn btn-ghost" data-del="${escapeHtml(item.id)}">Delete</button></td>`;
    els.createdTbody.appendChild(tr);
  });
}
function renderAiFeedback(notes=[],questions=[]){
  els.aiNotes.innerHTML=notes.length?notes.map(n=>`<li>${escapeHtml(n)}</li>`).join(""):"<li>(none)</li>";
  els.aiQuestions.innerHTML=questions.length?questions.map(q=>`<li><b>${escapeHtml(q.field||"")}</b>: ${escapeHtml(q.message||"")}</li>`).join(""):"<li>(none)</li>";
}
function queueSingleFromForm(){if(!els.projectSelect.value){alert("Select a project first.");return;}state.queue.push(currentFormRow());renderQueue();}
async function createFromQueue(){
  if(!state.queue.length){alert("Queue is empty.");return;}
  const successes=[];
  for(const q of state.queue){
    try{
      const path=q.subprojectId?`api/v1/admin/subprojects/${encodeURIComponent(q.subprojectId)}/teams`:`api/v1/admin/projects/${encodeURIComponent(q.projectId)}/teams`;
      const res=await proxyPOST(path,buildApiPayload(q));const newId=(res&&res.team&&res.team.id)||(res&&res.id)||"?";
      successes.push("Created team "+newId);
      state.created.push({id:newId,projectName:q.projectName,subprojectName:q.subprojectName,name:q.autoName==="yes"?"(auto)":(q.name||"(auto)"),functionName:q.functionName,addressName:q.addressName,compensationName:q.compensationName,start:q.start,end:q.end});
      renderCreated();
    }catch(e){alert("Create failed: "+extractErr(e));}
  }
  state.queue=[];renderQueue();els.queueSuccess.innerHTML=successes.map(s=>"• "+s).join("<br>");
}
async function addAiToQueue(){
  const text=(els.aiText.value||"").trim();if(!text){alert("Paste some text first.");return;}
  try{
    const tz=Intl.DateTimeFormat().resolvedOptions().timeZone||"Europe/Brussels";
    const body=JSON.stringify({text,timezone:tz,tenant_context:state.context});
    L("AI -> proxy.php?ai=1");
    const res=await fetch(`${PROXY_URL}?ai=1${DEBUG?"&debug=1":""}`,{method:"POST",headers:{"Content-Type":"application/json"},body});
    const txt=await res.text();let json={};try{json=JSON.parse(txt||"{}");}catch{}
    if(!res.ok)throw new Error(json.error||txt||"HTTP "+res.status);
    const teams=Array.isArray(json.teams)?json.teams:[];
    const notes=Array.isArray(json.notes)?json.notes:[];
    const questions=Array.isArray(json.questions)?json.questions:[];
    teams.forEach(t=>{
      const team=t.team||t;const r=currentFormRow();
      const pid=t._project_id?String(t._project_id):r.projectId;
      const sid=t._subproject_id?String(t._subproject_id):r.subprojectId;
      if(pid){r.projectId=pid;r.projectName=state.maps.projects[pid]||r.projectName;}
      if(sid){r.subprojectId=sid;r.subprojectName=state.maps.subprojects[sid]||r.subprojectName;}
      r.autoName=team.auto_generate_name?"yes":"no";r.name=team.name||r.name;r.volunteers=team.volunteers_needed??r.volunteers;
      if(team.function_id){r.functionId=String(team.function_id);r.functionName=state.maps.functions[r.functionId]||"";}
      if(team.work_location_id){r.addressId=String(team.work_location_id);r.addressName=state.maps.addresses[r.addressId]||"";}
      if(team.team_compensation_id!=null){r.compensationId=String(team.team_compensation_id||"");r.compensationName=state.maps.compensations[r.compensationId]||"";}
      r.draft=team.published===false?"yes":"no";
      if(Array.isArray(team.shifts_attributes)&&team.shifts_attributes.length){r.start=team.shifts_attributes[0].start_datetime||r.start;r.end=team.shifts_attributes[0].end_datetime||r.end;}
      r.maxKm=team.maximum_travel_distance??r.maxKm;r.extra=team.extra_practical_info||r.extra;
      r.relStart=team.relative_checkin_start||r.relStart;r.relDuration=team.relative_checkin_duration||r.relDuration;
      r.locSpec=team.work_location_specification||r.locSpec;r.minAge=team.minimal_age??r.minAge;
      if(typeof team.client_experience_required!=="undefined")r.clientExp=String(!!team.client_experience_required);
      state.queue.push(r);
    });
    renderQueue();renderAiFeedback(notes,questions);
    L(`AI: ${teams.length} team(s). Notes:${notes.length} Q:${questions.length}`);addGap();
    if(questions.length)alert("AI has follow-up questions — see 'AI notes & questions'.");
  }catch(e){alert("AI failed: "+extractErr(e));L("AI error:",extractErr(e));addGap();scrollLog();}
}
async function deleteCreated(id){
  const btn=document.querySelector(`[data-del="${id}"]`);if(btn){btn.textContent="…";btn.disabled=true;}
  try{
    await proxyDELETE(`api/v1/admin/teams/${encodeURIComponent(id)}`);
    const row=document.querySelector(`tr[data-id="${id}"]`);
    if(row){row.classList.add("slideRight");setTimeout(()=>row.remove(),360);}
    state.created=state.created.filter(x=>String(x.id)!==String(id));
    if(!state.created.length)renderCreated();
  }catch(e){if(btn){btn.textContent="Delete";btn.disabled=false;}alert("Delete failed: "+extractErr(e));}
}
function exportQueueCSV(){
  if(!state.queue.length){alert("Queue is empty.");return;}
  const hdr=["project_id","project_name","subproject_id","subproject_name","auto_name","team_name","volunteers","function_id","function_name","address_id","address_name","compensation_id","compensation_name","draft","start","end","max_km","extra","checkin_start","checkin_duration","location_spec","min_age","client_experience"];
  const qc=v=>{const s=v==null?"":String(v);return/[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`  :s;};
  const rows=state.queue.map(q=>[q.projectId,q.projectName,q.subprojectId,q.subprojectName,q.autoName,q.name,q.volunteers,q.functionId,q.functionName,q.addressId,q.addressName,q.compensationId,q.compensationName,q.draft,q.start,q.end,q.maxKm,q.extra,q.relStart||"",q.relDuration||"",q.locSpec||"",q.minAge||"",q.clientExp||""].map(qc).join(","));
  const csv=[hdr.join(","),...rows].join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});const url=URL.createObjectURL(blob);
  const a=Object.assign(document.createElement("a"),{href:url,download:"beeple-queue.csv"});
  document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),1000);
}
document.addEventListener("click",ev=>{
  const t=ev.target.closest("button")||ev.target;
  if(t.dataset.toggle){toggleSection(document.querySelector(t.dataset.toggle),t.dataset.role!=="collapse");return;}
  if(t.id==="createQueueBtn"){createFromQueue();return;}
  if(t.id==="queueSingleBtn"){queueSingleFromForm();return;}
  if(t.id==="aiQueueBtn"){addAiToQueue();return;}
  if(t.id==="exportBtn"){exportQueueCSV();return;}
  if(t.dataset.act==="remove"){state.queue.splice(parseInt(t.dataset.idx,10),1);renderQueue();return;}
  if(t.dataset.del){deleteCreated(t.dataset.del);return;}
});
els.loadBtn.addEventListener("click",e=>{e.preventDefault();loadTenant();});
els.forgetBtn.addEventListener("click",e=>{
  e.preventDefault();const tk=tenantKey();
  document.cookie.split("; ").forEach(c=>{const n=c.split("=")[0];if(n.startsWith(`beeple_${tk}_`))delCookie(n);});
  alert("Saved data cleared for this tenant.");
});
els.projectSelect.addEventListener("change",async()=>{savePerTenant("project",els.projectSelect.value);await loadSubprojectsForProject(els.projectSelect.value);});
els.subprojectSelect.addEventListener("change",()=>savePerTenant("subproject",els.subprojectSelect.value));
els.functionSelect.addEventListener("change",()=>savePerTenant("function",els.functionSelect.value));
els.addressSelect.addEventListener("change",()=>savePerTenant("address",els.addressSelect.value));
els.compensationSelect.addEventListener("change",()=>savePerTenant("comp",els.compensationSelect.value));
els.autoName.addEventListener("change",()=>els.teamNameWrap.classList.toggle("hidden",els.autoName.value==="yes"));
els.baseUrl.addEventListener("change",()=>{setCookie("beeple_last_base",base());savePerTenant("baseUrl",base());});
els.token.addEventListener("change",()=>savePerTenant("token",tokenVal()));
els.aiText.addEventListener("input",()=>savePerTenant("aiText",els.aiText.value));
(function init(){
  const savedTheme=localStorage.getItem("theme")||"light";
  document.documentElement.setAttribute("data-theme",savedTheme);syncThemeBtn();
  const pad=n=>String(n).padStart(2,"0");
  const fmt=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  const now=new Date();
  const s=new Date(now);s.setDate(s.getDate()+1);s.setHours(8,0,0,0);
  const e=new Date(now);e.setDate(e.getDate()+1);e.setHours(17,0,0,0);
  els.shiftStart.value=fmt(s);els.shiftEnd.value=fmt(e);
  if(!getCookie("beeple_cookie_ok"))els.cookie.classList.remove("hidden");
  els.cookieOk.addEventListener("click",()=>{setCookie("beeple_cookie_ok","1");els.cookie.classList.add("hide");setTimeout(()=>els.cookie.classList.add("hidden"),380);});
  const lb=getCookie("beeple_last_base");if(lb)els.baseUrl.value=lb;
  const sb=loadPerTenant("baseUrl");if(sb)els.baseUrl.value=sb;
  const st=loadPerTenant("token");if(st)els.token.value=st;
  const sa=loadPerTenant("aiText");if(sa)els.aiText.value=sa;
  els.teamNameWrap.classList.toggle("hidden",els.autoName.value==="yes");
  ["sec-conn","sec-single","sec-ai","sec-ai-feedback","sec-queue"].forEach(id=>toggleSection(document.getElementById(id),true));
  if(DEBUG)L("Debug ON.");
})();
</script>
</body>
</html>