<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Team Wizard — Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="icon" href="icon.svg">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4e6bff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icon.svg">
<style>
:root {
  --bg:#f0f4ff; --bg2:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#475569;
  --accent:#4e6bff; --accent2:#7da2ff; --accentSoft:#e9efff; --danger:#ef6b6b;
  --success:#22c55e; --successSoft:#dcfce7;
  --border:rgba(15,23,42,.10); --field:#ffffff; --fieldBorder:#e5e7eb;
  --radius:10px; --radius-lg:14px;
  --shadow:0 4px 20px rgba(15,23,42,.08),0 1px 0 rgba(15,23,42,.04);
}
[data-theme="dark"] {
  --bg:#0b1020; --bg2:#0e1428; --card:#0f1630; --text:#e8ecff; --muted:#b8c3ef;
  --accent:#5aa2ff; --accent2:#7ec3ff; --accentSoft:#0e2244; --danger:#e66d6d;
  --success:#4ade80; --successSoft:#052e16;
  --border:rgba(255,255,255,.14); --field:#121b39; --fieldBorder:rgba(255,255,255,.18);
  --shadow:0 8px 28px rgba(0,0,0,.35),0 1px 0 rgba(255,255,255,.04);
}
*,*::before,*::after { box-sizing:border-box; max-width:100%; }
html { overflow-x:clip; }
body {
  margin:0; overflow-x:clip;
  background:var(--bg);
  color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  font-size:15px; line-height:1.55;
  min-height:100vh;
  -webkit-text-size-adjust:100%; text-size-adjust:100%;
}
/* TOP BAR */
.topbar {
  position:sticky; top:0; z-index:30;
  background:var(--card); border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px;
  padding:10px 16px;
}
.topbar .brand img { height:22px; width:auto; display:block; }
.topbar .title { font-weight:800; font-size:clamp(15px,3vw,20px); flex:1; text-align:center; }
.icon-btn {
  width:40px; height:40px; border-radius:10px; border:1px solid var(--border);
  background:var(--accentSoft); cursor:pointer; display:flex; align-items:center;
  justify-content:center; flex-shrink:0; color:var(--accent); font-size:18px;
}
[data-theme="dark"] .icon-btn { color:var(--accent2); }
.icon-btn svg { width:20px; height:20px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
/* CONTAINER */
.container {
  width:100%; max-width:480px; margin:40px auto; padding:0 16px 60px;
}
/* CARD */
.card {
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg);
  padding:24px; box-shadow:var(--shadow); overflow:hidden;
}
.card h2 { margin:0 0 4px; font-size:20px; }
.card-sub { color:var(--muted); font-size:13px; margin:0 0 20px; }
/* FORM */
input, select {
  display:block; width:100%; padding:11px 12px;
  border:1px solid var(--fieldBorder); border-radius:var(--radius);
  background:var(--field); color:var(--text); font-family:inherit;
  font-size:16px; line-height:1.4;
  transition:border-color .15s,box-shadow .15s;
  -webkit-appearance:none; appearance:none;
}
input::placeholder { color:var(--muted); opacity:.6; }
input:focus, select:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(78,107,255,.18); }
label { display:block; font-weight:600; font-size:13px; color:var(--muted); margin:14px 0 5px; }
label:first-child { margin-top:0; }
.required::after { content:" *"; color:var(--accent); }
/* BUTTONS */
.btn {
  display:inline-flex; align-items:center; justify-content:center;
  width:100%; border:none; border-radius:var(--radius);
  padding:12px 18px; font-family:inherit; font-size:15px; font-weight:700; line-height:1.2;
  cursor:pointer; min-height:46px; white-space:nowrap;
  transition:filter .15s,opacity .15s;
}
.btn.primary { background:linear-gradient(160deg,var(--accent),var(--accent2)); color:#fff; }
.btn.primary:hover { filter:brightness(1.08); }
.btn.secondary { background:#edf2ff; color:#0f172a; border:1px solid var(--border); }
[data-theme="dark"] .btn.secondary { background:#1e2a45; color:#e5e7eb; }
.btn:disabled { opacity:.6; cursor:default; }
/* LOGIN TABS */
.login-tabs {
  display:flex; gap:0; border:1px solid var(--border); border-radius:var(--radius);
  overflow:hidden; margin:20px 0 0;
}
.login-tab {
  flex:1; padding:10px; font-family:inherit; font-size:14px; font-weight:600;
  border:none; cursor:pointer; background:transparent; color:var(--muted);
  transition:background .15s,color .15s;
}
.login-tab.active { background:var(--accentSoft); color:var(--accent); }
[data-theme="dark"] .login-tab.active { color:var(--accent2); }
/* FORMS */
.login-form { margin-top:16px; }
.hidden { display:none !important; }
/* DIVIDER */
.divider {
  display:flex; align-items:center; gap:10px; margin:16px 0 0;
  color:var(--muted); font-size:13px;
}
.divider::before,.divider::after { content:""; flex:1; height:1px; background:var(--border); }
/* ALERT */
.alert {
  padding:12px 14px; border-radius:var(--radius); font-size:14px;
  margin-top:14px; word-break:break-word;
}
.alert-error { background:#fee2e2; border:1px solid #fca5a5; color:#991b1b; }
[data-theme="dark"] .alert-error { color:#fca5a5; }
/* BTN ROW */
.btn-row { margin-top:16px; }
</style>
</head>
<body>

<div class="topbar">
  <div style="width:40px;"></div>
  <div class="brand" style="flex:0;"><img alt="Beeple" src="https://cdn.prod.website-files.com/64dc9a6f21257128d0afb983/65f86aca8cc32ec9836e8a29_beeple-textlogo.svg"></div>
  <div class="title">Team Wizard</div>
  <button class="icon-btn" id="themeBtn" title="Toggle dark/light mode">
    <svg id="themeIcon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
  </button>
</div>

<div class="container">
  <div class="card">
    <h2>Connect to Beeple</h2>
    <p class="card-sub">Enter your tenant URL to get started.</p>

    <label class="required">Tenant URL</label>
    <input id="baseUrl" type="url" inputmode="url" placeholder="https://acme.beepleapp.com"
           autocomplete="url">

    <!-- Tab selector -->
    <div class="login-tabs">
      <button class="login-tab active" data-tab="password" type="button">Email &amp; password</button>
      <button class="login-tab" data-tab="token" type="button">API token</button>
    </div>

    <!-- EMAIL + PASSWORD FORM -->
    <form id="formPassword" class="login-form" autocomplete="on" novalidate>
      <label class="required">Email</label>
      <input id="email" type="email" name="email" autocomplete="email" placeholder="you@example.com">
      <label class="required">Password</label>
      <input id="password" type="password" name="password" autocomplete="current-password" placeholder="Password">
      <div class="btn-row">
        <button id="loginBtn" type="submit" class="btn primary">Log in</button>
      </div>
    </form>

    <!-- API TOKEN FORM -->
    <form id="formToken" class="login-form hidden" autocomplete="on" novalidate>
      <label class="required">API token</label>
      <!-- name="username" on URL makes browser pair URL+token as saved credential -->
      <input id="tokenUrlHint" type="text" name="username" autocomplete="username"
             style="display:none;" aria-hidden="true">
      <input id="tokenInput" type="password" name="password" autocomplete="current-password"
             placeholder="Paste your API token here">
      <div class="btn-row">
        <button id="tokenLoginBtn" type="submit" class="btn primary">Connect</button>
      </div>
    </form>

    <div id="loginError" class="alert alert-error hidden"></div>
  </div>
</div>

<script>
const PROXY_URL = "https://coraligo.com/team-wizard/proxy.php";

/* Theme */
function syncTheme(){
  const dark = document.documentElement.getAttribute("data-theme") === "dark";
  document.getElementById("themeIcon").innerHTML = dark
    ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>'
    : '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
}
document.getElementById("themeBtn").addEventListener("click", () => {
  const next = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem("theme", next);
  syncTheme();
});

/* Tab switching */
document.querySelectorAll(".login-tab").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".login-tab").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    document.getElementById("formPassword").classList.toggle("hidden", tab !== "password");
    document.getElementById("formToken").classList.toggle("hidden", tab !== "token");
    clearError();
  });
});

function clearError(){ document.getElementById("loginError").classList.add("hidden"); }
function showError(msg){ const el=document.getElementById("loginError"); el.textContent=msg; el.classList.remove("hidden"); }

function originOf(u){ try{ return new URL(u).origin; }catch{ return u; } }

function getBase(){
  return originOf(document.getElementById("baseUrl").value.trim());
}

/* Keep baseUrl synced from localStorage */
function loadSavedBase(){
  const saved = localStorage.getItem("bwBase") || "";
  if(saved) document.getElementById("baseUrl").value = saved;
  document.getElementById("tokenUrlHint").value = saved;
}

document.getElementById("baseUrl").addEventListener("input", () => {
  document.getElementById("tokenUrlHint").value = document.getElementById("baseUrl").value.trim();
});

function saveAndGo(token){
  const base = getBase();
  if(!base){ showError("Please enter the tenant URL."); return false; }
  localStorage.setItem("bwBase", base);
  sessionStorage.setItem("bwToken", token);
  window.location.href = "create.html";
  return true;
}

/* Login with email + password (deprecated Beeple API) */
document.getElementById("formPassword").addEventListener("submit", async e => {
  e.preventDefault();
  const base     = getBase();
  const email    = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  if(!base)    { showError("Please enter the tenant URL."); return; }
  if(!email)   { showError("Please enter your email."); return; }
  if(!password){ showError("Please enter your password."); return; }

  const btn = document.getElementById("loginBtn");
  btn.disabled = true; btn.textContent = "Logging in…";
  clearError();

  try {
    const url = `${PROXY_URL}?base=${encodeURIComponent(base)}&path=${encodeURIComponent("api/v1/admin/login")}`;
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user: { email, password } })
    });
    const txt = await res.text();
    let json = {};
    try { json = JSON.parse(txt); } catch {}

    if(!res.ok){
      const msg = (json && (json.error || json.message)) || ("Login failed (HTTP " + res.status + ")");
      throw new Error(msg);
    }

    const token = json.api_token
      || json.token
      || (json.user && (json.user.api_token || json.user.token))
      || (json.data && json.data.api_token)
      || null;

    if(!token) throw new Error("Login succeeded but no API token found in response. Try logging in with an API token instead.");
    saveAndGo(token);
  } catch(err){
    showError(err.message);
  } finally {
    btn.disabled = false; btn.textContent = "Log in";
  }
});

/* Login with API token */
document.getElementById("formToken").addEventListener("submit", e => {
  e.preventDefault();
  const token = document.getElementById("tokenInput").value.trim();
  if(!token){ showError("Please enter your API token."); return; }
  clearError();
  saveAndGo(token);
});

/* Init */
(function init(){
  /* Redirect if already logged in */
  if(sessionStorage.getItem("bwToken") && localStorage.getItem("bwBase")){
    window.location.href = "create.html";
    return;
  }
  const t = localStorage.getItem("theme") || "light";
  document.documentElement.setAttribute("data-theme", t);
  syncTheme();
  loadSavedBase();
})();
</script>
</body>
</html>
