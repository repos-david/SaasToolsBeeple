<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Team Wizard — Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="icon" href="https://cdn.prod.website-files.com/64dc9a6f21257128d0afb983/6601688c81ef6ab1df9e63ad_favicon-beeple.png">
<style>
:root {
  --bg:#f0f4ff; --bg2:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#475569;
  --accent:#4e6bff; --accent2:#7da2ff; --accentSoft:#e9efff; --danger:#ef6b6b;
  --success:#22c55e; --successSoft:#dcfce7;
  --border:rgba(15,23,42,.10); --field:#ffffff; --fieldBorder:#e5e7eb;
  --radius:10px; --radius-lg:14px;
  --shadow:0 4px 20px rgba(15,23,42,.08),0 1px 0 rgba(15,23,42,.04);
}
[data-theme="dark"] {
  --bg:#0b1020; --bg2:#0e1428; --card:#0f1630; --text:#e8ecff; --muted:#b8c3ef;
  --accent:#5aa2ff; --accent2:#7ec3ff; --accentSoft:#0e2244; --danger:#e66d6d;
  --success:#4ade80; --successSoft:#052e16;
  --border:rgba(255,255,255,.14); --field:#121b39; --fieldBorder:rgba(255,255,255,.18);
  --shadow:0 8px 28px rgba(0,0,0,.35),0 1px 0 rgba(255,255,255,.04);
}
*,*::before,*::after { box-sizing:border-box; max-width:100%; }
html { overflow-x:clip; }
body {
  margin:0; overflow-x:clip;
  background:var(--bg);
  color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  font-size:15px; line-height:1.55;
  -webkit-text-size-adjust:100%; text-size-adjust:100%;
}
/* TOP BAR */
.topbar {
  position:sticky; top:0; z-index:30;
  background:var(--card); border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px;
  padding:10px 16px;
}
.topbar .brand img { height:22px; width:auto; display:block; }
.topbar .title { font-weight:800; font-size:clamp(15px,3vw,20px); flex:1; text-align:center; }
.icon-btn {
  width:40px; height:40px; border-radius:10px; border:1px solid var(--border);
  background:var(--accentSoft); cursor:pointer; display:flex; align-items:center;
  justify-content:center; flex-shrink:0; color:var(--accent);
}
[data-theme="dark"] .icon-btn { color:var(--accent2); }
.icon-btn svg { width:20px; height:20px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
/* NAV MENU */
.nav-menu {
  position:fixed; top:55px; left:0; z-index:25;
  background:var(--card); border:1px solid var(--border);
  border-radius:0 0 var(--radius-lg) 0;
  box-shadow:var(--shadow);
  min-width:210px;
  transform:translateX(-110%);
  transition:transform .25s ease;
}
.nav-menu.open { transform:translateX(0); }
.nav-item {
  display:block; padding:14px 20px; font-weight:600; font-size:15px;
  color:var(--text); text-decoration:none; cursor:pointer;
  border-bottom:1px solid var(--border);
}
.nav-item:hover { background:var(--accentSoft); }
.nav-item.active { color:var(--accent); background:var(--accentSoft); }
button.nav-item {
  width:100%; text-align:left; background:none; border:none;
  border-bottom:1px solid var(--border);
  font-family:inherit; font-size:15px; font-weight:600; padding:14px 20px;
  color:var(--text); cursor:pointer;
}
button.nav-item:hover { background:var(--accentSoft); }
button.nav-item.danger { color:var(--danger); }
.nav-overlay {
  display:none; position:fixed; inset:0; z-index:24; background:rgba(0,0,0,.3);
}
.nav-overlay.show { display:block; }
/* MAIN / LOGIN */
.login-wrap {
  min-height:calc(100vh - 55px);
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  padding:28px 16px;
}
.login-card {
  width:min(100%, 440px);
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--radius-lg); padding:28px 24px;
  box-shadow:var(--shadow);
}
.login-logo { text-align:center; margin-bottom:24px; }
.login-logo img { height:28px; width:auto; }
/* TABS */
.tabs { display:flex; gap:4px; border-bottom:2px solid var(--border); margin-bottom:20px; }
.tab {
  padding:8px 16px; font-size:14px; font-weight:600; cursor:pointer;
  border-radius:8px 8px 0 0; border:none; background:transparent; color:var(--muted);
  font-family:inherit; transition:color .15s;
}
.tab.active { color:var(--accent); background:var(--accentSoft); }
.tab-pane { display:none; }
.tab-pane.active { display:block; }
/* FORM */
label { display:block; font-weight:600; font-size:13px; color:var(--muted); margin:14px 0 5px; }
label:first-child { margin-top:0; }
input, select {
  display:block; width:100%; padding:11px 12px;
  border:1px solid var(--fieldBorder); border-radius:var(--radius);
  background:var(--field); color:var(--text); font-family:inherit;
  font-size:16px; line-height:1.4;
  transition:border-color .15s,box-shadow .15s;
  -webkit-appearance:none; appearance:none;
}
input::placeholder { color:var(--muted); opacity:.6; }
input:focus, select:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(78,107,255,.18); }
/* BUTTONS */
.btn {
  display:inline-flex; align-items:center; justify-content:center;
  width:auto; border:none; border-radius:var(--radius);
  padding:11px 18px; font-family:inherit; font-size:14px; font-weight:700; line-height:1.2;
  cursor:pointer; min-height:44px; white-space:nowrap;
  transition:filter .15s,opacity .15s;
}
.btn.primary { background:linear-gradient(160deg,var(--accent),var(--accent2)); color:#fff; }
.btn.primary:hover { filter:brightness(1.08); }
.btn.full { width:100%; margin-top:16px; }
/* ALERTS */
.alert { padding:12px 14px; border-radius:var(--radius); font-size:14px; margin-top:12px; word-break:break-word; }
.alert-error   { background:#fee2e2; border:1px solid #fca5a5; color:#991b1b; }
.alert-success { background:var(--successSoft); border:1px solid #86efac; color:#166534; }
[data-theme="dark"] .alert-error   { color:#fca5a5; }
[data-theme="dark"] .alert-success { color:#86efac; }
.hidden { display:none !important; }
/* DIVIDER */
.or-divider { display:flex; align-items:center; gap:10px; margin:24px 0; color:var(--muted); font-size:13px; }
.or-divider::before, .or-divider::after { content:""; flex:1; height:1px; background:var(--fieldBorder); }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <button class="icon-btn" id="hamburgerBtn" aria-label="Menu">
    <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
  <div class="brand">
    <img alt="Beeple" src="https://cdn.prod.website-files.com/64dc9a6f21257128d0afb983/65f86aca8cc32ec9836e8a29_beeple-textlogo.svg">
  </div>
  <div class="title">Team Wizard</div>
  <!-- spacer to balance hamburger -->
  <div style="width:40px;flex-shrink:0;"></div>
</div>

<!-- NAV MENU -->
<nav id="navMenu" class="nav-menu" aria-label="Main navigation">
  <a href="create.html" class="nav-item">Team creation</a>
  <a href="planning.html" class="nav-item">Planning</a>
  <button id="logoutBtn" class="nav-item danger">Log out</button>
  <button id="themeBtn" class="nav-item">Dark mode</button>
</nav>
<div id="navOverlay" class="nav-overlay"></div>

<!-- LOGIN PAGE -->
<main class="login-wrap">
  <div class="login-card">
    <div class="login-logo">
      <img alt="Beeple" src="https://cdn.prod.website-files.com/64dc9a6f21257128d0afb983/65f86aca8cc32ec9836e8a29_beeple-textlogo.svg">
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="password">Email &amp; password</button>
      <button class="tab" data-tab="token">API token</button>
    </div>

    <!-- EMAIL + PASSWORD (deprecated Beeple sessions API) -->
    <div class="tab-pane active" id="tab-password">
      <form id="formPassword" autocomplete="on" onsubmit="return false;">
        <label for="pwBase">Tenant URL</label>
        <input id="pwBase" type="url" name="url" autocomplete="url"
               inputmode="url" placeholder="https://acme.beepleapp.com">

        <label for="pwEmail">Email</label>
        <input id="pwEmail" type="email" name="username" autocomplete="username"
               inputmode="email" placeholder="you@example.com">

        <label for="pwPassword">Password</label>
        <input id="pwPassword" type="password" name="password" autocomplete="current-password"
               placeholder="Password">

        <button id="loginPwBtn" class="btn primary full" type="submit">Log in</button>
        <div id="pwMsg"></div>
      </form>
    </div>

    <!-- API TOKEN -->
    <div class="tab-pane" id="tab-token">
      <form id="formToken" autocomplete="on" onsubmit="return false;">
        <label for="tkBase">Tenant URL</label>
        <input id="tkBase" type="url" name="username" autocomplete="username"
               inputmode="url" placeholder="https://acme.beepleapp.com">

        <label for="tkToken">API token</label>
        <input id="tkToken" type="password" name="password" autocomplete="current-password"
               placeholder="API token">

        <button id="loginTokenBtn" class="btn primary full" type="submit">Connect</button>
        <div id="tkMsg"></div>
      </form>
    </div>
  </div>
</main>

<script>
const PROXY_URL = "https://coraligo.com/team-wizard/proxy.php";
const debugParam = new URLSearchParams(location.search).get("debug");
const DEBUG = debugParam === "1" || debugParam === "Y" || debugParam === "y";

function originOf(u){ try{ return new URL(u).origin; }catch{ return u; } }

/* ---- Storage helpers ---- */
function saveBase(v){ if(v) localStorage.setItem("bwBase", v); }
function loadBase(){ return localStorage.getItem("bwBase") || ""; }
function saveToken(v){ if(v) sessionStorage.setItem("bwToken", v); }
function loadToken(){ return sessionStorage.getItem("bwToken") || ""; }

/* ---- If already logged in, go straight to create page ---- */
if(loadToken() && loadBase()){
  window.location.replace("create.html");
}

/* ---- Theme ---- */
(function(){
  const t = localStorage.getItem("theme") || "light";
  document.documentElement.setAttribute("data-theme", t);
  syncThemeBtn();
})();
function syncThemeBtn(){
  const dark = document.documentElement.getAttribute("data-theme") === "dark";
  document.getElementById("themeBtn").textContent = dark ? "Light mode" : "Dark mode";
}
document.getElementById("themeBtn").addEventListener("click", () => {
  const next = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem("theme", next);
  syncThemeBtn();
});

/* ---- Hamburger nav menu ---- */
const navMenu    = document.getElementById("navMenu");
const navOverlay = document.getElementById("navOverlay");
document.getElementById("hamburgerBtn").addEventListener("click", () => {
  navMenu.classList.toggle("open");
  navOverlay.classList.toggle("show");
});
navOverlay.addEventListener("click", () => {
  navMenu.classList.remove("open");
  navOverlay.classList.remove("show");
});
document.getElementById("logoutBtn").addEventListener("click", () => {
  sessionStorage.removeItem("bwToken");
  navMenu.classList.remove("open");
  navOverlay.classList.remove("show");
});

/* ---- Tab switching ---- */
document.querySelectorAll(".tab").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-pane").forEach(p => p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("tab-" + btn.dataset.tab).classList.add("active");
  });
});

/* ---- Pre-fill base URL from localStorage ---- */
const storedBase = loadBase();
if(storedBase){
  document.getElementById("pwBase").value  = storedBase;
  document.getElementById("tkBase").value  = storedBase;
}

/* ---- Helper: show message ---- */
function showMsg(elId, type, html){
  const el = document.getElementById(elId);
  el.innerHTML = `<div class="alert alert-${type}">${html}</div>`;
}

/* ---- Helper: extract token from API response ---- */
function extractToken(json){
  return json.token || json.auth_token || json.access_token || json.api_token ||
         (json.user && json.user.token) || (json.data && json.data.token) || null;
}

/* ---- Login with email + password (deprecated Beeple sessions API) ---- */
document.getElementById("loginPwBtn").addEventListener("click", async () => {
  const baseRaw = document.getElementById("pwBase").value.trim();
  const email   = document.getElementById("pwEmail").value.trim();
  const pass    = document.getElementById("pwPassword").value;

  if(!baseRaw || !email || !pass){
    showMsg("pwMsg","error","Please fill in all fields.");
    return;
  }
  const base = originOf(baseRaw);
  const btn  = document.getElementById("loginPwBtn");
  btn.disabled = true; btn.textContent = "Logging in…";

  try {
    const url = `${PROXY_URL}?base=${encodeURIComponent(base)}&path=${encodeURIComponent("api/v1/admin/sessions")}${DEBUG?"&debug=1":""}`;
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password: pass })
    });
    const txt = await res.text();
    let json = {};
    try { json = JSON.parse(txt); } catch {}

    if(DEBUG) console.log("Login response:", res.status, txt);

    const token = extractToken(json);
    if(!res.ok || !token){
      const errMsg = json.error || json.message || ("HTTP " + res.status);
      const detail = DEBUG ? `<br><small>${escHtml(txt.slice(0,400))}</small>` : "";
      showMsg("pwMsg", "error", `Login failed: ${escHtml(errMsg)}${detail}`);
      return;
    }
    saveBase(base);
    saveToken(token);
    window.location.replace("create.html");
  } catch(e){
    showMsg("pwMsg","error","Network error: " + escHtml(e.message));
  } finally {
    btn.disabled = false; btn.textContent = "Log in";
  }
});

/* ---- Login with API token (verify by loading projects) ---- */
document.getElementById("loginTokenBtn").addEventListener("click", async () => {
  const baseRaw = document.getElementById("tkBase").value.trim();
  const token   = document.getElementById("tkToken").value.trim();

  if(!baseRaw || !token){
    showMsg("tkMsg","error","Please fill in both fields.");
    return;
  }
  const base = originOf(baseRaw);
  const btn  = document.getElementById("loginTokenBtn");
  btn.disabled = true; btn.textContent = "Connecting…";

  try {
    /* Quick verification: try to load projects */
    const url = `${PROXY_URL}?base=${encodeURIComponent(base)}&path=${encodeURIComponent("api/v1/admin/projects")}${DEBUG?"&debug=1":""}`;
    const res = await fetch(url, { headers: { "X-Beeple-Token": token } });
    const txt = await res.text();
    let json = {};
    try { json = JSON.parse(txt); } catch {}

    if(DEBUG) console.log("Token verify response:", res.status, txt);

    if(!res.ok){
      const errMsg = (json && (json.error || json.message)) || ("HTTP " + res.status);
      const detail = DEBUG ? `<br><small>${escHtml(txt.slice(0,400))}</small>` : "";
      showMsg("tkMsg","error",`Connection failed: ${escHtml(errMsg)}${detail}`);
      return;
    }
    saveBase(base);
    saveToken(token);
    window.location.replace("create.html");
  } catch(e){
    showMsg("tkMsg","error","Network error: " + escHtml(e.message));
  } finally {
    btn.disabled = false; btn.textContent = "Connect";
  }
});

/* ---- Allow Enter key in forms ---- */
document.getElementById("formPassword").addEventListener("keydown", e => {
  if(e.key === "Enter") document.getElementById("loginPwBtn").click();
});
document.getElementById("formToken").addEventListener("keydown", e => {
  if(e.key === "Enter") document.getElementById("loginTokenBtn").click();
});

/* ---- Keep base URL fields in sync ---- */
document.getElementById("pwBase").addEventListener("blur", () => {
  const v = document.getElementById("pwBase").value.trim();
  if(v && !document.getElementById("tkBase").value.trim()){
    document.getElementById("tkBase").value = v;
  }
  saveBase(originOf(v));
});
document.getElementById("tkBase").addEventListener("blur", () => {
  const v = document.getElementById("tkBase").value.trim();
  if(v && !document.getElementById("pwBase").value.trim()){
    document.getElementById("pwBase").value = v;
  }
  saveBase(originOf(v));
});

function escHtml(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":'&#39;'}[m])); }
</script>
</body>
</html>
