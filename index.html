<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>SaasTools.eu for Beeple — Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="icon" href="icon.svg">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4e6bff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icon.svg">
<style>
:root {
  --bg:#f0f4ff; --bg2:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#475569;
  --accent:#4e6bff; --accent2:#7da2ff; --accentSoft:#e9efff; --danger:#ef6b6b;
  --success:#22c55e; --successSoft:#dcfce7;
  --border:rgba(15,23,42,.10); --field:#ffffff; --fieldBorder:#e5e7eb;
  --radius:10px; --radius-lg:14px;
  --shadow:0 4px 20px rgba(15,23,42,.08),0 1px 0 rgba(15,23,42,.04);
}
[data-theme="dark"] {
  --bg:#0b1020; --bg2:#0e1428; --card:#0f1630; --text:#e8ecff; --muted:#b8c3ef;
  --accent:#5aa2ff; --accent2:#7ec3ff; --accentSoft:#0e2244; --danger:#e66d6d;
  --success:#4ade80; --successSoft:#052e16;
  --border:rgba(255,255,255,.14); --field:#121b39; --fieldBorder:rgba(255,255,255,.18);
  --shadow:0 8px 28px rgba(0,0,0,.35),0 1px 0 rgba(255,255,255,.04);
}
*,*::before,*::after { box-sizing:border-box; max-width:100%; }
html { overflow-x:clip; }
body {
  margin:0; overflow-x:clip;
  background:var(--bg);
  color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  font-size:15px; line-height:1.55;
  min-height:100vh;
  -webkit-text-size-adjust:100%; text-size-adjust:100%;
}
/* TOP BAR */
.topbar {
  position:sticky; top:0; z-index:30;
  background:var(--card); border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px;
  padding:10px 16px;
}
.topbar .brand img { height:28px; width:28px; border-radius:6px; display:block; }
.topbar .title { font-weight:800; font-size:clamp(14px,3vw,17px); flex:1; text-align:center; display:flex; flex-direction:column; align-items:center; line-height:1.2; gap:1px; }
.topbar .page-subtitle { font-size:11px; font-weight:500; color:var(--muted); letter-spacing:.03em; text-transform:uppercase; }
.icon-btn {
  width:40px; height:40px; border-radius:10px; border:1px solid var(--border);
  background:var(--accentSoft); cursor:pointer; display:flex; align-items:center;
  justify-content:center; flex-shrink:0; color:var(--accent); font-size:18px;
}
[data-theme="dark"] .icon-btn { color:var(--accent2); }
.icon-btn svg { width:20px; height:20px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
/* CONTAINER */
.container {
  width:100%; max-width:480px; margin:40px auto; padding:0 16px 60px;
}
/* CARD */
.card {
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg);
  padding:24px; box-shadow:var(--shadow); overflow:hidden;
}
.card h2 { margin:0 0 4px; font-size:20px; }
.card-sub { color:var(--muted); font-size:13px; margin:0 0 20px; }
/* FORM */
input, select {
  display:block; width:100%; padding:11px 12px;
  border:1px solid var(--fieldBorder); border-radius:var(--radius);
  background:var(--field); color:var(--text); font-family:inherit;
  font-size:16px; line-height:1.4;
  transition:border-color .15s,box-shadow .15s;
  -webkit-appearance:none; appearance:none;
}
input::placeholder { color:var(--muted); opacity:.6; }
input:focus, select:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(78,107,255,.18); }
label { display:block; font-weight:600; font-size:13px; color:var(--muted); margin:14px 0 5px; }
label:first-child { margin-top:0; }
.required::after { content:" *"; color:var(--accent); }
/* BUTTONS */
.btn {
  display:inline-flex; align-items:center; justify-content:center;
  width:100%; border:none; border-radius:var(--radius);
  padding:12px 18px; font-family:inherit; font-size:15px; font-weight:700; line-height:1.2;
  cursor:pointer; min-height:46px; white-space:nowrap;
  transition:filter .15s,opacity .15s;
}
.btn.primary { background:linear-gradient(160deg,var(--accent),var(--accent2)); color:#fff; }
.btn.primary:hover { filter:brightness(1.08); }
.btn.secondary { background:#edf2ff; color:#0f172a; border:1px solid var(--border); }
[data-theme="dark"] .btn.secondary { background:#1e2a45; color:#e5e7eb; }
.btn:disabled { opacity:.6; cursor:default; }
/* LOGIN TABS */
.login-tabs {
  display:flex; gap:0; border:1px solid var(--border); border-radius:var(--radius);
  overflow:hidden; margin:20px 0 0;
}
.login-tab {
  flex:1; padding:10px; font-family:inherit; font-size:14px; font-weight:600;
  border:none; cursor:pointer; background:transparent; color:var(--muted);
  transition:background .15s,color .15s;
}
.login-tab.active { background:var(--accentSoft); color:var(--accent); }
[data-theme="dark"] .login-tab.active { color:var(--accent2); }
/* FORMS */
.login-form { margin-top:16px; }
.hidden { display:none !important; }
/* DIVIDER */
.divider {
  display:flex; align-items:center; gap:10px; margin:16px 0 0;
  color:var(--muted); font-size:13px;
}
.divider::before,.divider::after { content:""; flex:1; height:1px; background:var(--border); }
/* ALERT */
.alert {
  padding:12px 14px; border-radius:var(--radius); font-size:14px;
  margin-top:14px; word-break:break-word;
}
.alert-error { background:#fee2e2; border:1px solid #fca5a5; color:#991b1b; }
[data-theme="dark"] .alert-error { color:#fca5a5; }
/* BTN ROW */
.btn-row { margin-top:16px; }
/* SECURITY NOTICE */
.security-notice {
  margin-top:14px; padding:10px 12px;
  border:1px dashed #f59e0b; border-radius:10px;
  background:rgba(245,158,11,.10); color:#92400e; font-size:13px;
}
[data-theme="dark"] .security-notice { color:#fcd34d; }
</style>
</head>
<body>

<div class="topbar">
  <div class="brand" style="flex:0;"><img alt="SaasTools.eu" src="icon.svg"></div>
  <div class="title">SaasTools.eu for Beeple<span class="page-subtitle">Login</span></div>
  <button class="icon-btn" id="themeBtn" title="Toggle dark/light mode">
    <svg id="themeIcon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
  </button>
</div>

<div class="container">
  <div class="card">
    <h2>Connect to Beeple</h2>
    <p class="card-sub">Enter your tenant URL to get started.</p>

    <!-- Tab selector -->
    <div class="login-tabs">
      <button class="login-tab active" data-tab="password" type="button">Email &amp; password</button>
      <button class="login-tab" data-tab="token" type="button">API token</button>
    </div>

    <!-- EMAIL + PASSWORD FORM -->
    <form id="formPassword" class="login-form" autocomplete="on" novalidate>
      <label for="pwBaseUrl" class="required">Tenant URL</label>
      <input id="pwBaseUrl" type="url" name="url" autocomplete="url"
             inputmode="url" placeholder="https://acme.beepleapp.com">
      <label class="required">Email</label>
      <input id="email" type="email" name="email" autocomplete="email" placeholder="you@example.com">
      <label class="required">Password</label>
      <input id="password" type="password" name="password" autocomplete="current-password" placeholder="Password">
      <div class="btn-row">
        <button id="loginBtn" type="submit" class="btn primary">Log in</button>
      </div>
    </form>

    <!-- API TOKEN FORM -->
    <!-- autocomplete="username" on the URL field makes browsers pair tenant URL + token as a saved credential -->
    <form id="formToken" class="login-form hidden" autocomplete="on" novalidate>
      <label for="tkBaseUrl" class="required">Tenant URL</label>
      <input id="tkBaseUrl" type="url" name="username" autocomplete="username"
             inputmode="url" placeholder="https://acme.beepleapp.com">
      <label class="required">API token</label>
      <input id="tokenInput" type="password" name="password" autocomplete="current-password"
             placeholder="Paste your API token here">
      <div class="security-notice">
        <b>Security notice:</b> Your API token is confidential. Never share it with others and handle it as securely as you would a password.
      </div>
      <div class="btn-row">
        <button id="tokenLoginBtn" type="submit" class="btn primary">Connect</button>
      </div>
      <details style="margin-top:16px;font-size:13px;">
        <summary style="cursor:pointer;color:var(--accent);font-weight:600;list-style:none;display:flex;align-items:center;gap:6px;user-select:none;">
          <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          How to get your API token?
        </summary>
        <div style="margin-top:10px;padding:12px 14px;background:var(--accentSoft);border-radius:var(--radius);color:var(--muted);line-height:1.7;">
          <ol style="margin:0;padding-left:18px;">
            <li>Log in to Beeple as an <strong>admin</strong></li>
            <li>Click the <strong>profile menu</strong> (top-right of Beeple)</li>
            <li>Choose <strong>Admin profile</strong></li>
            <li>Scroll to the <strong>API token</strong> section</li>
            <li>Generate or copy your existing token and paste it above</li>
          </ol>
        </div>
      </details>
    </form>

    <div id="loginError" class="alert alert-error hidden"></div>
  </div>
</div>

<script>
const PROXY_URL = "https://coraligo.com/team-wizard/proxy.php";
const debugParam = new URLSearchParams(location.search).get("debug");
const DEBUG = debugParam === "1" || debugParam === "Y" || debugParam === "y";

/* ---- Theme ---- */
(function(){
  const t = localStorage.getItem("theme") || "light";
  document.documentElement.setAttribute("data-theme", t);
  syncTheme();
})();
function syncTheme(){
  const dark = document.documentElement.getAttribute("data-theme") === "dark";
  document.getElementById("themeIcon").innerHTML = dark
    ? '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>'
    : '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
}
document.getElementById("themeBtn").addEventListener("click", () => {
  const next = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem("theme", next);
  syncTheme();
});

/* ---- Tab switching (sync URL fields so the user never loses what they typed) ---- */
document.querySelectorAll(".login-tab").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".login-tab").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    if(tab === "token"){
      document.getElementById("tkBaseUrl").value = document.getElementById("pwBaseUrl").value;
    } else {
      document.getElementById("pwBaseUrl").value = document.getElementById("tkBaseUrl").value;
    }
    document.getElementById("formPassword").classList.toggle("hidden", tab !== "password");
    document.getElementById("formToken").classList.toggle("hidden", tab !== "token");
    clearError();
  });
});

function clearError(){ document.getElementById("loginError").classList.add("hidden"); }
function showError(msg){ const el=document.getElementById("loginError"); el.textContent=msg; el.classList.remove("hidden"); }

function originOf(u){ try{ return new URL(u).origin; }catch{ return u; } }

function getBase(){
  const pwHidden = document.getElementById("formPassword").classList.contains("hidden");
  const id = pwHidden ? "tkBaseUrl" : "pwBaseUrl";
  return originOf(document.getElementById(id).value.trim());
}

/* ---- Storage helpers ---- */
function saveBase(v){ if(v) localStorage.setItem("bwBase", v); }
function saveToken(v){ if(v) sessionStorage.setItem("bwToken", v); }

function saveAndGo(token){
  const base = getBase();
  saveBase(base);
  saveToken(token);
  sessionStorage.setItem("bwJustLoggedIn", "1");
  window.location.replace("create.html");
}

/* ---- Pre-fill tenant URL from localStorage into both forms ---- */
function loadSavedBase(){
  const saved = localStorage.getItem("bwBase") || "";
  if(saved){
    document.getElementById("pwBaseUrl").value = saved;
    document.getElementById("tkBaseUrl").value = saved;
  }
}
loadSavedBase();

/* ---- Helper: extract token from API response ---- */
function extractToken(json){
  return json.token || json.auth_token || json.access_token || json.api_token ||
         (json.user && json.user.token) || (json.data && json.data.token) ||
         (json.session && json.session.token) || null;
}

/* ---- Login with email + password ---- */
document.getElementById("formPassword").addEventListener("submit", async (e) => {
  e.preventDefault();
  const base  = getBase();
  const email = document.getElementById("email").value.trim();
  const pass  = document.getElementById("password").value;

  const btn = document.getElementById("loginBtn");
  btn.disabled = true; btn.textContent = "Logging in…";
  clearError();

  const expiryDate = new Date(Date.now() + 365*24*60*60*1000).toISOString().slice(0,10);

  try {
    const url = `${PROXY_URL}?base=${encodeURIComponent(base)}&path=${encodeURIComponent("api/v1/authenticate")}${DEBUG?"&debug=1":""}`;
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ session: { email, password: pass, display: "Team Wizard", expiry_date: expiryDate } })
    });
    const txt = await res.text();
    let json = {};
    try { json = JSON.parse(txt); } catch {}

    if(!res.ok){
      let msg = (json && (json.error || json.message)) || txt.trim() || ("Login failed (HTTP " + res.status + ")");
      if(msg.toLowerCase().includes("missing x-beeple-token") || msg.toLowerCase().includes("x-beeple-token")){
        msg = "Email & password login is not supported by this API configuration. Please use the API Token tab instead.";
        // Switch to token tab automatically
        document.querySelector('[data-tab="token"]').click();
      }
      throw new Error(msg);
    }

    const token = json.api_token
      || json.token
      || (json.user && (json.user.api_token || json.user.token))
      || (json.data && json.data.api_token)
      || null;

    if(!token) throw new Error("Login succeeded but no API token found in response. Try logging in with an API token instead.");
    saveAndGo(token);
  } catch(err){
    showError(err.message);
  } finally {
    btn.disabled = false; btn.textContent = "Log in";
  }
});

/* ---- Login with API token ---- */
document.getElementById("formToken").addEventListener("submit", async (e) => {
  e.preventDefault();
  const base  = getBase();
  const token = document.getElementById("tokenInput").value.trim();

  if(!base || !token){
    showError("Please fill in both the tenant URL and API token.");
    return;
  }

  const btn = document.getElementById("tokenLoginBtn");
  btn.disabled = true; btn.textContent = "Connecting…";
  clearError();

  try {
    const url = `${PROXY_URL}?base=${encodeURIComponent(base)}&path=${encodeURIComponent("api/v1/admin/projects")}${DEBUG?"&debug=1":""}`;
    const res = await fetch(url, { headers: { "X-Beeple-Token": token } });
    const txt = await res.text();
    let json = {};
    try { json = JSON.parse(txt); } catch {}

    if(DEBUG) console.log("Token verify response:", res.status, txt);

    if(!res.ok){
      const msg = (json && (json.error || json.message)) || ("HTTP " + res.status);
      throw new Error("Connection failed: " + msg);
    }
    saveAndGo(token);
  } catch(err){
    showError(err.message);
  } finally {
    btn.disabled = false; btn.textContent = "Connect";
  }
});

/* ---- Save base URL on blur and keep both URL fields in sync ---- */
["pwBaseUrl", "tkBaseUrl"].forEach(id => {
  document.getElementById(id).addEventListener("blur", () => {
    const v = document.getElementById(id).value.trim();
    const other = id === "pwBaseUrl" ? "tkBaseUrl" : "pwBaseUrl";
    document.getElementById(other).value = v;
    saveBase(originOf(v));
  });
});

function escHtml(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":'&#39;'}[m])); }

/* ---- PWA: Service Worker ---- */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").catch(()=>{});
}
</script>
</body>
</html>
