<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Team Wizard</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="icon" href="https://cdn.prod.website-files.com/64dc9a6f21257128d0afb983/6601688c81ef6ab1df9e63ad_favicon-beeple.png">
<style>
:root {
  --bg:#f6f8ff; --bg2:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#475569;
  --accent:#4e6bff; --accent2:#7da2ff; --accentSoft:#e9efff; --danger:#ef6b6b;
  --border:rgba(15,23,42,.10); --field:#ffffff; --fieldBorder:#e5e7eb;
  --tableHead:#eef2ff; --radius:10px; --radius-lg:14px;
  --shadow:0 4px 20px rgba(15,23,42,.08),0 1px 0 rgba(15,23,42,.04);
}
[data-theme="dark"] {
  --bg:#0b1020; --bg2:#0e1428; --card:#0f1630; --text:#e8ecff; --muted:#b8c3ef;
  --accent:#5aa2ff; --accent2:#7ec3ff; --accentSoft:#0e2244; --danger:#e66d6d;
  --border:rgba(255,255,255,.14); --field:#121b39; --fieldBorder:rgba(255,255,255,.18);
  --tableHead:#13224a; --shadow:0 8px 28px rgba(0,0,0,.35),0 1px 0 rgba(255,255,255,.04);
}
*,*::before,*::after { box-sizing:border-box; max-width:100%; }
html { overflow-x:clip; }
body {
  margin:0; overflow-x:clip;
  background:linear-gradient(180deg,var(--bg) 0%,var(--bg2) 100%);
  color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  font-size:15px; line-height:1.55;
  transition:background .25s,color .25s;
  -webkit-text-size-adjust:100%; text-size-adjust:100%;
}
/* TOP BAR */
.topbar {
  position:sticky; top:0; z-index:30;
  background:var(--card); border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px;
  padding:10px 16px;
}
.topbar .brand img { height:22px; width:auto; display:block; }
.topbar .title { font-weight:800; font-size:clamp(15px,3vw,20px); flex:1; text-align:center; }
.icon-btn {
  width:40px; height:40px; border-radius:10px; border:1px solid var(--border);
  background:var(--accentSoft); cursor:pointer; display:flex; align-items:center;
  justify-content:center; flex-shrink:0; color:var(--accent);
}
[data-theme="dark"] .icon-btn { color:var(--accent2); }
.icon-btn svg { width:20px; height:20px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
/* HAMBURGER MENU PANEL */
.menu-overlay { display:none; position:fixed; inset:0; z-index:49; background:rgba(0,0,0,.4); }
.menu-overlay.show { display:block; }
.menu-panel {
  position:fixed; top:0; right:0; bottom:0;
  width:min(260px,80vw); background:var(--card);
  border-left:1px solid var(--border);
  z-index:50; transform:translateX(100%);
  transition:transform .3s ease;
  display:flex; flex-direction:column;
  box-shadow:-4px 0 20px rgba(0,0,0,.15);
}
.menu-panel.open { transform:translateX(0); }
.menu-panel-header {
  padding:16px; display:flex; align-items:center; justify-content:space-between;
  border-bottom:1px solid var(--border); flex-shrink:0;
}
.menu-panel-header span { font-weight:800; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.06em; }
.menu-item {
  display:flex; align-items:center; gap:12px; padding:15px 16px;
  cursor:pointer; border-bottom:1px solid var(--border);
  text-decoration:none; color:var(--text); font-weight:600; font-size:15px;
  transition:background .15s; background:transparent; border-left:0; border-right:0; border-top:0;
  font-family:inherit; width:100%; text-align:left;
}
.menu-item:hover { background:var(--accentSoft); }
.menu-item svg { width:20px; height:20px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; flex-shrink:0; }
.menu-item.active { color:var(--accent); background:var(--accentSoft); }
[data-theme="dark"] .menu-item.active { color:var(--accent2); }
.menu-spacer { flex:1; }
.menu-divider { height:1px; background:var(--border); margin:4px 0; }
/* CONTAINER */
.container { width:100%; max-width:980px; margin:14px auto 36px; padding:0 12px; display:grid; gap:14px; }
/* CARDS */
.card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:16px; box-shadow:var(--shadow); overflow:hidden; min-width:0; }
.card h2 { margin:0 0 10px; font-size:17px; }
.sub { color:var(--muted); font-size:13px; margin-top:4px; }
@media(max-width:400px){ .card{padding:12px;} }
/* FORM ELEMENTS */
input,select,textarea {
  display:block; width:100%; padding:11px 12px;
  border:1px solid var(--fieldBorder); border-radius:var(--radius);
  background:var(--field); color:var(--text); font-family:inherit;
  font-size:16px; line-height:1.4;
  transition:border-color .15s,box-shadow .15s;
  -webkit-appearance:none; appearance:none;
}
input::placeholder,textarea::placeholder { color:var(--muted); opacity:.6; }
input:focus,select:focus,textarea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(78,107,255,.18); }
select {
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' stroke-width='1.8' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat; background-position:right 12px center; padding-right:36px; cursor:pointer;
}
/* LABELS */
label { display:block; font-weight:600; font-size:13px; color:var(--muted); margin:14px 0 5px; }
label:first-child { margin-top:4px; }
.required::after { content:" *"; color:var(--accent); }
/* BUTTONS */
.btn {
  display:inline-flex; align-items:center; justify-content:center;
  width:auto; border:none; border-radius:var(--radius);
  padding:11px 18px; font-family:inherit; font-size:14px; font-weight:700; line-height:1.2;
  cursor:pointer; min-height:44px; white-space:nowrap;
  transition:filter .15s,opacity .15s;
}
.btn.primary { background:linear-gradient(160deg,var(--accent),var(--accent2)); color:#fff; }
.btn.primary:hover { filter:brightness(1.08); }
.btn.secondary { background:#edf2ff; color:#0f172a; border:1px solid var(--border); }
[data-theme="dark"] .btn.secondary { background:#1e2a45; color:#e5e7eb; }
.btn-danger { background:var(--danger); color:#fff; }
.btn-ghost { background:transparent; border:1px solid var(--border); color:var(--muted); padding:6px 12px; min-height:36px; font-size:13px; }
.btn:disabled { opacity:.6; cursor:default; }
/* COLLAPSIBLE */
.collapsible .head { display:flex; align-items:flex-start; justify-content:space-between; gap:8px; flex-wrap:wrap; }
.collapsible .head h2 { margin-bottom:0; flex:1 1 auto; }
.collapsible .tools { display:flex; gap:6px; flex-shrink:0; }
.collapsible .body { margin-top:14px; }
.collapsed .body { display:none; }
/* GRID ROWS */
.row   { display:grid; grid-template-columns:1fr 1fr;     gap:10px; }
.row-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
@media(max-width:560px){ .row,.row-3 { grid-template-columns:1fr; } }
/* BUTTON ROW */
.btn-row { display:flex; gap:10px; flex-wrap:wrap; margin-top:16px; }
@media(max-width:440px){ .btn-row{flex-direction:column;} .btn-row .btn{width:100%;} }
/* UTILITY */
.hidden { display:none !important; }
/* TABLES */
.table-wrap { width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:var(--radius); }
table { min-width:620px; width:100%; border-collapse:separate; border-spacing:0; border:1px solid var(--fieldBorder); border-radius:10px; overflow:hidden; background:var(--field); }
th,td { padding:9px 11px; border-bottom:1px solid var(--fieldBorder); vertical-align:top; white-space:nowrap; font-size:13px; }
th { background:var(--tableHead); color:#0b1740; text-align:left; font-weight:700; }
[data-theme="dark"] th { color:#d9e3ff; }
tr:last-child td { border-bottom:0; }
.table-note { padding:14px 12px; color:var(--muted); white-space:normal; font-size:13px; }
/* LOG */
pre { background:#f7f9ff; color:#111827; border:1px solid var(--fieldBorder); border-radius:var(--radius); padding:12px; font-size:12px; max-height:38vh; overflow:auto; white-space:pre-wrap; word-break:break-word; width:100%; }
[data-theme="dark"] pre { background:#070e1f; color:#c7dbff; }
/* ANIMATION */
@keyframes slideRight { to { opacity:0; transform:translateX(60%); } }
.slideRight { animation:slideRight .35s ease forwards; }
</style>
</head>
<body>

<div class="topbar">
  <button class="icon-btn" id="menuBtn" title="Menu" aria-label="Menu">
    <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
  <div class="brand">
    <img alt="Beeple" src="https://cdn.prod.website-files.com/64dc9a6f21257128d0afb983/65f86aca8cc32ec9836e8a29_beeple-textlogo.svg">
  </div>
  <div class="title">Team Wizard</div>
  <div style="width:40px;"></div>
</div>

<!-- MENU OVERLAY + PANEL -->
<div class="menu-overlay" id="menuOverlay"></div>
<div class="menu-panel" id="menuPanel">
  <div class="menu-panel-header">
    <span>Menu</span>
    <button class="icon-btn" id="menuCloseBtn" title="Close">
      <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <a class="menu-item active" href="teams.html">
    <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    Team creation
  </a>
  <a class="menu-item" href="planning.html">
    <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Planning
  </a>
  <div class="menu-spacer"></div>
  <div class="menu-divider"></div>
  <button class="menu-item" id="themeMenuBtn">
    <svg id="themeMenuIcon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
    <span id="themeMenuLabel">Dark mode</span>
  </button>
  <div class="menu-divider"></div>
  <button class="menu-item" id="logoutBtn" style="color:var(--danger);">
    <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
    Log out
  </button>
</div>

<main class="container">
  <!-- Create single team -->
  <section class="card collapsible" id="sec-single">
    <div class="head">
      <h2>Create single team</h2>
      <div class="tools">
        <button class="btn btn-ghost" data-toggle="#sec-single" data-role="collapse">Collapse</button>
        <button class="btn btn-ghost hidden" data-toggle="#sec-single">Expand</button>
      </div>
    </div>
    <div class="body">
      <div class="btn-row" style="margin-top:0;margin-bottom:10px;">
        <button id="loadBtn" class="btn secondary">Load tenant data</button>
      </div>
      <div id="projectBlock" class="hidden">
        <label class="required">Project</label>
        <select id="projectSelect"></select>
      </div>
      <div id="subprojectBlock" class="hidden">
        <label class="required">Subproject</label>
        <select id="subprojectSelect"></select>
      </div>
      <div class="row">
        <div>
          <label>Auto-generate name</label>
          <select id="autoName"><option value="yes" selected>Yes</option><option value="no">No</option></select>
        </div>
        <div id="teamNameWrap" class="hidden">
          <label>Team name</label>
          <input id="teamName" placeholder="Team name">
        </div>
      </div>
      <div class="row">
        <div>
          <label class="required">Volunteers needed</label>
          <input id="volNeeded" type="number" inputmode="numeric" min="0" value="1">
        </div>
        <div id="functionBlock" class="hidden">
          <label class="required">Function</label>
          <select id="functionSelect"></select>
        </div>
      </div>
      <div id="addressBlock" class="hidden">
        <label class="required">Work location</label>
        <select id="addressSelect"></select>
      </div>
      <div class="row">
        <div>
          <label class="required">Shift start (local)</label>
          <input id="shiftStart" type="datetime-local">
        </div>
        <div>
          <label class="required">Shift end (local)</label>
          <input id="shiftEnd" type="datetime-local">
        </div>
      </div>
      <div class="row">
        <div>
          <label class="required">Draft mode</label>
          <select id="draftMode"><option value="yes" selected>Yes</option><option value="no">No</option></select>
        </div>
        <div id="compBlock" class="hidden">
          <label>Team compensation</label>
          <select id="compensationSelect"></select>
        </div>
      </div>
      <label>Max travel distance (km)</label>
      <input id="maxTravelKm" type="number" inputmode="numeric" min="0">
      <label>Extra practical info</label>
      <textarea id="extraInfo" rows="3" placeholder="extra info"></textarea>
      <!-- Advanced collapsed by default -->
      <div class="collapsible collapsed" id="sec-advanced">
        <div class="head" style="margin-top:16px;">
          <h2 style="font-size:15px;margin:0;">Advanced fields</h2>
          <div class="tools">
            <button class="btn btn-ghost" data-toggle="#sec-advanced">Expand</button>
            <button class="btn btn-ghost hidden" data-toggle="#sec-advanced" data-role="collapse">Collapse</button>
          </div>
        </div>
        <div class="body">
          <div class="row">
            <div><label>Relative check-in start (HH:MM)</label><input id="relCheckinStart" placeholder="00:30"></div>
            <div><label>Relative check-in duration (HH:MM)</label><input id="relCheckinDuration" placeholder="00:15"></div>
          </div>
          <div class="row">
            <div><label>Work location specification</label><input id="locationSpec" placeholder="At the entrance"></div>
            <div><label>Minimal age</label><input id="minimalAge" type="number" inputmode="numeric" min="0" placeholder="18"></div>
          </div>
          <label>Client experience required</label>
          <select id="clientExperience">
            <option value="">(not set)</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>
      <div class="btn-row">
        <button id="createSingleBtn" class="btn primary">Create team</button>
      </div>
    </div>
  </section>
  <!-- Created -->
  <section class="card collapsible" id="sec-created">
    <div class="head">
      <h2>Created teams</h2>
      <div class="tools">
        <button class="btn btn-ghost" data-toggle="#sec-created" data-role="collapse">Collapse</button>
        <button class="btn btn-ghost hidden" data-toggle="#sec-created">Expand</button>
      </div>
    </div>
    <div class="body">
      <div class="table-wrap">
        <table>
          <thead><tr><th>ID</th><th>Project</th><th>Subproject</th><th>Name</th><th>Function</th><th>Address</th><th>Comp.</th><th>Shift</th><th>Action</th></tr></thead>
          <tbody id="createdTbody"><tr><td class="table-note" colspan="9">Nothing created yet.</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>
  <!-- Logs -->
  <section class="card collapsible" id="sec-logs">
    <div class="head">
      <h2>Logs</h2>
      <div class="tools">
        <button class="btn btn-ghost" data-toggle="#sec-logs" data-role="collapse">Collapse</button>
        <button class="btn btn-ghost hidden" data-toggle="#sec-logs">Expand</button>
      </div>
    </div>
    <div class="body"><pre id="log">Ready</pre></div>
  </section>
</main>

<script>
const PROXY_URL = "https://coraligo.com/team-wizard/proxy.php";
const DEBUG     = (new URLSearchParams(location.search).get("debug") || "").toUpperCase() === "Y"
                  || new URLSearchParams(location.search).get("debug") === "1";

/* Read credentials from storage */
const BASE  = localStorage.getItem("bwBase")  || "";
const TOKEN = sessionStorage.getItem("bwToken") || "";

if(!BASE || !TOKEN){ window.location.href = "index.html"; }

const els = {
  loadBtn:document.getElementById("loadBtn"),
  projectBlock:document.getElementById("projectBlock"),subprojectBlock:document.getElementById("subprojectBlock"),
  functionBlock:document.getElementById("functionBlock"),addressBlock:document.getElementById("addressBlock"),
  compBlock:document.getElementById("compBlock"),
  projectSelect:document.getElementById("projectSelect"),subprojectSelect:document.getElementById("subprojectSelect"),
  functionSelect:document.getElementById("functionSelect"),addressSelect:document.getElementById("addressSelect"),
  compensationSelect:document.getElementById("compensationSelect"),
  autoName:document.getElementById("autoName"),teamNameWrap:document.getElementById("teamNameWrap"),
  teamName:document.getElementById("teamName"),volNeeded:document.getElementById("volNeeded"),
  shiftStart:document.getElementById("shiftStart"),shiftEnd:document.getElementById("shiftEnd"),
  draftMode:document.getElementById("draftMode"),maxTravelKm:document.getElementById("maxTravelKm"),
  extraInfo:document.getElementById("extraInfo"),
  relCheckinStart:document.getElementById("relCheckinStart"),relCheckinDuration:document.getElementById("relCheckinDuration"),
  locationSpec:document.getElementById("locationSpec"),minimalAge:document.getElementById("minimalAge"),
  clientExperience:document.getElementById("clientExperience"),
  createSingleBtn:document.getElementById("createSingleBtn"),
  createdTbody:document.getElementById("createdTbody"),
  log:document.getElementById("log"),
};

const L = (...a) => { els.log.textContent += a.join(" ") + "\n"; els.log.scrollTop = els.log.scrollHeight; };
const addGap = () => { els.log.textContent += "\n"; };
const extractErr = e => { if(!e) return "Unknown error"; if(typeof e==="string") return e; if(e.message) return e.message; try{ return JSON.stringify(e); }catch{ return String(e); } };

function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":'&#39;'}[m])); }

const tenantKey = () => BASE.replace(/^https?:\/\//,"").replace(/[^\w.-]/g,"_");
const savePerTenant = (k,v) => { const t=tenantKey(); if(t) localStorage.setItem(`beeple_${t}_${k}`,v); };
const loadPerTenant = k => { const t=tenantKey(); return t ? (localStorage.getItem(`beeple_${t}_${k}`) || "") : ""; };

/* Theme */
function syncTheme(){
  const dark = document.documentElement.getAttribute("data-theme") === "dark";
  const icon = dark
    ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>'
    : '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
  document.getElementById("themeMenuIcon").innerHTML = icon;
  document.getElementById("themeMenuLabel").textContent = dark ? "Light mode" : "Dark mode";
}

/* Hamburger menu */
const menuPanel   = document.getElementById("menuPanel");
const menuOverlay = document.getElementById("menuOverlay");
function openMenu(){ menuPanel.classList.add("open"); menuOverlay.classList.add("show"); }
function closeMenu(){ menuPanel.classList.remove("open"); menuOverlay.classList.remove("show"); }
document.getElementById("menuBtn").addEventListener("click", openMenu);
document.getElementById("menuCloseBtn").addEventListener("click", closeMenu);
menuOverlay.addEventListener("click", closeMenu);

document.getElementById("themeMenuBtn").addEventListener("click", () => {
  const next = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem("theme", next);
  syncTheme();
});

document.getElementById("logoutBtn").addEventListener("click", () => {
  sessionStorage.removeItem("bwToken");
  window.location.href = "index.html";
});

/* Collapsible */
function toggleSection(el, expand){
  if(!el) return;
  if(expand === undefined) expand = el.classList.contains("collapsed");
  const xBtn = el.querySelector('[data-toggle]:not([data-role="collapse"])');
  const cBtn = el.querySelector('[data-toggle][data-role="collapse"]');
  if(expand){ el.classList.remove("collapsed"); if(xBtn) xBtn.classList.add("hidden"); if(cBtn) cBtn.classList.remove("hidden"); }
  else{ el.classList.add("collapsed"); if(xBtn) xBtn.classList.remove("hidden"); if(cBtn) cBtn.classList.add("hidden"); }
}

/* Proxy helpers */
function proxyUrl(path){ return `${PROXY_URL}?base=${encodeURIComponent(BASE)}&path=${encodeURIComponent(path)}${DEBUG?"&debug=1":""}`; }

async function proxyGET(path){
  L("GET", path);
  const res = await fetch(proxyUrl(path), { headers:{"X-Beeple-Token":TOKEN} });
  const txt = await res.text();
  L("<-", res.status);
  if(DEBUG && txt) L(txt.length > 2000 ? txt.slice(0,2000)+"…" : txt);
  addGap();
  if(!res.ok) throw new Error("HTTP " + res.status + " on GET " + path);
  try{ return txt ? JSON.parse(txt) : {}; }catch{ return {raw:txt}; }
}

async function proxyPOST(path, payload){
  const body = JSON.stringify(payload);
  L("POST", path);
  if(DEBUG) L("Body:", body.length > 2000 ? body.slice(0,2000)+"…" : body);
  const res = await fetch(proxyUrl(path), {method:"POST", headers:{"X-Beeple-Token":TOKEN,"Content-Type":"application/json"}, body});
  const txt = await res.text();
  L("<-", res.status);
  if(txt) L(txt.length > 2000 ? txt.slice(0,2000)+"…" : txt);
  addGap();
  if(!res.ok){
    let r = "HTTP " + res.status;
    try{ const j=JSON.parse(txt); if(j&&j.error) r=j.error; }catch{}
    throw new Error(r);
  }
  try{ return txt ? JSON.parse(txt) : {}; }catch{ return {raw:txt}; }
}

async function proxyDELETE(path){
  L("DELETE", path);
  const res = await fetch(proxyUrl(path), {method:"DELETE", headers:{"X-Beeple-Token":TOKEN}});
  L("<-", res.status); addGap();
  if(!res.ok) throw new Error("HTTP " + res.status); return true;
}

/* State */
const state = {
  maps:{ projects:{}, subprojects:{}, functions:{}, addresses:{}, compensations:{} },
  created:[]
};

function fillSelect(sel, items){
  sel.innerHTML = "";
  items.forEach(it => { const o=document.createElement("option"); o.value=String(it.value); o.textContent=it.label; sel.appendChild(o); });
}

async function loadTenant(){
  if(!BASE || !TOKEN){ alert("Not logged in."); return; }
  ["projectBlock","subprojectBlock","functionBlock","addressBlock","compBlock"].forEach(id=>els[id].classList.add("hidden"));
  try{
    const pData = await proxyGET("api/v1/admin/projects");
    const projects = pData.projects || [];
    fillSelect(els.projectSelect, projects.map(p=>({value:p.id, label:p.name||"Project #"+p.id})));
    state.maps.projects = Object.fromEntries(projects.map(p=>[String(p.id), p.name||"Project #"+p.id]));
    if(projects.length) els.projectBlock.classList.remove("hidden");

    const fData = await proxyGET("api/v1/admin/functions");
    const fns = fData.functions || fData || [];
    fillSelect(els.functionSelect, fns.map(f=>({value:f.id, label:f.name||"Function #"+f.id})));
    state.maps.functions = Object.fromEntries(fns.map(f=>[String(f.id), f.name||"Function #"+f.id]));
    if(fns.length) els.functionBlock.classList.remove("hidden");

    const aData = await proxyGET("api/v1/admin/addresses");
    const addrs = aData.addresses || [];
    const addrL = a => a.name || [a.street,a.number,a.city].filter(Boolean).join(" ") || "Address #"+a.id;
    fillSelect(els.addressSelect, addrs.map(a=>({value:a.id, label:addrL(a)})));
    state.maps.addresses = Object.fromEntries(addrs.map(a=>[String(a.id), addrL(a)]));
    if(addrs.length) els.addressBlock.classList.remove("hidden");

    const cData = await proxyGET("api/v1/admin/team_compensations");
    const comps = cData.team_compensations || cData || [];
    const cOpts = [{value:"",label:"(none)"}].concat(comps.map(c=>({value:c.id, label:c.name||"Comp #"+c.id})));
    fillSelect(els.compensationSelect, cOpts);
    state.maps.compensations = Object.fromEntries(cOpts.map(o=>[String(o.value), o.label]));
    els.compBlock.classList.remove("hidden");

    L(`Loaded — Projects:${projects.length} Fns:${fns.length} Addrs:${addrs.length}`);

    /* Restore last selections */
    const lp = loadPerTenant("project");
    if(lp && els.projectSelect.querySelector(`option[value="${lp}"]`)){
      els.projectSelect.value = lp;
      await loadSubprojectsForProject(lp);
    }
    const lf = loadPerTenant("function");
    if(lf) els.functionSelect.value = lf;
    const la = loadPerTenant("address");
    if(la) els.addressSelect.value = la;
    const lc = loadPerTenant("comp");
    if(lc) els.compensationSelect.value = lc;
  }catch(e){ alert("Load failed: " + extractErr(e)); }
}

async function loadSubprojectsForProject(pid){
  if(!pid){ els.subprojectBlock.classList.add("hidden"); return; }
  try{
    const sData = await proxyGET(`api/v1/admin/projects/${pid}/subprojects`);
    const subs = sData.subprojects || [];
    if(subs.length){
      fillSelect(els.subprojectSelect, subs.map(s=>({value:s.id, label:s.name||"Sub #"+s.id})));
      state.maps.subprojects = Object.fromEntries(subs.map(s=>[String(s.id), s.name||"Sub #"+s.id]));
      els.subprojectBlock.classList.remove("hidden");
      const ls = loadPerTenant("subproject");
      if(ls) els.subprojectSelect.value = ls;
    } else {
      els.subprojectBlock.classList.add("hidden");
    }
  }catch(e){ L("Sub load error:", extractErr(e)); addGap(); els.subprojectBlock.classList.add("hidden"); }
}

function currentFormRow(){
  const noSub = els.subprojectBlock.classList.contains("hidden");
  return{
    projectId:els.projectSelect.value||"", subprojectId:noSub?"":(els.subprojectSelect.value||""),
    projectName:state.maps.projects[els.projectSelect.value]||"",
    subprojectName:state.maps.subprojects[els.subprojectSelect.value]||"",
    autoName:els.autoName.value, name:els.teamName.value, volunteers:els.volNeeded.value,
    functionId:els.functionSelect.value||"", functionName:state.maps.functions[els.functionSelect.value]||"",
    addressId:els.addressSelect.value||"", addressName:state.maps.addresses[els.addressSelect.value]||"",
    compensationId:els.compensationSelect.value||"", compensationName:state.maps.compensations[els.compensationSelect.value]||"",
    draft:els.draftMode.value, start:els.shiftStart.value, end:els.shiftEnd.value,
    maxKm:els.maxTravelKm.value, extra:els.extraInfo.value,
    relStart:els.relCheckinStart.value, relDuration:els.relCheckinDuration.value,
    locSpec:els.locationSpec.value, minAge:els.minimalAge.value, clientExp:els.clientExperience.value
  };
}

function buildApiPayload(row){
  const team = {
    auto_generate_name: row.autoName === "yes",
    name: row.autoName === "yes" ? undefined : (row.name || undefined),
    volunteers_needed: row.volunteers ? parseInt(row.volunteers, 10) : undefined,
    function_id: row.functionId || undefined, work_location_id: row.addressId || undefined,
    team_compensation_id: row.compensationId || undefined, published: row.draft !== "yes",
    extra_practical_info: row.extra || undefined,
    maximum_travel_distance: row.maxKm ? Number(row.maxKm) : undefined,
    relative_checkin_start: row.relStart || undefined, relative_checkin_duration: row.relDuration || undefined,
    work_location_specification: row.locSpec || undefined,
    minimal_age: row.minAge ? Number(row.minAge) : undefined,
    client_experience_required: row.clientExp === "" ? undefined : (row.clientExp === "true"),
    shifts_attributes: []
  };
  if(row.start && row.end){
    const s=new Date(row.start), e=new Date(row.end);
    team.shifts_attributes.push({
      start_datetime: isNaN(s) ? row.start : s.toISOString(),
      end_datetime:   isNaN(e) ? row.end   : e.toISOString()
    });
  }
  Object.keys(team).forEach(k => team[k] === undefined && delete team[k]);
  return { team };
}

function renderCreated(){
  els.createdTbody.innerHTML = "";
  if(!state.created.length){
    els.createdTbody.innerHTML = `<tr><td class="table-note" colspan="9">Nothing created yet.</td></tr>`;
    return;
  }
  state.created.forEach(item => {
    const shift = (item.start && item.end) ? `${item.start} — ${item.end}` : "";
    const tr = document.createElement("tr"); tr.setAttribute("data-id", item.id);
    tr.innerHTML = `<td>${escapeHtml(item.id)}</td><td>${escapeHtml(item.projectName)}</td><td>${escapeHtml(item.subprojectName)}</td><td>${escapeHtml(item.name)}</td><td>${escapeHtml(item.functionName)}</td><td>${escapeHtml(item.addressName)}</td><td>${escapeHtml(item.compensationName)}</td><td>${escapeHtml(shift)}</td><td><button class="btn btn-ghost" data-del="${escapeHtml(item.id)}">Delete</button></td>`;
    els.createdTbody.appendChild(tr);
  });
}

async function createSingleTeam(){
  if(!els.projectSelect.value){ alert("Select a project first (load tenant data)."); return; }
  const q = currentFormRow();
  const btn = els.createSingleBtn;
  btn.disabled = true; btn.textContent = "Creating…";
  try{
    const path = q.subprojectId
      ? `api/v1/admin/subprojects/${encodeURIComponent(q.subprojectId)}/teams`
      : `api/v1/admin/projects/${encodeURIComponent(q.projectId)}/teams`;
    const res = await proxyPOST(path, buildApiPayload(q));
    const newId = (res && res.team && res.team.id) || (res && res.id) || "?";
    state.created.push({
      id: newId, projectName: q.projectName, subprojectName: q.subprojectName,
      name: q.autoName === "yes" ? "(auto)" : (q.name || "(auto)"),
      functionName: q.functionName, addressName: q.addressName,
      compensationName: q.compensationName, start: q.start, end: q.end
    });
    renderCreated();
    L("Created team ID:", newId); addGap();
  }catch(e){
    alert("Create failed: " + extractErr(e));
  }finally{
    btn.disabled = false; btn.textContent = "Create team";
  }
}

async function deleteCreated(id){
  const btn = document.querySelector(`[data-del="${id}"]`);
  if(btn){ btn.textContent = "…"; btn.disabled = true; }
  try{
    await proxyDELETE(`api/v1/admin/teams/${encodeURIComponent(id)}`);
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if(row){ row.classList.add("slideRight"); setTimeout(()=>row.remove(), 360); }
    state.created = state.created.filter(x=>String(x.id)!==String(id));
    if(!state.created.length) renderCreated();
  }catch(e){
    if(btn){ btn.textContent = "Delete"; btn.disabled = false; }
    alert("Delete failed: " + extractErr(e));
  }
}

/* Event delegation */
document.addEventListener("click", ev => {
  const t = ev.target.closest("button") || ev.target;
  if(t.dataset.toggle){ toggleSection(document.querySelector(t.dataset.toggle), t.dataset.role !== "collapse"); return; }
  if(t.id === "createSingleBtn"){ createSingleTeam(); return; }
  if(t.dataset.del){ deleteCreated(t.dataset.del); return; }
});

els.loadBtn.addEventListener("click", e => { e.preventDefault(); loadTenant(); });

els.projectSelect.addEventListener("change", async () => {
  savePerTenant("project", els.projectSelect.value);
  await loadSubprojectsForProject(els.projectSelect.value);
});
els.subprojectSelect.addEventListener("change",   () => savePerTenant("subproject", els.subprojectSelect.value));
els.functionSelect.addEventListener("change",     () => savePerTenant("function",   els.functionSelect.value));
els.addressSelect.addEventListener("change",      () => savePerTenant("address",    els.addressSelect.value));
els.compensationSelect.addEventListener("change", () => savePerTenant("comp",       els.compensationSelect.value));
els.autoName.addEventListener("change", () => els.teamNameWrap.classList.toggle("hidden", els.autoName.value === "yes"));

(function init(){
  const t = localStorage.getItem("theme") || "light";
  document.documentElement.setAttribute("data-theme", t);
  syncTheme();

  const pad = n => String(n).padStart(2,"0");
  const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  const now = new Date();
  const s = new Date(now); s.setDate(s.getDate()+1); s.setHours(8,0,0,0);
  const e = new Date(now); e.setDate(e.getDate()+1); e.setHours(17,0,0,0);
  els.shiftStart.value = fmt(s); els.shiftEnd.value = fmt(e);

  els.teamNameWrap.classList.toggle("hidden", els.autoName.value === "yes");
  toggleSection(document.getElementById("sec-single"), true);
  if(DEBUG) L("Debug ON.");
})();
</script>
</body>
</html>
