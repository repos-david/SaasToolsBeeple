<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Planning ‚Äî Beeple</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="icon" href="icon.svg">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="TeamWizard">
<link rel="apple-touch-icon" href="icon.svg">
<meta name="theme-color" content="#4e6bff">
<style>
:root {
  --bg:#f0f4ff; --bg2:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#475569;
  --accent:#4e6bff; --accent2:#7da2ff; --accentSoft:#e9efff; --danger:#ef6b6b;
  --success:#22c55e; --successSoft:#dcfce7; --warn:#f59e0b; --warnSoft:#fef3c7;
  --border:rgba(15,23,42,.10); --field:#ffffff; --fieldBorder:#e5e7eb;
  --tableHead:#eef2ff; --radius:10px; --radius-lg:14px;
  --shadow:0 4px 20px rgba(15,23,42,.08),0 1px 0 rgba(15,23,42,.04);
}
[data-theme="dark"] {
  --bg:#0b1020; --bg2:#0e1428; --card:#0f1630; --text:#e8ecff; --muted:#b8c3ef;
  --accent:#5aa2ff; --accent2:#7ec3ff; --accentSoft:#0e2244; --danger:#e66d6d;
  --success:#4ade80; --successSoft:#052e16; --warn:#fbbf24; --warnSoft:#451a03;
  --border:rgba(255,255,255,.14); --field:#121b39; --fieldBorder:rgba(255,255,255,.18);
  --tableHead:#13224a; --shadow:0 8px 28px rgba(0,0,0,.35),0 1px 0 rgba(255,255,255,.04);
}
*,*::before,*::after { box-sizing:border-box; max-width:100%; }
html { overflow-x:clip; }
body {
  margin:0; overflow-x:clip;
  background:var(--bg); color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  font-size:15px; line-height:1.55;
  -webkit-text-size-adjust:100%; text-size-adjust:100%;
}
/* ACCENT STRIP */
.accent-strip {
  height:4px; background:linear-gradient(90deg,var(--accent),var(--accent2));
  flex-shrink:0;
}
/* TOP BAR */
.topbar {
  position:sticky; top:0; z-index:30;
  background:var(--card); border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px; padding:10px 16px;
}
.topbar .brand img { height:22px; width:auto; display:block; }
.topbar .title { font-weight:800; font-size:clamp(15px,3vw,20px); flex:1; text-align:center; }
.icon-btn {
  width:40px; height:40px; border-radius:10px; border:1px solid var(--border);
  background:var(--accentSoft); cursor:pointer; display:flex; align-items:center;
  justify-content:center; flex-shrink:0; color:var(--accent);
}
[data-theme="dark"] .icon-btn { color:var(--accent2); }
.icon-btn svg { width:20px; height:20px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
/* sidebar toggle only visible on mobile */
.sidebar-toggle-btn { display:none; }
@media(max-width:700px){ .sidebar-toggle-btn { display:flex; } }
/* NAV MENU PANEL */
.menu-overlay { display:none; position:fixed; inset:0; z-index:49; background:rgba(0,0,0,.4); }
.menu-overlay.show { display:block; }
.menu-panel {
  position:fixed; top:0; right:0; bottom:0; width:min(260px,80vw);
  background:var(--card); border-left:1px solid var(--border);
  z-index:50; transform:translateX(100%); transition:transform .3s ease;
  display:flex; flex-direction:column; box-shadow:-4px 0 20px rgba(0,0,0,.15);
}
.menu-panel.open { transform:translateX(0); }
.menu-panel-header {
  padding:16px; display:flex; align-items:center; justify-content:space-between;
  border-bottom:1px solid var(--border); flex-shrink:0;
}
.menu-panel-header span { font-weight:800; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.06em; }
.menu-item {
  display:flex; align-items:center; gap:12px; padding:15px 16px;
  cursor:pointer; border-bottom:1px solid var(--border);
  text-decoration:none; color:var(--text); font-weight:600; font-size:15px;
  transition:background .15s; background:transparent;
  border-left:none; border-right:none; border-top:none;
  font-family:inherit; width:100%; text-align:left;
}
.menu-item:hover { background:var(--accentSoft); }
.menu-item.active { color:var(--accent); background:var(--accentSoft); }
[data-theme="dark"] .menu-item.active { color:var(--accent2); }
.menu-item svg { width:20px; height:20px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; flex-shrink:0; }
.menu-spacer { flex:1; }
.menu-divider { height:1px; background:var(--border); }
/* LAYOUT */
.layout { display:flex; min-height:calc(100vh - 55px); }
/* SIDEBAR */
.sidebar {
  width:var(--sidebar); flex-shrink:0;
  background:var(--card); border-right:1px solid var(--border);
  display:flex; flex-direction:column; transition:transform .3s ease; position:relative;
}
@media(max-width:700px){
  .sidebar {
    position:fixed; left:0; top:55px; bottom:0; z-index:20;
    transform:translateX(-100%); box-shadow:4px 0 20px rgba(0,0,0,.15);
  }
  .sidebar.open { transform:translateX(0); }
  .sidebar-overlay { display:block; }
}
.sidebar-overlay { display:none; position:fixed; inset:0; z-index:19; background:rgba(0,0,0,.4); }
.sidebar-overlay.show { display:block; }
.sidebar-header { padding:16px; font-weight:800; font-size:13px; letter-spacing:.06em; color:var(--muted); text-transform:uppercase; border-bottom:1px solid var(--border); }
.sidebar-search { padding:10px 12px; border-bottom:1px solid var(--border); }
.sidebar-search input { width:100%; padding:8px 12px; border:1px solid var(--fieldBorder); border-radius:var(--radius); background:var(--field); color:var(--text); font-size:14px; -webkit-appearance:none; appearance:none; }
.sidebar-search input:focus { outline:none; border-color:var(--accent); }
.proj-list { flex:1; overflow-y:auto; }
.proj-item { display:flex; align-items:center; gap:10px; padding:12px 16px; cursor:pointer; border-bottom:1px solid var(--border); transition:background .15s; }
.proj-item:hover { background:var(--accentSoft); }
.proj-item.active { background:var(--accentSoft); border-left:3px solid var(--accent); }
.proj-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.proj-name { font-weight:600; font-size:14px; flex:1; min-width:0; }
.proj-name small { display:block; font-weight:400; font-size:12px; color:var(--muted); margin-top:1px; }
.proj-badge { font-size:11px; font-weight:700; padding:2px 6px; border-radius:6px; background:var(--accentSoft); color:var(--accent); }
/* MAIN */
.main { flex:1; min-width:0; padding:20px 16px 40px; }
/* BREADCRUMB */
.breadcrumb { display:flex; align-items:center; gap:6px; font-size:13px; color:var(--muted); margin-bottom:16px; flex-wrap:wrap; }
.breadcrumb a { color:var(--accent); cursor:pointer; text-decoration:none; }
.breadcrumb a:hover { text-decoration:underline; }
/* SECTION TITLE */
.section-title { font-size:20px; font-weight:800; margin:0 0 4px; }
.section-sub { color:var(--muted); font-size:13px; margin:0 0 16px; }
/* CARDS GRID */
.card-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px; }
.card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:14px; box-shadow:var(--shadow); cursor:pointer; transition:transform .15s,box-shadow .15s; min-width:0; }
.card:hover { transform:translateY(-2px); box-shadow:0 8px 28px rgba(15,23,42,.12); }
.card h3 { margin:0 0 6px; font-size:15px; }
.card .meta { font-size:12px; color:var(--muted); }
.card .meta span { margin-right:10px; }
/* STATUS CHIPS */
.chip { display:inline-block; font-size:11px; font-weight:700; padding:2px 8px; border-radius:20px; margin-right:4px; }
.chip-green  { background:var(--successSoft); color:var(--success); }
.chip-yellow { background:var(--warnSoft);    color:var(--warn); }
.chip-red    { background:#fee2e2;             color:#dc2626; }
.chip-blue   { background:var(--accentSoft);   color:var(--accent); }
.chip-grey   { background:#f1f5f9; color:#64748b; }
/* TEAM HEADER CARD */
.team-header-card {
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg);
  padding:16px 18px; box-shadow:var(--shadow); margin-bottom:12px;
}
.team-header-card h2 { margin:0; font-size:18px; }
/* SECTION CARD */
.sec-card {
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg);
  padding:18px; box-shadow:var(--shadow); margin-bottom:12px;
}
.sec-card h3 { margin:0 0 14px; font-size:16px; font-weight:700; }
/* FORM */
input,select,textarea { display:block; width:100%; padding:10px 12px; border:1px solid var(--fieldBorder); border-radius:var(--radius); background:var(--field); color:var(--text); font-family:inherit; font-size:16px; line-height:1.4; transition:border-color .15s,box-shadow .15s; -webkit-appearance:none; appearance:none; }
input::placeholder,textarea::placeholder { color:var(--muted); opacity:.6; }
input:focus,select:focus,textarea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(78,107,255,.18); }
select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' stroke-width='1.8' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center; padding-right:36px; cursor:pointer; }
label { display:block; font-weight:600; font-size:13px; color:var(--muted); margin:14px 0 5px; }
label:first-child { margin-top:0; }
.required::after { content:" *"; color:var(--accent); }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
@media(max-width:560px){ .form-row { grid-template-columns:1fr; } }
/* BUTTONS */
.btn { display:inline-flex; align-items:center; justify-content:center; width:auto; border:none; border-radius:var(--radius); padding:10px 18px; font-family:inherit; font-size:14px; font-weight:700; line-height:1.2; cursor:pointer; min-height:42px; white-space:nowrap; transition:filter .15s,opacity .15s; }
.btn.primary { background:linear-gradient(160deg,var(--accent),var(--accent2)); color:#fff; }
.btn.primary:hover { filter:brightness(1.08); }
.btn.secondary { background:#edf2ff; color:#0f172a; border:1px solid var(--border); }
[data-theme="dark"] .btn.secondary { background:#1e2a45; color:#e5e7eb; }
.btn-danger { background:var(--danger); color:#fff; }
.btn-danger:hover { filter:brightness(1.08); }
.btn-success { background:var(--success); color:#fff; }
.btn-sm { padding:6px 12px; font-size:13px; min-height:32px; }
.btn-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:14px; }
@media(max-width:440px){ .btn-row{flex-direction:column;} .btn-row .btn{width:100%;} }
/* FILTERS */
.filters { background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:14px 16px; margin-bottom:16px; box-shadow:var(--shadow); }
.filters h4 { margin:0 0 10px; font-size:13px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; }
.filter-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:10px; }
.filter-grid input,.filter-grid select { font-size:14px; padding:8px 10px; }
.filter-grid select { padding-right:32px; }
/* COLLAB LIST */
.collab-list { display:grid; gap:10px; }
.collab-card {
  background:var(--field); border:1px solid var(--fieldBorder); border-radius:var(--radius);
  padding:12px 14px; display:flex; align-items:center; gap:12px; flex-wrap:wrap;
}
.collab-avatar {
  width:40px; height:40px; border-radius:50%; background:var(--accentSoft);
  display:flex; align-items:center; justify-content:center;
  font-weight:800; font-size:14px; color:var(--accent); flex-shrink:0;
  cursor:pointer;
}
.collab-avatar:hover { background:var(--accent); color:#fff; }
.collab-info { flex:1; min-width:0; cursor:pointer; }
.collab-info:hover .collab-name { color:var(--accent); }
.collab-name { font-weight:700; font-size:14px; }
.collab-meta { font-size:12px; color:var(--muted); margin-top:2px; }
.collab-actions { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
/* ENROLMENT LIST */
.enrol-list { display:grid; gap:8px; }
.enrol-item { background:var(--field); border:1px solid var(--fieldBorder); border-radius:var(--radius); padding:10px 14px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.enrol-info { flex:1; min-width:0; font-size:13px; }
.enrol-name { font-weight:700; font-size:14px; }
/* INLINE ACTION ROW (enrol/invite confirm) */
.inline-action {
  width:100%; border-top:1px solid var(--fieldBorder); padding-top:10px; margin-top:8px;
  display:flex; align-items:center; gap:8px; flex-wrap:wrap;
}
.inline-action select { width:auto; min-width:150px; font-size:13px; padding:6px 30px 6px 10px; }
/* ALERT BOXES */
.alert { padding:12px 14px; border-radius:var(--radius); font-size:14px; margin-bottom:12px; word-break:break-word; }
.alert-error   { background:#fee2e2; border:1px solid #fca5a5; color:#991b1b; }
.alert-success { background:var(--successSoft); border:1px solid #86efac; color:#166534; }
.alert-info    { background:var(--accentSoft); border:1px solid var(--accent2); color:var(--accent); }
.alert-warn    { background:var(--warnSoft); border:1px solid #fcd34d; color:#92400e; }
[data-theme="dark"] .alert-error   { color:#fca5a5; }
[data-theme="dark"] .alert-success { color:#86efac; }
[data-theme="dark"] .alert-warn    { color:#fbbf24; }
/* EMPTY */
.empty { text-align:center; padding:40px 20px; color:var(--muted); }
.empty svg { width:48px; height:48px; stroke:var(--muted); fill:none; stroke-width:1.5; margin:0 auto 12px; display:block; }
/* TABLE */
.table-wrap { width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:var(--radius); }
table { min-width:500px; width:100%; border-collapse:separate; border-spacing:0; border:1px solid var(--fieldBorder); border-radius:10px; overflow:hidden; background:var(--field); }
th,td { padding:9px 11px; border-bottom:1px solid var(--fieldBorder); vertical-align:middle; white-space:nowrap; font-size:13px; }
th { background:var(--tableHead); color:#0b1740; text-align:left; font-weight:700; }
[data-theme="dark"] th { color:#d9e3ff; }
tr:last-child td { border-bottom:0; }
/* LOG */
pre.log { background:#f7f9ff; color:#111827; border:1px solid var(--fieldBorder); border-radius:var(--radius); padding:10px; font-size:11px; max-height:260px; overflow:auto; white-space:pre-wrap; word-break:break-word; width:100%; }
[data-theme="dark"] pre.log { background:#070e1f; color:#c7dbff; }
/* SPINNER */
.spinner { display:inline-block; width:18px; height:18px; border:2px solid var(--fieldBorder); border-top-color:var(--accent); border-radius:50%; animation:spin .7s linear infinite; vertical-align:middle; }
@keyframes spin { to { transform:rotate(360deg); } }
/* LOG */
.log-wrap { margin-top:12px; }
pre.log { background:#f7f9ff; color:#111827; border:1px solid var(--fieldBorder); border-radius:var(--radius); padding:10px; font-size:11px; max-height:160px; overflow:auto; white-space:pre-wrap; word-break:break-word; width:100%; }
[data-theme="dark"] pre.log { background:#070e1f; color:#c7dbff; }
/* UTILITY */
.hidden { display:none !important; }
.mt8 { margin-top:8px; }
.mt16 { margin-top:16px; }
/* RESULT FEED */
.result-feed { display:grid; gap:8px; max-height:280px; overflow-y:auto; }
/* PAGINATION */
.pagination { display:flex; gap:6px; align-items:center; margin-top:12px; flex-wrap:wrap; }
.page-btn { padding:6px 12px; border-radius:8px; border:1px solid var(--border); background:var(--card); color:var(--text); font-size:13px; font-weight:600; cursor:pointer; min-height:34px; }
.page-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
.page-btn:disabled { opacity:.4; cursor:default; }
/* Cookie banner */
.cookie { position:fixed; left:50%; bottom:14px; transform:translateX(-50%); width:min(92vw,520px); background:rgba(255,255,255,.8); backdrop-filter:blur(14px); border:1px solid var(--border); box-shadow:var(--shadow); border-radius:14px; padding:14px; display:flex; align-items:center; gap:12px; z-index:40; color:#0f172a; }
[data-theme="dark"] .cookie { background:rgba(11,16,32,.85); color:#e5e7eb; }
.cookie.hide { transition:transform .35s,opacity .35s; transform:translate(-50%,130%); opacity:0; }
.cookie .msg { flex:1; font-size:14px; }
.cookie .btn { width:auto; min-width:64px; min-height:36px; }
/* DEBUG BANNER */
.debug-banner { background:#fef3c7; border:1px solid #f59e0b; border-radius:var(--radius); padding:8px 14px; font-size:13px; color:#92400e; margin:12px 16px 0; }
[data-theme="dark"] .debug-banner { background:#451a03; color:#fbbf24; border-color:#b45309; }
/* FAB (floating action button) */
.fab {
  position:fixed; bottom:24px; right:20px; z-index:20;
  width:56px; height:56px; border-radius:50%;
  background:linear-gradient(160deg,var(--accent),var(--accent2));
  color:#fff; font-size:28px; font-weight:300; line-height:1;
  display:flex; align-items:center; justify-content:center;
  text-decoration:none; box-shadow:0 4px 18px rgba(78,107,255,.45);
  transition:transform .15s,box-shadow .15s;
}
.fab:hover { transform:scale(1.1); box-shadow:0 6px 26px rgba(78,107,255,.6); }
/* COLLABORATOR DETAIL MODAL */
.modal-overlay {
  position:fixed; inset:0; z-index:100; background:rgba(0,0,0,.5);
  backdrop-filter:blur(4px); display:flex; align-items:center;
  justify-content:center; padding:16px;
}
.modal-card {
  background:var(--card); border-radius:var(--radius-lg); box-shadow:var(--shadow);
  max-width:520px; width:100%; max-height:85vh; overflow-y:auto;
}
.modal-header {
  padding:16px 18px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px;
}
.modal-header h2 { margin:0; font-size:17px; flex:1; }
.modal-close {
  background:none; border:none; font-size:22px; line-height:1;
  cursor:pointer; color:var(--muted); padding:2px 8px; border-radius:6px;
}
.modal-close:hover { background:var(--accentSoft); color:var(--text); }
.modal-body { padding:18px; }
.detail-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px 20px; }
@media(max-width:440px) { .detail-grid { grid-template-columns:1fr; } }
.detail-item label { margin:0 0 2px; font-size:12px; color:var(--muted); font-weight:600; }
.detail-item span { display:block; font-size:14px; font-weight:500; }
/* PWA install overlay */
.pwa-overlay {
  position:fixed; bottom:80px; left:50%; transform:translateX(-50%);
  z-index:50; width:min(92vw,480px);
  background:var(--card); border:1px solid var(--border);
  border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,.18);
  padding:16px; display:flex; align-items:center; gap:14px;
  animation:slideUp .3s ease;
}
@keyframes slideUp {
  from { transform:translateX(-50%) translateY(20px); opacity:0; }
  to   { transform:translateX(-50%) translateY(0); opacity:1; }
}
.pwa-overlay.hidden { display:none !important; }
.pwa-icon { border-radius:12px; flex-shrink:0; }
.pwa-text { flex:1; }
.pwa-text strong { display:block; font-weight:700; margin-bottom:2px; }
.pwa-text span { font-size:13px; color:var(--muted); }
.pwa-actions { display:flex; gap:8px; flex-shrink:0; flex-wrap:wrap; }
</style>
</head>
<body>

<!-- ACCENT STRIP -->
<div class="accent-strip"></div>

<!-- TOP BAR -->
<div class="topbar">
  <button class="icon-btn" id="hamburgerBtn" title="Menu" aria-label="Menu">
    <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
  <div class="brand">
    <img alt="Beeple" src="https://cdn.prod.website-files.com/64dc9a6f21257128d0afb983/65f86aca8cc32ec9836e8a29_beeple-textlogo.svg">
  </div>
  <div class="title">Planning</div>
  <div style="width:36px;flex-shrink:0;"></div>
</div>

<!-- NAV MENU -->
<nav id="navMenu" class="nav-menu" aria-label="Main navigation">
  <a href="create.html" class="nav-item">Quick team creation</a>
  <a href="planning.html" class="nav-item active">Planning</a>
  <button id="navInvitationsBtn" class="nav-item">üìã Pending invitations</button>
  <button id="themeBtn" class="nav-item">Dark mode</button>
  <button id="debugToggleBtn" class="nav-item">Debug mode</button>
  <button id="pwaMenuBtn" class="nav-item hidden">Install as app</button>
  <button id="logoutBtn" class="nav-item danger">Log out</button>
</nav>
<div id="navOverlay" class="nav-overlay"></div>

<!-- Debug banner -->
<div id="debugBanner" class="debug-banner hidden">Debug mode active ‚Äî full API responses shown in logs.</div>

<!-- PWA install overlay -->
<div id="pwaOverlay" class="pwa-overlay hidden" role="dialog" aria-label="Install app">
  <img src="icon.svg" width="52" height="52" class="pwa-icon" alt="">
  <div class="pwa-text">
    <strong>Install TeamWizard</strong>
    <span>Add to home screen for quick access</span>
  </div>
  <div class="pwa-actions">
    <button id="pwaInstallBtn" class="btn primary btn-sm">Install</button>
    <button id="pwaDismissBtn" class="btn secondary btn-sm">Not now</button>
  </div>
</div>

<!-- Collaborator detail modal -->
<div id="collabModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-label="Collaborator details">
  <div class="modal-card">
    <div class="modal-header">
      <div id="collabModalAvatar" class="collab-avatar" style="width:44px;height:44px;font-size:16px;cursor:default;flex-shrink:0;"></div>
      <h2 id="collabModalName"></h2>
      <button class="modal-close" id="collabModalClose" aria-label="Close">√ó</button>
    </div>
    <div class="modal-body" id="collabModalBody">
      <div class="empty"><div class="spinner"></div><p>Loading‚Ä¶</p></div>
    </div>
  </div>
</div>

<!-- MAIN -->
<main class="main" id="main">

  <!-- LOADING STATE -->
  <div id="viewLoading">
    <div class="empty"><div class="spinner"></div><p>Loading projects‚Ä¶</p></div>
  </div>

  <!-- PROJECT LIST VIEW -->
  <div id="viewProjects" class="hidden">
    <h1 class="section-title">All Projects</h1>
    <div class="proj-search">
      <input id="projSearch" type="search" placeholder="Filter projects‚Ä¶" autocomplete="off">
    </div>
    <div id="projectGrid" class="card-grid"></div>
  </div>

  <!-- PENDING INVITATIONS VIEW -->
  <div id="viewInvitations" class="hidden">
    <div class="breadcrumb" id="breadcrumbInv"></div>
    <h1 class="section-title">Pending Invitations</h1>
    <p class="section-sub">Invitations sent to collaborators that are still waiting for acceptance.</p>
    <div style="margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
      <div style="flex:1;min-width:200px;">
        <label style="margin-bottom:6px;">Project</label>
        <select id="invProjectSelect" style="font-size:14px;"></select>
      </div>
      <button id="loadInvitationsBtn" class="btn primary btn-sm">Load invitations</button>
      <button id="invBackBtn" class="btn secondary btn-sm">‚Üê Back to projects</button>
    </div>
    <div id="invitationsFeed">
      <div class="empty"><p>Select a project and click "Load invitations".</p></div>
    </div>
  </div>

  <!-- SUBPROJECT / TEAMS VIEW -->
  <div id="viewProject" class="hidden">
    <div class="breadcrumb" id="breadcrumb"></div>
    <h1 class="section-title" id="viewProjectTitle"></h1>
    <p class="section-sub" id="viewProjectSub"></p>
    <!-- Name filter for subprojects/teams grid -->
    <div class="proj-search" id="gridSearchBar">
      <input id="gridSearch" type="search" placeholder="Filter‚Ä¶" autocomplete="off">
    </div>
    <!-- Date bar: only shown when listing teams (not subprojects) -->
    <div id="teamDateBar" class="hidden" style="display:none;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:16px;">
      <input id="teamDateFrom" type="date" style="font-size:13px;padding:6px 10px;width:auto;">
      <span style="font-size:13px;color:var(--muted);">‚Üí</span>
      <input id="teamDateTo" type="date" style="font-size:13px;padding:6px 10px;width:auto;">
    </div>
    <div id="subprojectGrid" class="card-grid"></div>
  </div>

  <!-- TEAM DETAIL VIEW -->
  <div id="viewTeam" class="hidden">
    <div class="breadcrumb" id="breadcrumbTeam"></div>

    <!-- Team header -->
    <div class="team-header-card">
      <div style="display:flex;align-items:flex-start;gap:12px;flex-wrap:wrap;">
        <div style="flex:1;min-width:0;">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <h2 id="teamTitle" style="margin:0;"></h2>
            <span id="teamChips"></span>
          </div>
          <div style="font-size:13px;color:var(--muted);margin-top:4px;" id="teamMeta"></div>
        </div>
      </div>
    </div>

    <!-- Enrolments card -->
    <div class="sec-card">
      <h3>Enrolments</h3>
      <div id="enrolmentsFeed">
        <div class="empty"><div class="spinner"></div><p>Loading‚Ä¶</p></div>
      </div>
    </div>

    <!-- Find & add collaborators card -->
    <div class="sec-card">
      <h3>Find &amp; add collaborator</h3>

      <!-- Filters -->
      <div class="filters">
        <h4>Filter collaborators</h4>
        <div class="filter-grid">
          <div>
            <label>Name search</label>
            <input id="fSearch" type="search" placeholder="John‚Ä¶" autocomplete="off">
          </div>
          <div>
            <label>Function</label>
            <select id="fFunction">
              <option value="">All functions</option>
            </select>
          </div>
          <div>
            <label>Language</label>
            <select id="fLanguage">
              <option value="">Any language</option>
              <option value="nl">Dutch</option>
              <option value="fr">French</option>
              <option value="en">English</option>
              <option value="de">German</option>
            </select>
          </div>
          <div>
            <label>Show archived</label>
            <select id="fArchived">
              <option value="false">Active only</option>
              <option value="true">Include archived</option>
            </select>
          </div>
          <div>
            <label>Show blocked</label>
            <select id="fBlocked">
              <option value="false">Not blocked</option>
              <option value="true">Include blocked</option>
            </select>
          </div>
          <div>
            <label>Min age</label>
            <input id="fMinAge" type="number" inputmode="numeric" min="16" max="99" placeholder="Any">
          </div>
        </div>
        <div class="btn-row">
          <button id="searchCollabBtn" class="btn primary btn-sm">Search</button>
          <button id="clearFiltersBtn" class="btn secondary btn-sm">Clear</button>
        </div>
      </div>

      <!-- Contract type selector ‚Äî applies to all enrol/invite actions -->
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px;">
        <label style="margin:0;font-size:13px;font-weight:600;color:var(--muted);white-space:nowrap;">Contract type</label>
        <select id="globalContractType" style="width:auto;min-width:170px;font-size:14px;padding:7px 32px 7px 10px;">
          <option value="">(select)</option>
          <option value="interim">Interim</option>
          <option value="intern">Intern</option>
          <option value="contractual">Contractual</option>
          <option value="freelancer">Freelancer</option>
          <option value="collaborator">Collaborator</option>
          <option value="volunteer">Volunteer</option>
        </select>
      </div>

      <!-- Results -->
      <div id="collabResults"></div>
      <div id="collabPagination" class="pagination"></div>

      <!-- Result log -->
      <div id="enrolResults" class="result-feed mt16"></div>
    </div>

    <!-- Debug log (shown only when debug=Y) -->
    <div id="debugLogWrap" class="log-wrap hidden">
      <h4 style="margin:16px 0 4px;font-size:13px;color:var(--muted);">Debug log</h4>
      <pre class="log" id="debugLog"></pre>
    </div>

  </div><!-- viewTeam -->

</main>

<!-- Floating action button ‚Äî links to create.html for current project -->
<a id="fabBtn" href="create.html" class="fab hidden" title="Create team for this project">+</a>

<!-- COOKIE BANNER -->
<div id="cookie" class="cookie hidden">
  <div class="msg">This page uses cookies for a better experience.</div>
  <div><button id="cookieOk" class="btn secondary">OK</button></div>
</div>

<script>
/* ================================================================
   CONFIG
   ================================================================ */
const PROXY_URL  = "https://coraligo.com/team-wizard/proxy.php";
const debugParam = new URLSearchParams(location.search).get("debug");
let DEBUG        = debugParam === "1" || debugParam === "Y" || debugParam === "y";

/* ================================================================
   AUTH
   ================================================================ */
const BASE  = localStorage.getItem("bwBase")   || "";
const TOKEN = sessionStorage.getItem("bwToken") || "";
if(!BASE || !TOKEN){ window.location.replace("index.html"); }

/* ================================================================
   THEME
   ================================================================ */
function syncTheme(){
  const dark = document.documentElement.getAttribute("data-theme") === "dark";
  document.getElementById("themeBtn").textContent = dark ? "Light mode" : "Dark mode";
}
document.getElementById("themeBtn").addEventListener("click", () => {
  const next = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem("theme", next);
  syncTheme();
});

/* ================================================================
   NAV MENU
   ================================================================ */
const navMenu    = document.getElementById("navMenu");
const navOverlay = document.getElementById("navOverlay");
document.getElementById("hamburgerBtn").addEventListener("click", () => {
  navMenu.classList.toggle("open");
  navOverlay.classList.toggle("show");
});
navOverlay.addEventListener("click", () => {
  navMenu.classList.remove("open");
  navOverlay.classList.remove("show");
});
document.getElementById("logoutBtn").addEventListener("click", () => {
  sessionStorage.removeItem("bwToken");
  window.location.replace("index.html");
});

/* ================================================================
   DEBUG TOGGLE
   ================================================================ */
function syncDebug(){
  document.getElementById("debugBanner").classList.toggle("hidden", !DEBUG);
  document.getElementById("debugToggleBtn").textContent = DEBUG ? "Debug mode (on)" : "Debug mode";
}
document.getElementById("debugToggleBtn").addEventListener("click", () => {
  DEBUG = !DEBUG;
  syncDebug();
  navMenu.classList.remove("open"); navOverlay.classList.remove("show");
});

/* ================================================================
   PWA INSTALL
   ================================================================ */
let pwaPrompt = null;
window.addEventListener("beforeinstallprompt", e => {
  e.preventDefault();
  pwaPrompt = e;
  document.getElementById("pwaMenuBtn").classList.remove("hidden");
});
window.addEventListener("appinstalled", () => {
  pwaPrompt = null;
  document.getElementById("pwaMenuBtn").classList.add("hidden");
  document.getElementById("pwaOverlay").classList.add("hidden");
  localStorage.setItem("pwa_installed", "1");
});
function triggerPwaInstall(){
  if(!pwaPrompt) return;
  pwaPrompt.prompt();
  pwaPrompt.userChoice.then(() => { pwaPrompt = null; });
}
document.getElementById("pwaMenuBtn").addEventListener("click", () => {
  triggerPwaInstall();
  navMenu.classList.remove("open"); navOverlay.classList.remove("show");
});
document.getElementById("pwaInstallBtn").addEventListener("click", () => { triggerPwaInstall(); });
document.getElementById("pwaDismissBtn").addEventListener("click", () => {
  document.getElementById("pwaOverlay").classList.add("hidden");
  localStorage.setItem("pwa_install_dismissed", "1");
});
// Show overlay after 5 s (once)
setTimeout(() => {
  if(pwaPrompt && !localStorage.getItem("pwa_installed") && !localStorage.getItem("pwa_install_dismissed")){
    document.getElementById("pwaOverlay").classList.remove("hidden");
  }
}, 5000);

/* ================================================================
   SERVICE WORKER
   ================================================================ */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").catch(() => {});
}

/* ================================================================
   COOKIE HELPERS
   ================================================================ */
function setCookie(k,v,days=365){ const e=new Date(Date.now()+days*864e5).toUTCString(); document.cookie=`${k}=${encodeURIComponent(v)};expires=${e};path=/;SameSite=Lax`; }
function getCookie(k){ return document.cookie.split("; ").reduce((r,v)=>{ const[n,...rest]=v.split("="); return n===k?decodeURIComponent(rest.join("=")):r; },""); }

/* ================================================================
   STATE
   ================================================================ */
const state = {
  projects:           [],
  functions:          [],
  selectedProject:    null,
  selectedSubproject: null,
  selectedTeam:       null,
  collabPage:         1,
  collabTotal:        0,
  departmentId:       null
};

/* ================================================================
   UTILS
   ================================================================ */
function escHtml(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":'&#39;'}[m])); }

function parseApiErrors(json){
  if(!json) return "Unknown error.";
  if(json.errors){
    if(Array.isArray(json.errors) && json.errors.length===0) return null;
    const errs = json.errors;
    if(typeof errs === "object" && !Array.isArray(errs)){
      return Object.entries(errs).map(([k,v]) => {
        const msgs = Array.isArray(v) ? v.join(", ") : String(v);
        return k === "base" ? msgs : `<b>${escHtml(k)}</b>: ${escHtml(msgs)}`;
      }).join("<br>");
    }
    if(Array.isArray(errs)) return errs.map(e => escHtml(String(e))).join("<br>");
  }
  if(json.error) return escHtml(json.error);
  return null;
}

function initials(fn,ln){ return ((fn||"").charAt(0)+(ln||"").charAt(0)).toUpperCase()||"?"; }
function fmtDate(d){ if(!d)return"‚Äî"; return new Date(d).toLocaleDateString(undefined,{day:"2-digit",month:"short",year:"numeric"}); }

function fmtShift(team){
  if(!team) return "‚Äî";
  if(team.shifts && team.shifts.length){
    const s = team.shifts[0];
    const start = s.start_datetime ? new Date(s.start_datetime) : null;
    const end   = s.end_datetime   ? new Date(s.end_datetime)   : null;
    if(start && end){
      return start.toLocaleDateString(undefined,{day:"2-digit",month:"short"})+" "+
             start.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"})+" ‚Äì "+
             end.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"});
    }
  }
  return "‚Äî";
}

function showView(id){
  ["viewLoading","viewProjects","viewProject","viewTeam","viewInvitations"].forEach(v => {
    document.getElementById(v).classList.toggle("hidden", v!==id);
  });
  // Hide FAB unless shown explicitly by caller
  if(id !== "viewProject" && id !== "viewTeam"){
    document.getElementById("fabBtn").classList.add("hidden");
  }
}

function dLog(...args){
  if(!DEBUG) return;
  const el = document.getElementById("debugLog");
  if(el) el.textContent += args.join(" ") + "\n";
}

/* HTTP VIA PROXY */
function proxyUrl(path, extra=""){
  return `${PROXY_URL}?base=${encodeURIComponent(BASE)}&path=${encodeURIComponent(path)}${extra}${DEBUG?"&debug=1":""}`;
}

async function apiGET(path, queryObj){
  let qs = "";
  if(queryObj){
    const params = Object.entries(queryObj)
      .filter(([,v])=>v!==""&&v!==null&&v!==undefined)
      .map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&");
    if(params) qs = "&"+params;
  }
  dLog("GET", path, qs);
  const res = await fetch(proxyUrl(path) + qs, { headers:{"X-Beeple-Token": TOKEN} });
  const txt = await res.text();
  if(DEBUG) dLog("<-", res.status, txt.slice(0,500));
  let json = {};
  try{ json = JSON.parse(txt); }catch{}
  if(!res.ok){
    const msg = parseApiErrors(json) || ("HTTP " + res.status);
    throw new Error(msg + (DEBUG ? ` [${txt.slice(0,300)}]` : ""));
  }
  if(DEBUG) dlog(`  body: ${txt.slice(0,300)}${txt.length>300?"‚Ä¶":""}`);
  return json;
}

async function apiPOST(path, payload){
  dLog("POST", path, JSON.stringify(payload).slice(0,200));
  const res = await fetch(proxyUrl(path), {
    method:"POST", headers:{"X-Beeple-Token":TOKEN,"Content-Type":"application/json"}, body
  });
  const txt = await res.text();
  if(DEBUG) dLog("<-", res.status, txt.slice(0,500));
  let json = {};
  try { json = JSON.parse(txt); } catch {}
  const apiErr = parseApiErrors(json);
  if(!res.ok || (apiErr && apiErr.length)){
    throw new Error((apiErr || "HTTP " + res.status) + (DEBUG ? ` [${txt.slice(0,300)}]` : ""));
  }
  return json;
}

async function apiDELETEorPOST(method, path, payload){
  dLog(method, path);
  const res = await fetch(proxyUrl(path), {
    method, headers:{"X-Beeple-Token": TOKEN, "Content-Type":"application/json"},
    body: payload ? JSON.stringify(payload) : undefined
  });
  const txt = await res.text();
  if(DEBUG) dLog("<-", res.status, txt.slice(0,500));
  let json = {};
  try { json = JSON.parse(txt); } catch {}
  const apiErr = parseApiErrors(json);
  if(!res.ok || (apiErr && apiErr.length)){
    throw new Error((apiErr || "HTTP " + res.status) + (DEBUG ? ` [${txt.slice(0,300)}]` : ""));
  }
  return json;
}

/* ALERT / RESULT HELPERS */
function makeAlert(type, html){
  const d = document.createElement("div");
  d.className = `alert alert-${type}`; d.innerHTML = html; return d;
}
function appendResult(container, type, html){
  const el = makeAlert(type, html);
  container.prepend(el);
  while(container.children.length > 20) container.lastChild.remove();
}

/* ================================================================
   HISTORY / BACK-BUTTON NAVIGATION
   ================================================================ */
function pushNav(state_obj){
  history.pushState(state_obj, "", location.pathname + (state_obj.search || ""));
}

window.addEventListener("popstate", e => {
  const s = e.state;
  if(!s || s.view === "projects"){
    showView("viewProjects");
    return;
  }
  if(s.view === "project" && s.project){
    selectProject(s.project, true);
    return;
  }
  if(s.view === "subproject" && s.subproject){
    state.selectedProject = s.project;
    selectSubproject(s.subproject, true);
    return;
  }
  if(s.view === "team" && s.team){
    state.selectedProject    = s.project;
    state.selectedSubproject = s.subproject || null;
    selectTeam(s.team, true);
    return;
  }
  showView("viewProjects");
});

/* ================================================================
   LOAD PROJECTS
   ================================================================ */
async function loadProjects(){
  showView("viewLoading");
  try {
    const data = await apiGET("api/v1/admin/projects");
    state.projects = data.projects || [];
    renderProjectGrid(state.projects);
    showView("viewProjects");
  } catch(e) {
    showView("viewProjects");
    document.getElementById("projectGrid").innerHTML =
      makeAlert("error", `<b>Could not load projects:</b> ${escHtml(e.message)}`).outerHTML +
      `<p>Check your connection settings. <a href="index.html">Log in again ‚Üí</a></p>`;
  }
}

function renderProjectGrid(projects){
  const grid = document.getElementById("projectGrid");
  grid.innerHTML = "";
  if(!projects.length){
    grid.innerHTML = `<div class="empty"><p>No projects found.</p></div>`;
    return;
  }
  projects.forEach(p => {
    const color = p.color_code || "#4e6bff";
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <span style="background:${escHtml(color)};width:14px;height:14px;border-radius:3px;flex-shrink:0;display:inline-block;"></span>
        <h3 style="margin:0;">${escHtml(p.name)}</h3>
      </div>
      <div class="meta">
        <span title="Date">üìÖ ${fmtDate(p.start_date)} ‚Äì ${fmtDate(p.end_date)}</span><br>
        ${p.department ? `<span title="Department">üè¢ ${escHtml(p.department.name)}</span>` : ""}
        ${p.customer   ? `<span title="Client">üë§ ${escHtml(p.customer.name)}</span>`   : ""}
      </div>
      <div style="margin-top:8px;">
        <span class="chip chip-${p.published?"green":"grey"}">${p.published?"Published":"Draft"}</span>
        <span class="chip chip-blue">${p.registrations_count||0}/${p.volunteers_needed||0} enrolled</span>
        ${p.subprojects_enabled?'<span class="chip chip-yellow">Subprojects</span>':""}
      </div>`;
    el.addEventListener("click",()=>selectProject(p));
    grid.appendChild(el);
  });
}

/* ================================================================
   PROJECT SEARCH FILTER
   ================================================================ */
document.getElementById("projSearch").addEventListener("input", function(){
  const q = this.value.toLowerCase();
  document.querySelectorAll("#projectGrid .card").forEach(el => {
    el.style.display = el.textContent.toLowerCase().includes(q) ? "" : "none";
  });
});

/* ================================================================
   SELECT PROJECT
   ================================================================ */
async function selectProject(project, noPush){
  state.selectedProject    = project;
  state.selectedSubproject = null;
  state.selectedTeam       = null;
  state.departmentId       = project.department ? project.department.id : null;

  if(!noPush) pushNav({ view:"project", project, search:"?view=project&id="+project.id });

  showView("viewProject");

  const title = document.getElementById("viewProjectTitle");
  const sub   = document.getElementById("viewProjectSub");
  const grid  = document.getElementById("subprojectGrid");
  title.textContent = project.name;
  grid.innerHTML = `<div class="empty"><div class="spinner"></div><p>Loading‚Ä¶</p></div>`;

  setBreadcrumb("viewProject", [
    { label:"Projects", action: () => { showView("viewProjects"); history.pushState({view:"projects"}, ""); } },
    { label: project.name }
  ]);
  try{
    if(project.subprojects_enabled){
      // Subprojects view ‚Äî no date bar
      hideDateBar();
      document.getElementById("fabBtn").classList.add("hidden");
      sub.textContent = "Select a subproject to see its teams.";
      const data = await apiGET(`api/v1/admin/projects/${project.id}/subprojects`);
      const subs = data.subprojects||[];
      if(!subs.length){ grid.innerHTML=`<div class="empty"><p>No subprojects found.</p></div>`; return; }
      grid.innerHTML = "";
      subs.forEach(s => {
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <h3>${escHtml(s.name)}</h3>
          <div class="meta">
            <span title="Date">üìÖ ${fmtDate(s.start_date)} ‚Äì ${fmtDate(s.end_date)}</span>
          </div>
          <div style="margin-top:8px;">
            <span class="chip chip-blue">${s.registrations_count||0}/${s.volunteers_needed||0}</span>
          </div>`;
        el.addEventListener("click", () => selectSubproject(s));
        grid.appendChild(el);
      });
    } else {
      // Direct teams view ‚Äî show date bar + FAB
      initDateBar();
      sub.textContent = "All teams in this project:";
      showFab(project.id, null);
      await loadTeamsIntoGrid(grid, project.id, null);
    }
  }catch(e){ grid.innerHTML=`<div class="alert alert-error">Error loading: ${escHtml(e.message)}</div>`; }
}

/* ================================================================
   SELECT SUBPROJECT
   ================================================================ */
async function selectSubproject(sub, noPush){
  state.selectedSubproject = sub;
  state.selectedTeam       = null;

  if(!noPush) pushNav({ view:"subproject", project:state.selectedProject, subproject:sub, search:"?view=subproject&id="+sub.id });

  showView("viewProject");
  initDateBar();

  const project  = state.selectedProject;
  const title    = document.getElementById("viewProjectTitle");
  const subtitle = document.getElementById("viewProjectSub");
  const grid     = document.getElementById("subprojectGrid");

  title.textContent    = sub.name;
  subtitle.textContent = "";
  grid.innerHTML = `<div class="empty"><div class="spinner"></div><p>Loading teams‚Ä¶</p></div>`;

  setBreadcrumb("viewProject", [
    { label:"Projects",    action: () => { showView("viewProjects"); history.pushState({view:"projects"}, ""); } },
    { label: project.name, action: () => selectProject(project) },
    { label: sub.name }
  ]);

  showFab(project.id, sub.id);

  try {
    await loadTeamsIntoGrid(grid, project.id, sub.id);
  } catch(e) {
    grid.innerHTML = `<div class="alert alert-error">Error loading teams: ${escHtml(e.message)}</div>`;
  }
}

/* ================================================================
   FAB ‚Äî floating action button linking to create page
   ================================================================ */
function showFab(projectId, subprojectId){
  const fab = document.getElementById("fabBtn");
  let url = `create.html?project=${encodeURIComponent(projectId)}`;
  if(subprojectId) url += `&subproject=${encodeURIComponent(subprojectId)}`;
  fab.href = url;
  fab.classList.remove("hidden");
}

function hideDateBar(){
  const bar = document.getElementById("teamDateBar");
  bar.style.display = "none";
  bar.classList.add("hidden");
}

/* ================================================================
   DATE BAR
   ================================================================ */
function isoDate(d){ return d.toISOString().slice(0,10); }
function defaultDateFrom(){ const d=new Date(); d.setDate(d.getDate()-7); return isoDate(d); }
function defaultDateTo(){ const d=new Date(); d.setMonth(d.getMonth()+1); return isoDate(d); }

let _dateBarInited = false;
function initDateBar(){
  const bar  = document.getElementById("teamDateBar");
  const from = document.getElementById("teamDateFrom");
  const to   = document.getElementById("teamDateTo");
  if(!from.value) from.value = defaultDateFrom();
  if(!to.value)   to.value   = defaultDateTo();
  bar.style.display = "flex";
  bar.classList.remove("hidden");
  if(_dateBarInited) return;
  _dateBarInited = true;
  from.addEventListener("change", () => reloadCurrentTeamGrid());
  to.addEventListener("change",   () => reloadCurrentTeamGrid());
}
function reloadCurrentTeamGrid(){
  const grid=document.getElementById("subprojectGrid");
  const p=state.selectedProject; const s=state.selectedSubproject;
  if(!p) return;
  grid.innerHTML=`<div class="empty"><div class="spinner"></div><p>Loading‚Ä¶</p></div>`;
  loadTeamsIntoGrid(grid,p.id,s?s.id:null).catch(e=>{
    grid.innerHTML=`<div class="alert alert-error">Error: ${escHtml(e.message)}</div>`;
  });
}

async function loadTeamsIntoGrid(grid, projectId, subprojectId){
  const path = subprojectId
    ? `api/v1/admin/subprojects/${subprojectId}/teams`
    : `api/v1/admin/projects/${projectId}/teams`;
  const fromVal = document.getElementById("teamDateFrom").value || defaultDateFrom();
  const toVal   = document.getElementById("teamDateTo").value   || defaultDateTo();
  const data  = await apiGET(path, { start_date: fromVal, end_date: toVal });
  const teams = data.teams || [];
  if(!teams.length){
    grid.innerHTML = `<div class="empty"><p>No teams found in the selected date range.</p></div>`;
    return;
  }
  grid.innerHTML = "";
  teams.forEach(t => {
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <h3>${escHtml(t.name||"(auto-named)")}</h3>
      <div class="meta">
        <div title="Shift">üìÖ ${fmtShift(t)}</div>
        <div style="margin-top:4px;">
          <span class="chip chip-${t.published?"green":"grey"}">${t.published?"Published":"Draft"}</span>
          <span class="chip chip-blue">${t.registrations_count||0}/${t.volunteers_needed||0} filled</span>
        </div>
        ${t.function ? `<div style="margin-top:4px;" title="Function">‚öô ${escHtml(t.function.name)}</div>` : ""}
        ${t.address  ? `<div title="Location">üìç ${escHtml(t.address.name||t.address.city||"")}</div>` : ""}
      </div>`;
    el.addEventListener("click",()=>selectTeam(t)); grid.appendChild(el);
  });
}

/* ================================================================
   SELECT TEAM
   ================================================================ */
async function selectTeam(team, noPush){
  state.selectedTeam = team;

  if(!noPush) pushNav({
    view:"team", team,
    project: state.selectedProject,
    subproject: state.selectedSubproject,
    search:"?view=team&id="+team.id
  });

  showView("viewTeam");
  document.getElementById("fabBtn").classList.add("hidden");

  document.getElementById("debugLogWrap").classList.toggle("hidden", !DEBUG);
  if(DEBUG) document.getElementById("debugLog").textContent = "";

  const project = state.selectedProject;
  const sub     = state.selectedSubproject;

  const crumbs = [
    { label:"Projects", action: () => { showView("viewProjects"); history.pushState({view:"projects"}, ""); } },
    { label: project.name, action: () => selectProject(project) }
  ];
  if(sub) crumbs.push({ label: sub.name, action: () => selectSubproject(sub) });
  crumbs.push({ label: team.name || "(team)" });
  setBreadcrumb("viewTeam", crumbs);

  document.getElementById("teamTitle").textContent = team.name || "(auto-named)";
  document.getElementById("teamChips").innerHTML =
    `<span class="chip chip-${team.published?"green":"grey"}">${team.published?"Published":"Draft"}</span>
     <span class="chip chip-blue">${team.registrations_count||0}/${team.volunteers_needed||0} filled</span>`;
  document.getElementById("teamMeta").innerHTML =
    [fmtShift(team),
     team.function ? `<span title="Function">‚öô ${escHtml(team.function.name)}</span>` : "",
     team.address  ? `<span title="Location">üìç ${escHtml(team.address.name||team.address.city||"")}</span>` : ""
    ].filter(Boolean).join(" &nbsp;¬∑&nbsp; ");

  document.getElementById("enrolResults").innerHTML  = "";
  document.getElementById("collabResults").innerHTML = "";
  document.getElementById("collabPagination").innerHTML = "";

  loadEnrolments(team.id);
}

/* ================================================================
   LOAD ENROLMENTS
   ================================================================ */
async function loadEnrolments(teamId){
  const feed = document.getElementById("enrolmentsFeed");
  feed.innerHTML = `<div class="empty"><div class="spinner"></div><p>Loading enrolments‚Ä¶</p></div>`;
  try {
    const data   = await apiGET(`api/v1/admin/teams/${teamId}/enrolments`);
    const enrols = data.enrolments || [];
    if(!enrols.length){
      feed.innerHTML = `<div class="empty"><p>No enrolments yet for this team.</p></div>`;
      return;
    }
    feed.innerHTML = `<div class="enrol-list" id="enrolListInner"></div>`;
    const list = document.getElementById("enrolListInner");
    enrols.forEach(e => {
      const c   = e.collaborator || e.volunteer || {};
      const row = document.createElement("div");
      row.className = "enrol-item";
      row.dataset.enrolId = e.id;
      row.innerHTML = `
        <div class="collab-avatar" style="cursor:pointer;" title="View details" data-view-collab="${escHtml(String(c.id||""))}">${escHtml(initials(c.first_name,c.last_name))}</div>
        <div class="enrol-info" style="cursor:pointer;" data-view-collab="${escHtml(String(c.id||""))}">
          <div class="enrol-name">${escHtml(c.first_name||"")} ${escHtml(c.last_name||"")}</div>
          <div style="font-size:12px;color:var(--muted);">
            ${e.contract_type?`<span class="chip chip-grey">${escHtml(e.contract_type)}</span>`:""}
            ${e.confirmed?'<span class="chip chip-green">Confirmed</span>':'<span class="chip chip-yellow">Unconfirmed</span>'}
            ${e.cancelled?'<span class="chip chip-red">Cancelled</span>':""}
            ${c.email?`<span>${escHtml(c.email)}</span>`:""}
          </div>
        </div>
        <div><button class="btn btn-sm btn-danger" data-cancel-enrol="${escHtml(String(e.id))}">Cancel</button></div>`;
      list.appendChild(row);
    });
  }catch(ex){
    feed.innerHTML=`<div class="alert alert-error"><b>Could not load enrolments:</b> ${escHtml(ex.message)}</div>`;
  }
}

/* ================================================================
   CANCEL ENROLMENT
   ================================================================ */
document.addEventListener("click", async function(ev){
  const btn=ev.target.closest("[data-cancel-enrol]"); if(!btn) return;
  const enrolId=btn.dataset.cancelEnrol;
  if(!confirm("Cancel this enrolment?")) return;
  btn.disabled = true; btn.textContent = "‚Ä¶";
  try {
    await apiDELETEorPOST("POST", `api/v1/admin/enrolments/${enrolId}/cancel`, {});
    const row = btn.closest(".enrol-item");
    if(row){
      row.style.opacity = ".4";
      row.querySelectorAll("button").forEach(b => b.disabled = true);
      row.querySelector(".enrol-info").innerHTML += '<span class="chip chip-red" style="margin-left:6px;">Cancelled</span>';
    }
    btn.textContent = "Cancelled";
  } catch(e) {
    btn.disabled = false; btn.textContent = "Cancel";
    alert("Cancel failed: " + e.message);
  }
});

/* ================================================================
   SEARCH COLLABORATORS
   ================================================================ */
async function searchCollaborators(page){
  page = page || 1;
  state.collabPage = page;

  const container = document.getElementById("collabResults");
  const pagDiv    = document.getElementById("collabPagination");
  container.innerHTML = `<div class="empty"><div class="spinner"></div><p>Searching‚Ä¶</p></div>`;
  pagDiv.innerHTML = "";

  const searchVal = document.getElementById("fSearch").value.trim();
  const query = {
    q:             searchVal   || undefined,
    function_id:   document.getElementById("fFunction").value  || undefined,
    language:      document.getElementById("fLanguage").value  || undefined,
    archived:      document.getElementById("fArchived").value === "true" ? true : undefined,
    blocked:       document.getElementById("fBlocked").value  === "true" ? true : undefined,
    minimum_age:   document.getElementById("fMinAge").value    || undefined,
    department_id: state.departmentId                          || undefined,
    page
  };
  Object.keys(query).forEach(k => query[k]===undefined && delete query[k]);

  try {
    const data    = await apiGET("api/v1/admin/collaborators", query);
    const collabs = data.volunteers || data.collaborators || [];
    const meta    = data.meta || {};
    state.collabTotal = meta.total_count || collabs.length;
    const perPage = meta.per_page || 20;

    if(!collabs.length){
      container.innerHTML = `<div class="empty"><p>No collaborators found.</p></div>`;
      return;
    }

    container.innerHTML = "";
    const list = document.createElement("div");
    list.className = "collab-list";
    collabs.forEach(c => {
      const card = document.createElement("div");
      card.className = "collab-card";
      card.innerHTML = `
        <div class="collab-avatar" data-view-collab="${escHtml(String(c.id))}" title="View details">${escHtml(initials(c.first_name,c.last_name))}</div>
        <div class="collab-info" data-view-collab="${escHtml(String(c.id))}">
          <div class="collab-name">${escHtml(c.first_name||"")} ${escHtml(c.last_name||"")}</div>
          <div class="collab-meta">
            ${c.email    ? escHtml(c.email) : ""}
            ${c.function ? " ¬∑ <span title='Function'>‚öô " + escHtml(c.function.name) + "</span>" : ""}
            ${c.language ? " ¬∑ " + escHtml(c.language.toUpperCase()) : ""}
            ${c.blocked  ? ' <span class="chip chip-red">Blocked</span>' : ""}
            ${c.archived ? ' <span class="chip chip-grey">Archived</span>' : ""}
          </div>
        </div>
        <div class="collab-actions">
          <button class="btn primary btn-sm"
                  data-enrol-id="${escHtml(String(c.id))}"
                  data-enrol-name="${escHtml((c.first_name||"")+" "+(c.last_name||""))}">Enrol</button>
          <button class="btn btn-success btn-sm"
                  data-invite-id="${escHtml(String(c.id))}"
                  data-invite-name="${escHtml((c.first_name||"")+" "+(c.last_name||""))}">Invite</button>
        </div>`;
      list.appendChild(card);
    });
    container.appendChild(list);

    const totalPages = Math.ceil(state.collabTotal / perPage);
    if(totalPages > 1) renderPagination(pagDiv, page, totalPages, searchCollaborators);

  } catch(e) {
    container.innerHTML = `<div class="alert alert-error"><b>Search failed:</b> ${escHtml(e.message)}</div>`;
  }
}

document.getElementById("searchCollabBtn").addEventListener("click", () => searchCollaborators(1));
document.getElementById("fSearch").addEventListener("keydown", e => { if(e.key==="Enter") searchCollaborators(1); });
document.getElementById("clearFiltersBtn").addEventListener("click", () => {
  ["fSearch","fMinAge"].forEach(id => document.getElementById(id).value = "");
  ["fFunction","fLanguage","fArchived","fBlocked"].forEach(id => document.getElementById(id).selectedIndex = 0);
  document.getElementById("collabResults").innerHTML    = "";
  document.getElementById("collabPagination").innerHTML = "";
});

/* ================================================================
   ENROL / INVITE (buttons on each collaborator card)
   ================================================================ */
document.addEventListener("click", async function(ev){
  const enrolBtn  = ev.target.closest("[data-enrol-id]");
  const inviteBtn = ev.target.closest("[data-invite-id]");
  if(!enrolBtn && !inviteBtn) return;

  const isInvite   = !!inviteBtn;
  const btn        = isInvite ? inviteBtn : enrolBtn;
  const collabId   = btn.dataset[isInvite ? "inviteId"   : "enrolId"];
  const collabName = btn.dataset[isInvite ? "inviteName" : "enrolName"];

  if(!state.selectedTeam){ alert("No team selected."); return; }

  const contractType = document.getElementById("globalContractType").value;
  if(!contractType){ alert("Please select a contract type above before enrolling or inviting."); return; }

  const log = document.getElementById("enrolResults");
  btn.disabled = true; btn.textContent = "‚Ä¶";

  try {
    const res = await apiPOST(`api/v1/admin/collaborators/enrolments`, {
      team_registration: {
        collaborator_id: collabId,
        team_id:         state.selectedTeam.id,
        contract_type:   contractType,
        invitation:      isInvite
      }
    });
    const enrolId = (res.team_registration && res.team_registration.id) || (res.enrolment && res.enrolment.id) || res.id || "?";
    const action  = isInvite ? "Invitation sent" : "Enrolled";
    appendResult(log, "success",
      `<b>${action}:</b> ${escHtml(collabName)} ‚Üí "${escHtml(state.selectedTeam.name||"")}" (#${escHtml(String(enrolId))})`);
    btn.textContent = isInvite ? "‚úì Invited" : "‚úì Enrolled";
    if(!isInvite) loadEnrolments(state.selectedTeam.id);
  } catch(e) {
    appendResult(log, "error", `<b>Failed for ${escHtml(collabName)}:</b> ${e.message}`);
    btn.disabled = false; btn.textContent = isInvite ? "Invite" : "Enrol";
  }
});

/* ================================================================
   COLLABORATOR DETAIL MODAL
   ================================================================ */
document.addEventListener("click", async function(ev){
  const trigger = ev.target.closest("[data-view-collab]");
  if(!trigger) return;
  const collabId = trigger.dataset.viewCollab;
  if(!collabId || collabId === "undefined") return;
  openCollabModal(collabId);
});

document.getElementById("collabModalClose").addEventListener("click", () => {
  document.getElementById("collabModal").classList.add("hidden");
});
document.getElementById("collabModal").addEventListener("click", e => {
  if(e.target === e.currentTarget) e.currentTarget.classList.add("hidden");
});

async function openCollabModal(collabId){
  const modal  = document.getElementById("collabModal");
  const body   = document.getElementById("collabModalBody");
  const avatar = document.getElementById("collabModalAvatar");
  const name   = document.getElementById("collabModalName");

  avatar.textContent = "‚Ä¶";
  name.textContent   = "Loading‚Ä¶";
  body.innerHTML     = `<div class="empty"><div class="spinner"></div><p>Loading‚Ä¶</p></div>`;
  modal.classList.remove("hidden");

  try {
    const data = await apiGET(`api/v1/admin/collaborators/${collabId}`);
    const c    = data.volunteer || data.collaborator || data;

    avatar.textContent = initials(c.first_name, c.last_name);
    name.textContent   = [c.first_name, c.last_name].filter(Boolean).join(" ") || "(no name)";

    const rows = [
      ["Email",        c.email],
      ["Phone",        c.phone || c.mobile],
      ["Language",     c.language ? c.language.toUpperCase() : null],
      ["Function",     c.function ? c.function.name : null],
      ["Department",   c.department ? c.department.name : null],
      ["Date of birth",c.date_of_birth ? fmtDate(c.date_of_birth) : null],
      ["Status",       [c.archived?"Archived":null, c.blocked?"Blocked":null].filter(Boolean).join(", ") || "Active"],
      ["Address",      c.address ? [c.address.street, c.address.number, c.address.city].filter(Boolean).join(" ") : null],
    ];

    let html = `<div class="detail-grid">`;
    rows.forEach(([label, val]) => {
      if(!val && val !== 0) return;
      html += `<div class="detail-item"><label>${escHtml(label)}</label><span>${escHtml(String(val))}</span></div>`;
    });
    html += `</div>`;

    // Profile properties if present
    const props = c.profile_properties || c.profile_property_answers || [];
    if(props.length){
      html += `<hr style="border:none;border-top:1px solid var(--border);margin:16px 0;">`;
      html += `<div style="font-weight:700;font-size:13px;color:var(--muted);margin-bottom:10px;">Profile properties</div>`;
      html += `<div class="detail-grid">`;
      props.forEach(p => {
        html += `<div class="detail-item"><label>${escHtml(p.name||p.label||"")}</label><span>${escHtml(String(p.value||p.answer||"‚Äî"))}</span></div>`;
      });
      html += `</div>`;
    }

    body.innerHTML = html;
  } catch(e) {
    body.innerHTML = `<div class="alert alert-error"><b>Could not load collaborator:</b> ${escHtml(e.message)}</div>`;
  }
}

/* ================================================================
   PAGINATION
   ================================================================ */
function renderPagination(container, current, total, callback){
  container.innerHTML = "";
  const prev = document.createElement("button");
  prev.className = "page-btn"; prev.textContent = "‚Üê Prev"; prev.disabled = current <= 1;
  prev.addEventListener("click", () => callback(current-1));
  container.appendChild(prev);

  const info = document.createElement("span");
  info.style.cssText = "font-size:13px;color:var(--muted);padding:0 8px;";
  info.textContent = `Page ${current} of ${total}`;
  container.appendChild(info);

  const next = document.createElement("button");
  next.className = "page-btn"; next.textContent = "Next ‚Üí"; next.disabled = current >= total;
  next.addEventListener("click", () => callback(current+1));
  container.appendChild(next);
}

/* BREADCRUMB */
function setBreadcrumb(containerId, crumbs){
  const el = document.getElementById(containerId === "viewTeam" ? "breadcrumbTeam" : "breadcrumb");
  el.innerHTML = "";
  crumbs.forEach((c, i) => {
    if(i > 0){ const sep = document.createElement("span"); sep.textContent = "‚Ä∫"; el.appendChild(sep); }
    if(c.action){
      const a = document.createElement("a"); a.textContent = c.label; a.addEventListener("click", c.action); el.appendChild(a);
    } else {
      const s = document.createElement("span"); s.textContent = c.label; el.appendChild(s);
    }
  });
}

/* LOAD FUNCTIONS FOR FILTER */
async function loadFunctions(){
  try{
    const data=await apiGET("api/v1/admin/functions");
    const fns=data.functions||[];
    const sel=document.getElementById("fFunction");
    fns.forEach(f=>{ const o=document.createElement("option"); o.value=f.id; o.textContent=f.name; sel.appendChild(o); });
  }catch{}
}

/* DEBUG CLEAR */
if(DEBUG){
  document.getElementById("debugClearBtn").addEventListener("click",()=>{
    document.getElementById("debugLog").textContent="";
  });
}

/* INIT */
(function init(){
  const t=localStorage.getItem("theme")||"light";
  document.documentElement.setAttribute("data-theme",t);
  syncTheme();

  /* Debug */
  syncDebug();

  /* Replace the initial history entry so back-button works from first step */
  history.replaceState({ view:"projects" }, "", location.href);

  /* Cookie banner */
  if(!getCookie("beeple_cookie_ok")){
    document.getElementById("cookie").classList.remove("hidden");
  }

  if(!BASE||!TOKEN){
    showView("viewNotConnected");
    document.getElementById("projListMsg").innerHTML=
      `<span style="color:var(--warn);">Please <a href="index.html">log in first</a>.</span>`;
    return;
  }

  loadFunctions();

  /* Load projects, then pre-select from URL params if navigated via FAB */
  const sp = new URLSearchParams(location.search);
  const targetProject = sp.get("project");
  const targetSub     = sp.get("subproject");
  (async () => {
    await loadProjects();
    if(targetProject){
      const p = state.projects.find(x => String(x.id) === targetProject);
      if(p){
        await selectProject(p);
        if(targetSub && p.subprojects_enabled){
          try{
            const data = await apiGET(`api/v1/admin/projects/${p.id}/subprojects`);
            const s = (data.subprojects||[]).find(x => String(x.id) === targetSub);
            if(s) await selectSubproject(s);
          }catch(e){ /* subproject not found or failed to load, stay on project view */ }
        }
      }
    }
  })();
})();
</script>
</body>
</html>
