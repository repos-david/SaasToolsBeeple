<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Team Planner ‚Äî Beeple</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="icon" href="https://cdn.prod.website-files.com/64dc9a6f21257128d0afb983/6601688c81ef6ab1df9e63ad_favicon-beeple.png">
<style>
:root {
  --bg:#f0f4ff; --bg2:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#475569;
  --accent:#4e6bff; --accent2:#7da2ff; --accentSoft:#e9efff; --danger:#ef6b6b;
  --success:#22c55e; --successSoft:#dcfce7; --warn:#f59e0b; --warnSoft:#fef3c7;
  --border:rgba(15,23,42,.10); --field:#ffffff; --fieldBorder:#e5e7eb;
  --tableHead:#eef2ff; --radius:10px; --radius-lg:14px;
  --shadow:0 4px 20px rgba(15,23,42,.08),0 1px 0 rgba(15,23,42,.04);
  --sidebar:280px;
}
[data-theme="dark"] {
  --bg:#0b1020; --bg2:#0e1428; --card:#0f1630; --text:#e8ecff; --muted:#b8c3ef;
  --accent:#5aa2ff; --accent2:#7ec3ff; --accentSoft:#0e2244; --danger:#e66d6d;
  --success:#4ade80; --successSoft:#052e16; --warn:#fbbf24; --warnSoft:#451a03;
  --border:rgba(255,255,255,.14); --field:#121b39; --fieldBorder:rgba(255,255,255,.18);
  --tableHead:#13224a; --shadow:0 8px 28px rgba(0,0,0,.35),0 1px 0 rgba(255,255,255,.04);
}
*,*::before,*::after { box-sizing:border-box; max-width:100%; }
html { overflow-x:clip; }
body {
  margin:0; overflow-x:clip;
  background:var(--bg); color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  font-size:15px; line-height:1.55;
  -webkit-text-size-adjust:100%; text-size-adjust:100%;
}
/* TOP BAR */
.topbar {
  position:sticky; top:0; z-index:30;
  background:var(--card); border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px; padding:10px 16px;
}
.topbar .brand img { height:22px; width:auto; display:block; }
.topbar .title { font-weight:800; font-size:clamp(15px,3vw,20px); flex:1; text-align:center; }
.icon-btn {
  width:40px; height:40px; border-radius:10px; border:1px solid var(--border);
  background:var(--accentSoft); cursor:pointer; display:flex; align-items:center;
  justify-content:center; flex-shrink:0; color:var(--accent);
}
[data-theme="dark"] .icon-btn { color:var(--accent2); }
.icon-btn svg { width:20px; height:20px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
/* sidebar toggle only visible on mobile */
.sidebar-toggle-btn { display:none; }
@media(max-width:700px){ .sidebar-toggle-btn { display:flex; } }
/* NAV MENU PANEL */
.menu-overlay { display:none; position:fixed; inset:0; z-index:49; background:rgba(0,0,0,.4); }
.menu-overlay.show { display:block; }
.menu-panel {
  position:fixed; top:0; right:0; bottom:0; width:min(260px,80vw);
  background:var(--card); border-left:1px solid var(--border);
  z-index:50; transform:translateX(100%); transition:transform .3s ease;
  display:flex; flex-direction:column; box-shadow:-4px 0 20px rgba(0,0,0,.15);
}
.menu-panel.open { transform:translateX(0); }
.menu-panel-header {
  padding:16px; display:flex; align-items:center; justify-content:space-between;
  border-bottom:1px solid var(--border); flex-shrink:0;
}
.menu-panel-header span { font-weight:800; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.06em; }
.menu-item {
  display:flex; align-items:center; gap:12px; padding:15px 16px;
  cursor:pointer; border-bottom:1px solid var(--border);
  text-decoration:none; color:var(--text); font-weight:600; font-size:15px;
  transition:background .15s; background:transparent;
  border-left:none; border-right:none; border-top:none;
  font-family:inherit; width:100%; text-align:left;
}
.menu-item:hover { background:var(--accentSoft); }
.menu-item.active { color:var(--accent); background:var(--accentSoft); }
[data-theme="dark"] .menu-item.active { color:var(--accent2); }
.menu-item svg { width:20px; height:20px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; flex-shrink:0; }
.menu-spacer { flex:1; }
.menu-divider { height:1px; background:var(--border); }
/* LAYOUT */
.layout { display:flex; min-height:calc(100vh - 55px); }
/* SIDEBAR */
.sidebar {
  width:var(--sidebar); flex-shrink:0;
  background:var(--card); border-right:1px solid var(--border);
  display:flex; flex-direction:column; transition:transform .3s ease; position:relative;
}
@media(max-width:700px){
  .sidebar {
    position:fixed; left:0; top:55px; bottom:0; z-index:20;
    transform:translateX(-100%); box-shadow:4px 0 20px rgba(0,0,0,.15);
  }
  .sidebar.open { transform:translateX(0); }
  .sidebar-overlay { display:block; }
}
.sidebar-overlay { display:none; position:fixed; inset:0; z-index:19; background:rgba(0,0,0,.4); }
.sidebar-overlay.show { display:block; }
.sidebar-header { padding:16px; font-weight:800; font-size:13px; letter-spacing:.06em; color:var(--muted); text-transform:uppercase; border-bottom:1px solid var(--border); }
.sidebar-search { padding:10px 12px; border-bottom:1px solid var(--border); }
.sidebar-search input { width:100%; padding:8px 12px; border:1px solid var(--fieldBorder); border-radius:var(--radius); background:var(--field); color:var(--text); font-size:14px; -webkit-appearance:none; appearance:none; }
.sidebar-search input:focus { outline:none; border-color:var(--accent); }
.proj-list { flex:1; overflow-y:auto; }
.proj-item { display:flex; align-items:center; gap:10px; padding:12px 16px; cursor:pointer; border-bottom:1px solid var(--border); transition:background .15s; }
.proj-item:hover { background:var(--accentSoft); }
.proj-item.active { background:var(--accentSoft); border-left:3px solid var(--accent); }
.proj-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.proj-name { font-weight:600; font-size:14px; flex:1; min-width:0; }
.proj-name small { display:block; font-weight:400; font-size:12px; color:var(--muted); margin-top:1px; }
.proj-badge { font-size:11px; font-weight:700; padding:2px 6px; border-radius:6px; background:var(--accentSoft); color:var(--accent); }
/* MAIN */
.main { flex:1; min-width:0; padding:20px 16px 40px; }
/* BREADCRUMB */
.breadcrumb { display:flex; align-items:center; gap:6px; font-size:13px; color:var(--muted); margin-bottom:16px; flex-wrap:wrap; }
.breadcrumb a { color:var(--accent); cursor:pointer; text-decoration:none; }
.breadcrumb a:hover { text-decoration:underline; }
/* SECTION TITLE */
.section-title { font-size:20px; font-weight:800; margin:0 0 4px; }
.section-sub { color:var(--muted); font-size:13px; margin:0 0 16px; }
/* CARDS GRID */
.card-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px; }
.card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:14px; box-shadow:var(--shadow); cursor:pointer; transition:transform .15s,box-shadow .15s; min-width:0; }
.card:hover { transform:translateY(-2px); box-shadow:0 8px 28px rgba(15,23,42,.12); }
.card h3 { margin:0 0 6px; font-size:15px; }
.card .meta { font-size:12px; color:var(--muted); }
/* CHIPS */
.chip { display:inline-block; font-size:11px; font-weight:700; padding:2px 8px; border-radius:20px; margin-right:4px; }
.chip-green  { background:var(--successSoft); color:var(--success); }
.chip-yellow { background:var(--warnSoft);    color:var(--warn); }
.chip-red    { background:#fee2e2;             color:#dc2626; }
.chip-blue   { background:var(--accentSoft);   color:var(--accent); }
.chip-grey   { background:#f1f5f9;             color:#64748b; }
/* TEAM PANEL */
.team-panel { background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg); box-shadow:var(--shadow); overflow:hidden; }
.team-panel-header { padding:16px 18px; border-bottom:1px solid var(--border); display:flex; align-items:flex-start; gap:12px; flex-wrap:wrap; }
.team-panel-header h2 { margin:0; font-size:18px; flex:1; }
.team-panel-body { padding:18px; }
/* TABS */
.tabs { display:flex; gap:4px; border-bottom:2px solid var(--border); margin-bottom:18px; flex-wrap:wrap; }
.tab { padding:8px 16px; font-size:14px; font-weight:600; cursor:pointer; border-radius:8px 8px 0 0; border:none; background:transparent; color:var(--muted); transition:color .15s; font-family:inherit; }
.tab.active { color:var(--accent); background:var(--accentSoft); }
.tab-pane { display:none; }
.tab-pane.active { display:block; }
/* FORM */
input,select,textarea { display:block; width:100%; padding:10px 12px; border:1px solid var(--fieldBorder); border-radius:var(--radius); background:var(--field); color:var(--text); font-family:inherit; font-size:16px; line-height:1.4; transition:border-color .15s,box-shadow .15s; -webkit-appearance:none; appearance:none; }
input::placeholder,textarea::placeholder { color:var(--muted); opacity:.6; }
input:focus,select:focus,textarea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(78,107,255,.18); }
select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' stroke-width='1.8' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center; padding-right:36px; cursor:pointer; }
label { display:block; font-weight:600; font-size:13px; color:var(--muted); margin:14px 0 5px; }
label:first-child { margin-top:0; }
.required::after { content:" *"; color:var(--accent); }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
@media(max-width:560px){ .form-row { grid-template-columns:1fr; } }
/* BUTTONS */
.btn { display:inline-flex; align-items:center; justify-content:center; width:auto; border:none; border-radius:var(--radius); padding:10px 18px; font-family:inherit; font-size:14px; font-weight:700; line-height:1.2; cursor:pointer; min-height:42px; white-space:nowrap; transition:filter .15s,opacity .15s; }
.btn.primary { background:linear-gradient(160deg,var(--accent),var(--accent2)); color:#fff; }
.btn.primary:hover { filter:brightness(1.08); }
.btn.secondary { background:#edf2ff; color:#0f172a; border:1px solid var(--border); }
[data-theme="dark"] .btn.secondary { background:#1e2a45; color:#e5e7eb; }
.btn-danger { background:var(--danger); color:#fff; }
.btn-danger:hover { filter:brightness(1.08); }
.btn-success { background:var(--success); color:#fff; }
.btn-sm { padding:6px 12px; font-size:13px; min-height:32px; }
.btn-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:14px; }
@media(max-width:440px){ .btn-row{flex-direction:column;} .btn-row .btn{width:100%;} }
/* FILTERS */
.filters { background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:14px 16px; margin-bottom:16px; box-shadow:var(--shadow); }
.filters h4 { margin:0 0 10px; font-size:13px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; }
.filter-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:10px; }
.filter-grid input,.filter-grid select { font-size:14px; padding:8px 10px; }
.filter-grid select { padding-right:32px; }
/* COLLAB LIST */
.collab-list { display:grid; gap:10px; }
.collab-card { background:var(--field); border:1px solid var(--fieldBorder); border-radius:var(--radius); padding:12px 14px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
.collab-avatar { width:40px; height:40px; border-radius:50%; background:var(--accentSoft); display:flex; align-items:center; justify-content:center; font-weight:800; font-size:14px; color:var(--accent); flex-shrink:0; }
.collab-info { flex:1; min-width:0; }
.collab-name { font-weight:700; font-size:14px; }
.collab-meta { font-size:12px; color:var(--muted); margin-top:2px; }
.collab-actions { display:flex; gap:6px; flex-wrap:wrap; }
/* ENROLMENT LIST */
.enrol-list { display:grid; gap:8px; }
.enrol-item { background:var(--field); border:1px solid var(--fieldBorder); border-radius:var(--radius); padding:10px 14px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.enrol-info { flex:1; min-width:0; font-size:13px; }
.enrol-name { font-weight:700; font-size:14px; }
/* ALERTS */
.alert { padding:12px 14px; border-radius:var(--radius); font-size:14px; margin-bottom:12px; word-break:break-word; }
.alert-error   { background:#fee2e2; border:1px solid #fca5a5; color:#991b1b; }
.alert-success { background:var(--successSoft); border:1px solid #86efac; color:#166534; }
.alert-info    { background:var(--accentSoft); border:1px solid var(--accent2); color:var(--accent); }
.alert-warn    { background:var(--warnSoft); border:1px solid #fcd34d; color:#92400e; }
[data-theme="dark"] .alert-error   { color:#fca5a5; }
[data-theme="dark"] .alert-success { color:#86efac; }
[data-theme="dark"] .alert-warn    { color:#fbbf24; }
/* EMPTY */
.empty { text-align:center; padding:40px 20px; color:var(--muted); }
.empty svg { width:48px; height:48px; stroke:var(--muted); fill:none; stroke-width:1.5; margin:0 auto 12px; display:block; }
/* TABLE */
.table-wrap { width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:var(--radius); }
table { min-width:500px; width:100%; border-collapse:separate; border-spacing:0; border:1px solid var(--fieldBorder); border-radius:10px; overflow:hidden; background:var(--field); }
th,td { padding:9px 11px; border-bottom:1px solid var(--fieldBorder); vertical-align:middle; white-space:nowrap; font-size:13px; }
th { background:var(--tableHead); color:#0b1740; text-align:left; font-weight:700; }
[data-theme="dark"] th { color:#d9e3ff; }
tr:last-child td { border-bottom:0; }
/* LOG */
pre.log { background:#f7f9ff; color:#111827; border:1px solid var(--fieldBorder); border-radius:var(--radius); padding:10px; font-size:11px; max-height:260px; overflow:auto; white-space:pre-wrap; word-break:break-word; width:100%; }
[data-theme="dark"] pre.log { background:#070e1f; color:#c7dbff; }
/* SPINNER */
.spinner { display:inline-block; width:18px; height:18px; border:2px solid var(--fieldBorder); border-top-color:var(--accent); border-radius:50%; animation:spin .7s linear infinite; vertical-align:middle; }
@keyframes spin { to { transform:rotate(360deg); } }
/* RESULT FEED */
.result-feed { display:grid; gap:8px; max-height:280px; overflow-y:auto; }
/* PAGINATION */
.pagination { display:flex; gap:6px; align-items:center; margin-top:12px; flex-wrap:wrap; }
.page-btn { padding:6px 12px; border-radius:8px; border:1px solid var(--border); background:var(--card); color:var(--text); font-size:13px; font-weight:600; cursor:pointer; min-height:34px; }
.page-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
.page-btn:disabled { opacity:.4; cursor:default; }
/* DEBUG PANEL */
.debug-panel { margin:16px; padding:14px; background:var(--field); border:2px dashed var(--warn); border-radius:var(--radius-lg); }
.debug-panel h4 { margin:0 0 8px; color:var(--warn); font-size:13px; text-transform:uppercase; letter-spacing:.05em; }
/* UTILITY */
.hidden { display:none !important; }
.mt8 { margin-top:8px; }
.mt16 { margin-top:16px; }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <button class="icon-btn" id="menuBtn" title="Menu" aria-label="Menu">
    <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
  <div class="brand">
    <img alt="Beeple" src="https://cdn.prod.website-files.com/64dc9a6f21257128d0afb983/65f86aca8cc32ec9836e8a29_beeple-textlogo.svg">
  </div>
  <div class="title">Team Planner</div>
  <!-- separate button to toggle the project sidebar on mobile -->
  <button class="icon-btn sidebar-toggle-btn" id="sidebarToggleBtn" title="Toggle project list" aria-label="Toggle project list">
    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="18" rx="1"/><line x1="14" y1="7" x2="21" y2="7"/><line x1="14" y1="12" x2="21" y2="12"/><line x1="14" y1="17" x2="21" y2="17"/></svg>
  </button>
</div>

<!-- NAV MENU OVERLAY + PANEL -->
<div class="menu-overlay" id="menuOverlay"></div>
<div class="menu-panel" id="menuPanel">
  <div class="menu-panel-header">
    <span>Menu</span>
    <button class="icon-btn" id="menuCloseBtn" title="Close">
      <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <a class="menu-item" href="teams.html">
    <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    Team creation
  </a>
  <a class="menu-item active" href="planning.html">
    <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Planning
  </a>
  <div class="menu-spacer"></div>
  <div class="menu-divider"></div>
  <button class="menu-item" id="themeMenuBtn">
    <svg id="themeMenuIcon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
    <span id="themeMenuLabel">Dark mode</span>
  </button>
  <div class="menu-divider"></div>
  <button class="menu-item" id="logoutBtn" style="color:var(--danger);">
    <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
    Log out
  </button>
</div>

<!-- SIDEBAR OVERLAY (mobile, for project list) -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- LAYOUT -->
<div class="layout">

  <!-- SIDEBAR: project list -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">Projects</div>
    <div class="sidebar-search">
      <input id="projSearch" type="search" placeholder="Filter projects‚Ä¶" autocomplete="off">
    </div>
    <div class="proj-list" id="projList">
      <div class="empty" style="padding:30px 16px;">
        <div id="projListMsg">Loading‚Ä¶</div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main" id="main">

    <!-- NOT CONNECTED -->
    <div id="viewNotConnected" class="hidden">
      <div class="alert alert-warn">
        <strong>Not connected.</strong>
        <a href="index.html" style="color:inherit;font-weight:700;">Go to login ‚Üí</a>
      </div>
    </div>

    <!-- PROJECT LIST VIEW -->
    <div id="viewProjects" class="hidden">
      <h1 class="section-title">All Projects</h1>
      <p class="section-sub">Select a project from the sidebar to browse subprojects and teams.</p>
      <div id="projectGrid" class="card-grid"></div>
    </div>

    <!-- SUBPROJECT / TEAMS VIEW -->
    <div id="viewProject" class="hidden">
      <div class="breadcrumb" id="breadcrumb"></div>
      <h1 class="section-title" id="viewProjectTitle"></h1>
      <p class="section-sub" id="viewProjectSub"></p>
      <div id="teamDateBar" class="hidden" style="display:none;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:16px;">
        <label style="margin:0;font-size:13px;font-weight:600;color:var(--muted);">Teams from</label>
        <input id="teamDateFrom" type="date" style="font-size:13px;padding:6px 10px;width:auto;">
        <label style="margin:0;font-size:13px;font-weight:600;color:var(--muted);">to</label>
        <input id="teamDateTo" type="date" style="font-size:13px;padding:6px 10px;width:auto;">
        <button class="btn secondary btn-sm" id="teamDateApply">Apply</button>
        <button class="btn btn-sm" id="teamDateReset" style="color:var(--muted);">Reset</button>
      </div>
      <div id="subprojectGrid" class="card-grid"></div>
    </div>

    <!-- TEAM DETAIL VIEW -->
    <div id="viewTeam" class="hidden">
      <div class="breadcrumb" id="breadcrumbTeam"></div>
      <div class="team-panel">
        <div class="team-panel-header">
          <div style="flex:1;min-width:0;">
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <h2 id="teamTitle" style="margin:0;"></h2>
              <span id="teamChips"></span>
            </div>
            <div style="font-size:13px;color:var(--muted);margin-top:4px;" id="teamMeta"></div>
          </div>
        </div>
        <div class="team-panel-body">
          <div class="tabs">
            <button class="tab active" data-tab="enrolments">Enrolments</button>
            <button class="tab" data-tab="enroll">Enroll someone</button>
            <button class="tab" data-tab="invite">Invite someone</button>
          </div>

          <!-- TAB: enrolments -->
          <div class="tab-pane active" id="tab-enrolments">
            <div id="enrolmentsFeed">
              <div class="empty"><div class="spinner"></div><p>Loading‚Ä¶</p></div>
            </div>
          </div>

          <!-- TAB: enroll -->
          <div class="tab-pane" id="tab-enroll">
            <p style="font-size:13px;color:var(--muted);margin-top:0;">Search collaborators and directly enrol them in the team.</p>
            <div class="filters">
              <h4>Filter collaborators</h4>
              <div class="filter-grid">
                <div><label>Name search</label><input id="fSearch" type="search" placeholder="John‚Ä¶" autocomplete="off"></div>
                <div><label>Function</label><select id="fFunction"><option value="">All functions</option></select></div>
                <div>
                  <label>Language</label>
                  <select id="fLanguage">
                    <option value="">Any language</option>
                    <option value="nl">Dutch</option>
                    <option value="fr">French</option>
                    <option value="en">English</option>
                    <option value="de">German</option>
                  </select>
                </div>
                <div><label>Show archived</label><select id="fArchived"><option value="false">Active only</option><option value="true">Include archived</option></select></div>
                <div><label>Show blocked</label><select id="fBlocked"><option value="false">Not blocked</option><option value="true">Include blocked</option></select></div>
                <div><label>Min age</label><input id="fMinAge" type="number" inputmode="numeric" min="16" max="99" placeholder="Any"></div>
              </div>
              <div class="btn-row">
                <button id="searchCollabBtn" class="btn primary btn-sm">Search</button>
                <button id="clearFiltersBtn" class="btn secondary btn-sm">Clear</button>
              </div>
            </div>
            <div id="collabResults"></div>
            <div id="collabPagination" class="pagination"></div>
            <div id="enrolForm" class="hidden" style="margin-top:16px;">
              <div style="background:var(--accentSoft);border-radius:var(--radius);padding:12px 14px;margin-bottom:14px;">
                Enrolling: <strong id="enrolTargetName"></strong>
              </div>
              <div class="form-row">
                <div>
                  <label class="required">Contract type</label>
                  <select id="contractType">
                    <option value="">(select)</option>
                    <option value="interim">Interim</option>
                    <option value="intern">Intern</option>
                    <option value="contractual">Contractual</option>
                    <option value="freelancer">Freelancer</option>
                    <option value="collaborator">Collaborator</option>
                    <option value="volunteer">Volunteer</option>
                  </select>
                </div>
                <div>
                  <label>Invite instead of enrol</label>
                  <select id="enrolInvite">
                    <option value="false">No ‚Äî direct enrolment</option>
                    <option value="true">Yes ‚Äî send invitation</option>
                  </select>
                </div>
              </div>
              <div class="btn-row">
                <button id="confirmEnrolBtn" class="btn primary">Confirm enrolment</button>
                <button id="cancelEnrolSelectBtn" class="btn secondary">Cancel</button>
              </div>
            </div>
            <div id="enrolResults" class="result-feed mt16"></div>
          </div>

          <!-- TAB: invite -->
          <div class="tab-pane" id="tab-invite">
            <p style="font-size:13px;color:var(--muted);margin-top:0;">Search a collaborator by name and send them an invitation for this team.</p>
            <div><label>Name search</label><input id="inviteSearch" type="search" placeholder="Search collaborator‚Ä¶" autocomplete="off"></div>
            <div class="btn-row"><button id="inviteSearchBtn" class="btn secondary btn-sm">Search</button></div>
            <div id="inviteResults" class="mt16"></div>
            <!-- invite contract type (required by the API) -->
            <div id="inviteContractWrap" class="hidden" style="margin-top:12px;">
              <label class="required">Contract type for invitation</label>
              <select id="inviteContractType" style="max-width:280px;">
                <option value="">(select)</option>
                <option value="interim">Interim</option>
                <option value="intern">Intern</option>
                <option value="contractual">Contractual</option>
                <option value="freelancer">Freelancer</option>
                <option value="collaborator">Collaborator</option>
                <option value="volunteer">Volunteer</option>
              </select>
            </div>
            <div id="inviteResultLog" class="result-feed mt16"></div>
          </div>

        </div>
      </div>
    </div>

    <!-- DEBUG PANEL (only shown when ?debug=Y) -->
    <div id="debugSection" class="hidden" style="margin-top:24px;">
      <div class="debug-panel">
        <h4>Debug log</h4>
        <pre class="log" id="debugLog" style="max-height:400px;"></pre>
        <button class="btn secondary btn-sm" id="debugClearBtn" style="margin-top:8px;">Clear log</button>
      </div>
    </div>

  </main>
</div>

<script>
const PROXY_URL = "https://coraligo.com/team-wizard/proxy.php";
const DEBUG     = (new URLSearchParams(location.search).get("debug") || "").toUpperCase() === "Y"
                  || new URLSearchParams(location.search).get("debug") === "1";

/* Read credentials from storage ‚Äî token in sessionStorage (cleared on browser close),
   base URL in localStorage (permanent). */
function originOf(u){ try{ return new URL(u).origin; }catch{ return u; } }
const BASE  = originOf(localStorage.getItem("beeple_base") || "");
const TOKEN = sessionStorage.getItem("beeple_token") || "";

/* STATE */
const state = {
  projects:[], functions:[],
  selectedProject:null, selectedSubproject:null, selectedTeam:null,
  collabPage:1, collabTotal:0, selectedCollab:null, departmentId:null
};

/* DEBUG LOGGING */
function dlog(msg){
  if(!DEBUG) return;
  const pre = document.getElementById("debugLog");
  if(pre){ pre.textContent += msg + "\n"; pre.scrollTop = pre.scrollHeight; }
}

/* THEME */
function syncTheme(){
  const dark = document.documentElement.getAttribute("data-theme") === "dark";
  const moonPath = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
  const sunPath  = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
  document.getElementById("themeMenuIcon").innerHTML = dark ? moonPath : sunPath;
  document.getElementById("themeMenuLabel").textContent = dark ? "Light mode" : "Dark mode";
}

/* NAV MENU */
const menuPanel   = document.getElementById("menuPanel");
const menuOverlay = document.getElementById("menuOverlay");
function openMenu(){ menuPanel.classList.add("open"); menuOverlay.classList.add("show"); }
function closeMenu(){ menuPanel.classList.remove("open"); menuOverlay.classList.remove("show"); }
document.getElementById("menuBtn").addEventListener("click", openMenu);
document.getElementById("menuCloseBtn").addEventListener("click", closeMenu);
menuOverlay.addEventListener("click", closeMenu);

document.getElementById("themeMenuBtn").addEventListener("click", () => {
  const next = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem("theme", next);
  syncTheme();
});

document.getElementById("logoutBtn").addEventListener("click", () => {
  sessionStorage.removeItem("beeple_token");
  window.location.href = "index.html";
});

/* SIDEBAR TOGGLE (mobile ‚Äî separate from nav menu) */
const sidebarEl  = document.getElementById("sidebar");
const overlayEl  = document.getElementById("sidebarOverlay");
document.getElementById("sidebarToggleBtn").addEventListener("click", () => {
  sidebarEl.classList.toggle("open");
  overlayEl.classList.toggle("show");
});
overlayEl.addEventListener("click", () => {
  sidebarEl.classList.remove("open");
  overlayEl.classList.remove("show");
});
function closeSidebar(){
  sidebarEl.classList.remove("open");
  overlayEl.classList.remove("show");
}

/* UTILS */
function escHtml(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":'&#39;'}[m])); }

function parseApiErrors(json, rawText){
  if(!json && rawText) return escHtml(rawText.slice(0, 300));
  if(!json) return "Unknown error.";
  if(json.errors){
    if(Array.isArray(json.errors) && json.errors.length===0) return null;
    const errs = json.errors;
    if(typeof errs==="object" && !Array.isArray(errs)){
      return Object.entries(errs).map(([k,v])=>{
        const msgs = Array.isArray(v) ? v.join(", ") : String(v);
        return k==="base" ? msgs : `<b>${escHtml(k)}</b>: ${escHtml(msgs)}`;
      }).join("<br>");
    }
    if(Array.isArray(errs)) return errs.map(e=>escHtml(String(e))).join("<br>");
  }
  if(json.error) return escHtml(json.error);
  return null;
}

function initials(fn,ln){ return ((fn||"").charAt(0)+(ln||"").charAt(0)).toUpperCase()||"?"; }

function fmtDate(d){
  if(!d) return "‚Äî";
  return new Date(d).toLocaleDateString(undefined,{day:"2-digit",month:"short",year:"numeric"});
}

function fmtShift(team){
  if(!team) return "‚Äî";
  if(team.shifts && team.shifts.length){
    const s = team.shifts[0];
    const start = s.start_datetime ? new Date(s.start_datetime) : null;
    const end   = s.end_datetime   ? new Date(s.end_datetime)   : null;
    if(start && end){
      return start.toLocaleDateString(undefined,{day:"2-digit",month:"short"})+" "+
             start.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"})+" ‚Äì "+
             end.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"});
    }
  }
  return "‚Äî";
}

function showView(id){
  ["viewNotConnected","viewProjects","viewProject","viewTeam"].forEach(v=>{
    document.getElementById(v).classList.toggle("hidden", v!==id);
  });
}

/* HTTP VIA PROXY */
function proxyUrl(path, extra=""){
  return `${PROXY_URL}?base=${encodeURIComponent(BASE)}&path=${encodeURIComponent(path)}${extra}${DEBUG?"&debug=1":""}`;
}

async function apiGET(path, queryObj){
  let qs = "";
  if(queryObj){
    const params = Object.entries(queryObj)
      .filter(([,v])=>v!==""&&v!==null&&v!==undefined)
      .map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&");
    if(params) qs = "&"+params;
  }
  dlog(`‚Üí GET ${path}${qs}`);
  const res = await fetch(proxyUrl(path)+qs, {headers:{"X-Beeple-Token":TOKEN}});
  const txt = await res.text();
  dlog(`‚Üê ${res.status} ${res.statusText}`);
  let json = {};
  try{ json = JSON.parse(txt); }catch{}
  if(!res.ok){
    dlog(`  ERROR body: ${txt.slice(0,500)}`);
    const msg = parseApiErrors(json, txt) || ("HTTP "+res.status);
    throw new Error(msg);
  }
  if(DEBUG) dlog(`  body: ${txt.slice(0,300)}${txt.length>300?"‚Ä¶":""}`);
  return json;
}

async function apiPOST(path, payload){
  const body = JSON.stringify(payload);
  dlog(`‚Üí POST ${path}`);
  if(DEBUG) dlog(`  payload: ${body.slice(0,300)}`);
  const res = await fetch(proxyUrl(path), {
    method:"POST", headers:{"X-Beeple-Token":TOKEN,"Content-Type":"application/json"}, body
  });
  const txt = await res.text();
  dlog(`‚Üê ${res.status} ${res.statusText}`);
  let json = {};
  try{ json = JSON.parse(txt); }catch{}
  if(!res.ok || (json.errors && (Array.isArray(json.errors)?json.errors.length:Object.keys(json.errors).length))){
    dlog(`  ERROR body: ${txt.slice(0,500)}`);
  } else {
    if(DEBUG) dlog(`  body: ${txt.slice(0,300)}${txt.length>300?"‚Ä¶":""}`);
  }
  const apiErr = parseApiErrors(json, txt);
  if(!res.ok || (apiErr && apiErr.length && !(Array.isArray(json.errors)&&json.errors.length===0))){
    throw new Error(apiErr || "HTTP "+res.status);
  }
  return json;
}

async function apiDELETEorPOST(method, path, payload){
  dlog(`‚Üí ${method} ${path}`);
  const res = await fetch(proxyUrl(path), {
    method, headers:{"X-Beeple-Token":TOKEN,"Content-Type":"application/json"},
    body: payload ? JSON.stringify(payload) : undefined
  });
  const txt = await res.text();
  dlog(`‚Üê ${res.status} ${res.statusText}`);
  let json = {};
  try{ json = JSON.parse(txt); }catch{}
  const apiErr = parseApiErrors(json, txt);
  if(!res.ok || (apiErr && apiErr.length && !(Array.isArray(json.errors)&&json.errors.length===0))){
    dlog(`  ERROR body: ${txt.slice(0,500)}`);
    throw new Error(apiErr || "HTTP "+res.status);
  }
  return json;
}

/* ALERT / RESULT HELPERS */
function makeAlert(type, html){
  const d = document.createElement("div");
  d.className = `alert alert-${type}`; d.innerHTML = html; return d;
}
function appendResult(container, type, html){
  const el = makeAlert(type, html);
  container.prepend(el);
  while(container.children.length > 20) container.lastChild.remove();
}

/* LOAD PROJECTS */
async function loadProjects(){
  document.getElementById("projListMsg").textContent = "Loading‚Ä¶";
  try{
    const data = await apiGET("api/v1/admin/projects");
    state.projects = data.projects || [];
    renderSidebar(state.projects);
    renderProjectGrid(state.projects);
    showView("viewProjects");
  }catch(e){
    document.getElementById("projListMsg").innerHTML =
      `<span style="color:var(--danger);">Error: ${escHtml(e.message)}</span>`;
    const nc = document.getElementById("viewNotConnected");
    nc.classList.remove("hidden");
    nc.innerHTML = makeAlert("error",`<b>Could not load projects:</b> ${e.message}`).outerHTML+
      `<p>Check your login: <a href="index.html">go to login</a>.</p>`;
    showView("viewNotConnected");
  }
}

function renderSidebar(projects){
  const list = document.getElementById("projList");
  list.innerHTML = "";
  if(!projects.length){ list.innerHTML=`<div class="empty" style="padding:20px 16px;">No projects found.</div>`; return; }
  projects.forEach(p=>{
    const el = document.createElement("div");
    el.className = "proj-item"; el.dataset.id = p.id;
    const color = p.color_code||"#4e6bff";
    el.innerHTML = `
      <span class="proj-dot" style="background:${escHtml(color)};"></span>
      <div class="proj-name">${escHtml(p.name)}<small>${p.department?escHtml(p.department.name):""}</small></div>
      <span class="proj-badge">${p.registrations_count||0}/${p.volunteers_needed||0}</span>`;
    el.addEventListener("click", ()=>selectProject(p));
    list.appendChild(el);
  });
}

function renderProjectGrid(projects){
  const grid = document.getElementById("projectGrid"); grid.innerHTML = "";
  projects.forEach(p=>{
    const color = p.color_code||"#4e6bff";
    const el = document.createElement("div"); el.className = "card";
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <span class="proj-dot" style="background:${escHtml(color)};width:14px;height:14px;"></span>
        <h3 style="margin:0;">${escHtml(p.name)}</h3>
      </div>
      <div class="meta">
        <span>üìÖ ${fmtDate(p.start_date)} ‚Äì ${fmtDate(p.end_date)}</span><br>
        ${p.department?`<span>üè¢ ${escHtml(p.department.name)}</span>`:""}
        ${p.customer  ?`<span>üë§ ${escHtml(p.customer.name)}</span>`  :""}
      </div>
      <div style="margin-top:8px;">
        <span class="chip chip-${p.published?"green":"grey"}">${p.published?"Published":"Draft"}</span>
        <span class="chip chip-blue">${p.registrations_count||0}/${p.volunteers_needed||0} enrolled</span>
        ${p.subprojects_enabled?'<span class="chip chip-yellow">Subprojects</span>':""}
      </div>`;
    el.addEventListener("click",()=>selectProject(p));
    grid.appendChild(el);
  });
}

document.getElementById("projSearch").addEventListener("input",function(){
  const q = this.value.toLowerCase();
  document.querySelectorAll(".proj-item").forEach(el=>{
    el.style.display = el.textContent.toLowerCase().includes(q)?"":"none";
  });
});

async function selectProject(project){
  state.selectedProject=project; state.selectedSubproject=null; state.selectedTeam=null;
  state.departmentId = project.department?project.department.id:null;
  document.querySelectorAll(".proj-item").forEach(el=>el.classList.toggle("active",el.dataset.id===String(project.id)));
  closeSidebar(); showView("viewProject"); initDateBar();
  document.getElementById("viewProjectTitle").textContent = project.name;
  const grid = document.getElementById("subprojectGrid");
  grid.innerHTML = `<div class="empty"><div class="spinner"></div><p>Loading‚Ä¶</p></div>`;
  setBreadcrumb("viewProject",[
    {label:"Projects", action:()=>{showView("viewProjects"); clearActiveProject();}},
    {label:project.name}
  ]);
  try{
    if(project.subprojects_enabled){
      document.getElementById("viewProjectSub").textContent = "This project uses subprojects.";
      const data = await apiGET(`api/v1/admin/projects/${project.id}/subprojects`);
      const subs = data.subprojects||[];
      if(!subs.length){ grid.innerHTML=`<div class="empty"><p>No subprojects found.</p></div>`; return; }
      grid.innerHTML = "";
      subs.forEach(s=>{
        const el=document.createElement("div"); el.className="card";
        el.innerHTML=`<h3>${escHtml(s.name)}</h3><div class="meta"><span>${fmtDate(s.start_date)} ‚Äì ${fmtDate(s.end_date)}</span></div><div style="margin-top:8px;"><span class="chip chip-blue">${s.registrations_count||0}/${s.volunteers_needed||0}</span></div>`;
        el.addEventListener("click",()=>selectSubproject(s)); grid.appendChild(el);
      });
    }else{
      document.getElementById("viewProjectSub").textContent = "All teams in this project:";
      await loadTeamsIntoGrid(grid, project.id, null);
    }
  }catch(e){ grid.innerHTML=`<div class="alert alert-error">Error loading: ${escHtml(e.message)}</div>`; }
}

function clearActiveProject(){ document.querySelectorAll(".proj-item").forEach(el=>el.classList.remove("active")); }

async function selectSubproject(sub){
  state.selectedSubproject=sub; state.selectedTeam=null;
  showView("viewProject"); initDateBar();
  const project=state.selectedProject;
  document.getElementById("viewProjectTitle").textContent = sub.name;
  document.getElementById("viewProjectSub").textContent = `Subproject of "${project.name}"`;
  const grid=document.getElementById("subprojectGrid");
  grid.innerHTML=`<div class="empty"><div class="spinner"></div><p>Loading teams‚Ä¶</p></div>`;
  setBreadcrumb("viewProject",[
    {label:"Projects", action:()=>{showView("viewProjects"); clearActiveProject();}},
    {label:project.name, action:()=>selectProject(project)},
    {label:sub.name}
  ]);
  try{ await loadTeamsIntoGrid(grid,project.id,sub.id); }
  catch(e){ grid.innerHTML=`<div class="alert alert-error">Error loading teams: ${escHtml(e.message)}</div>`; }
}

/* DATE BAR */
function isoDate(d){ return d.toISOString().slice(0,10); }
function defaultDateFrom(){ const d=new Date(); d.setDate(d.getDate()-7); return isoDate(d); }
function defaultDateTo(){ const d=new Date(); d.setMonth(d.getMonth()+1); return isoDate(d); }
let _dateBarInited=false;
function initDateBar(){
  const bar=document.getElementById("teamDateBar");
  const from=document.getElementById("teamDateFrom");
  const to=document.getElementById("teamDateTo");
  if(!from.value) from.value=defaultDateFrom();
  if(!to.value) to.value=defaultDateTo();
  bar.style.display="flex"; bar.classList.remove("hidden");
  if(_dateBarInited) return; _dateBarInited=true;
  document.getElementById("teamDateApply").addEventListener("click",()=>reloadCurrentTeamGrid());
  document.getElementById("teamDateReset").addEventListener("click",()=>{
    from.value=defaultDateFrom(); to.value=defaultDateTo(); reloadCurrentTeamGrid();
  });
}
function reloadCurrentTeamGrid(){
  const grid=document.getElementById("subprojectGrid");
  const p=state.selectedProject; const s=state.selectedSubproject;
  if(!p) return;
  grid.innerHTML=`<div class="empty"><div class="spinner"></div><p>Loading‚Ä¶</p></div>`;
  loadTeamsIntoGrid(grid,p.id,s?s.id:null).catch(e=>{
    grid.innerHTML=`<div class="alert alert-error">Error: ${escHtml(e.message)}</div>`;
  });
}

async function loadTeamsIntoGrid(grid, projectId, subprojectId){
  const path = subprojectId
    ?`api/v1/admin/subprojects/${subprojectId}/teams`
    :`api/v1/admin/projects/${projectId}/teams`;
  const fromVal=document.getElementById("teamDateFrom").value||defaultDateFrom();
  const toVal=document.getElementById("teamDateTo").value||defaultDateTo();
  const data=await apiGET(path,{start_date:fromVal, end_date:toVal});
  const teams=data.teams||[];
  if(!teams.length){ grid.innerHTML=`<div class="empty"><p>No teams found.</p></div>`; return; }
  grid.innerHTML="";
  teams.forEach(t=>{
    const el=document.createElement("div"); el.className="card";
    el.innerHTML=`
      <h3>${escHtml(t.name||"(auto-named)")}</h3>
      <div class="meta">
        <div>${fmtShift(t)}</div>
        <div style="margin-top:4px;">
          <span class="chip chip-${t.published?"green":"grey"}">${t.published?"Published":"Draft"}</span>
          <span class="chip chip-blue">${t.registrations_count||0}/${t.volunteers_needed||0} filled</span>
        </div>
        ${t.function?`<div style="margin-top:4px;">‚öô ${escHtml(t.function.name)}</div>`:""}
        ${t.address ?`<div>üìç ${escHtml(t.address.name||t.address.city||"")}</div>`:""}
      </div>`;
    el.addEventListener("click",()=>selectTeam(t)); grid.appendChild(el);
  });
}

async function selectTeam(team){
  state.selectedTeam=team; state.selectedCollab=null;
  showView("viewTeam");
  const project=state.selectedProject; const sub=state.selectedSubproject;
  const crumbs=[
    {label:"Projects", action:()=>{showView("viewProjects"); clearActiveProject();}},
    {label:project.name, action:()=>selectProject(project)}
  ];
  if(sub) crumbs.push({label:sub.name, action:()=>selectSubproject(sub)});
  crumbs.push({label:team.name||"(team)"});
  setBreadcrumb("viewTeam", crumbs);
  document.getElementById("teamTitle").textContent = team.name||"(auto-named)";
  document.getElementById("teamChips").innerHTML =
    `<span class="chip chip-${team.published?"green":"grey"}">${team.published?"Published":"Draft"}</span>
     <span class="chip chip-blue">${team.registrations_count||0}/${team.volunteers_needed||0} filled</span>`;
  document.getElementById("teamMeta").innerHTML =
    [fmtShift(team),
     team.function?"‚öô "+escHtml(team.function.name):"",
     team.address ?"üìç "+escHtml(team.address.name||team.address.city||""):""]
    .filter(Boolean).join(" &nbsp;¬∑&nbsp; ");
  switchTab("enrolments");
  document.getElementById("enrolResults").innerHTML="";
  document.getElementById("inviteResultLog").innerHTML="";
  document.getElementById("enrolForm").classList.add("hidden");
  document.getElementById("inviteContractWrap").classList.add("hidden");
  document.getElementById("inviteResults").innerHTML="";
  state.selectedCollab=null;
  loadEnrolments(team.id);
}

async function loadEnrolments(teamId){
  const feed=document.getElementById("enrolmentsFeed");
  feed.innerHTML=`<div class="empty"><div class="spinner"></div><p>Loading enrolments‚Ä¶</p></div>`;
  try{
    const data=await apiGET(`api/v1/admin/teams/${teamId}/enrolments`);
    const enrols=data.enrolments||[];
    if(!enrols.length){ feed.innerHTML=`<div class="empty"><p>No enrolments yet.</p></div>`; return; }
    feed.innerHTML=`<div class="enrol-list" id="enrolListInner"></div>`;
    const list=document.getElementById("enrolListInner");
    enrols.forEach(e=>{
      const c=e.collaborator||{};
      const row=document.createElement("div"); row.className="enrol-item"; row.dataset.enrolId=e.id;
      row.innerHTML=`
        <div class="collab-avatar">${escHtml(initials(c.first_name,c.last_name))}</div>
        <div class="enrol-info">
          <div class="enrol-name">${escHtml(c.first_name||"")} ${escHtml(c.last_name||"")}</div>
          <div style="font-size:12px;color:var(--muted);">
            ${e.contract_type?`<span class="chip chip-grey">${escHtml(e.contract_type)}</span>`:""}
            ${e.confirmed?'<span class="chip chip-green">Confirmed</span>':'<span class="chip chip-yellow">Unconfirmed</span>'}
            ${e.cancelled?'<span class="chip chip-red">Cancelled</span>':""}
            ${c.email?`<span>${escHtml(c.email)}</span>`:""}
          </div>
        </div>
        <div><button class="btn btn-sm btn-danger" data-cancel-enrol="${escHtml(String(e.id))}">Cancel</button></div>`;
      list.appendChild(row);
    });
  }catch(ex){
    feed.innerHTML=`<div class="alert alert-error"><b>Could not load enrolments:</b> ${escHtml(ex.message)}</div>`;
  }
}

/* CANCEL ENROLMENT */
document.addEventListener("click", async function(ev){
  const btn=ev.target.closest("[data-cancel-enrol]"); if(!btn) return;
  const enrolId=btn.dataset.cancelEnrol;
  if(!confirm("Cancel this enrolment?")) return;
  btn.disabled=true; btn.textContent="‚Ä¶";
  try{
    await apiDELETEorPOST("POST",`api/v1/admin/enrolments/${enrolId}/cancel`,{});
    const row=btn.closest(".enrol-item");
    if(row){ row.style.opacity=".4"; row.querySelectorAll("button").forEach(b=>b.disabled=true); }
    btn.textContent="Cancelled";
  }catch(e){ btn.disabled=false; btn.textContent="Cancel"; alert("Cancel failed: "+e.message); }
});

/* TABS */
function switchTab(name){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active",t.dataset.tab===name));
  document.querySelectorAll(".tab-pane").forEach(p=>p.classList.toggle("active",p.id==="tab-"+name));
}
document.querySelectorAll(".tab").forEach(btn=>btn.addEventListener("click",()=>switchTab(btn.dataset.tab)));

/* SEARCH COLLABORATORS */
async function searchCollaborators(page){
  page=page||1; state.collabPage=page;
  const container=document.getElementById("collabResults");
  const pagDiv=document.getElementById("collabPagination");
  container.innerHTML=`<div class="empty"><div class="spinner"></div><p>Searching‚Ä¶</p></div>`;
  pagDiv.innerHTML="";
  const query={
    search:       document.getElementById("fSearch").value.trim()||undefined,
    function_id:  document.getElementById("fFunction").value||undefined,
    language:     document.getElementById("fLanguage").value||undefined,
    archived:     document.getElementById("fArchived").value==="true"?true:undefined,
    blocked:      document.getElementById("fBlocked").value==="true"?true:undefined,
    minimum_age:  document.getElementById("fMinAge").value||undefined,
    department_id:state.departmentId||undefined,
    page
  };
  Object.keys(query).forEach(k=>query[k]===undefined&&delete query[k]);
  try{
    const data=await apiGET("api/v1/admin/collaborators",query);
    const collabs=data.volunteers||data.collaborators||[];
    const meta=data.meta||{};
    state.collabTotal=meta.total_count||collabs.length;
    const perPage=meta.per_page||20;
    if(!collabs.length){ container.innerHTML=`<div class="empty"><p>No collaborators found.</p></div>`; return; }
    container.innerHTML="";
    const list=document.createElement("div"); list.className="collab-list";
    collabs.forEach(c=>{
      const card=document.createElement("div"); card.className="collab-card";
      card.innerHTML=`
        <div class="collab-avatar">${escHtml(initials(c.first_name,c.last_name))}</div>
        <div class="collab-info">
          <div class="collab-name">${escHtml(c.first_name||"")} ${escHtml(c.last_name||"")}</div>
          <div class="collab-meta">
            ${c.email?escHtml(c.email):""}
            ${c.function?" ¬∑ "+escHtml(c.function.name):""}
            ${c.language?" ¬∑ "+escHtml(c.language.toUpperCase()):""}
            ${c.blocked?'<span class="chip chip-red">Blocked</span>':""}
            ${c.archived?'<span class="chip chip-grey">Archived</span>':""}
          </div>
        </div>
        <div class="collab-actions">
          <button class="btn primary btn-sm" data-select-collab="${escHtml(String(c.id))}" data-collab-name="${escHtml((c.first_name||"")+" "+(c.last_name||""))}">Enrol</button>
        </div>`;
      list.appendChild(card);
    });
    container.appendChild(list);
    const totalPages=Math.ceil(state.collabTotal/perPage);
    if(totalPages>1) renderPagination(pagDiv,page,totalPages,searchCollaborators);
  }catch(e){
    container.innerHTML=`<div class="alert alert-error"><b>Search failed:</b> ${escHtml(e.message)}</div>`;
  }
}

function renderPagination(container, current, total, callback){
  container.innerHTML="";
  const prev=document.createElement("button"); prev.className="page-btn"; prev.textContent="‚Üê Prev"; prev.disabled=current<=1;
  prev.addEventListener("click",()=>callback(current-1)); container.appendChild(prev);
  const info=document.createElement("span"); info.style.cssText="font-size:13px;color:var(--muted);padding:0 8px;";
  info.textContent=`Page ${current} of ${total}`; container.appendChild(info);
  const next=document.createElement("button"); next.className="page-btn"; next.textContent="Next ‚Üí"; next.disabled=current>=total;
  next.addEventListener("click",()=>callback(current+1)); container.appendChild(next);
}

document.addEventListener("click",function(ev){
  const btn=ev.target.closest("[data-select-collab]"); if(!btn) return;
  state.selectedCollab={id:btn.dataset.selectCollab, name:btn.dataset.collabName};
  document.getElementById("enrolTargetName").textContent=btn.dataset.collabName;
  document.getElementById("enrolForm").classList.remove("hidden");
  document.getElementById("enrolForm").scrollIntoView({behavior:"smooth",block:"nearest"});
});

document.getElementById("cancelEnrolSelectBtn").addEventListener("click",()=>{
  state.selectedCollab=null; document.getElementById("enrolForm").classList.add("hidden");
});

/* CONFIRM ENROLMENT */
document.getElementById("confirmEnrolBtn").addEventListener("click",async()=>{
  if(!state.selectedCollab||!state.selectedTeam) return;
  const contractType=document.getElementById("contractType").value;
  const isInvite=document.getElementById("enrolInvite").value==="true";
  if(!contractType){ alert("Please select a contract type."); return; }
  const btn=document.getElementById("confirmEnrolBtn");
  btn.disabled=true; btn.textContent="‚Ä¶";
  const resultFeed=document.getElementById("enrolResults");
  try{
    const payload={enrolment:{volunteer_id:state.selectedCollab.id, team_id:state.selectedTeam.id, contract_type:contractType, invitation:isInvite}};
    const res=await apiPOST("api/v1/admin/enrolments",payload);
    const enrolId=(res.enrolment&&res.enrolment.id)||res.id||"?";
    const action=isInvite?"Invitation sent":"Enrolled";
    appendResult(resultFeed,"success",`<b>${action}:</b> ${escHtml(state.selectedCollab.name)} ‚Üí Team "${escHtml(state.selectedTeam.name||"")}" (#${escHtml(String(enrolId))})`);
    state.selectedCollab=null;
    document.getElementById("enrolForm").classList.add("hidden");
    document.getElementById("contractType").value="";
    loadEnrolments(state.selectedTeam.id);
  }catch(e){ appendResult(resultFeed,"error",`<b>Error:</b> ${e.message}`); }
  finally{ btn.disabled=false; btn.textContent="Confirm enrolment"; }
});

document.getElementById("searchCollabBtn").addEventListener("click",()=>searchCollaborators(1));
document.getElementById("fSearch").addEventListener("keydown",e=>{if(e.key==="Enter") searchCollaborators(1);});
document.getElementById("clearFiltersBtn").addEventListener("click",()=>{
  ["fSearch","fMinAge"].forEach(id=>document.getElementById(id).value="");
  ["fFunction","fLanguage","fArchived","fBlocked"].forEach(id=>document.getElementById(id).selectedIndex=0);
  document.getElementById("collabResults").innerHTML="";
  document.getElementById("collabPagination").innerHTML="";
});

/* INVITE SEARCH */
document.getElementById("inviteSearchBtn").addEventListener("click",async()=>{
  const q=document.getElementById("inviteSearch").value.trim();
  if(!q){ alert("Enter a name to search."); return; }
  const container=document.getElementById("inviteResults");
  container.innerHTML=`<div class="empty"><div class="spinner"></div><p>Searching‚Ä¶</p></div>`;
  document.getElementById("inviteContractWrap").classList.add("hidden");
  try{
    const data=await apiGET("api/v1/admin/collaborators",{search:q, department_id:state.departmentId||undefined});
    const collabs=data.volunteers||data.collaborators||[];
    if(!collabs.length){ container.innerHTML=`<div class="empty"><p>No collaborators found.</p></div>`; return; }
    container.innerHTML="";
    const list=document.createElement("div"); list.className="collab-list";
    collabs.forEach(c=>{
      const card=document.createElement("div"); card.className="collab-card";
      card.innerHTML=`
        <div class="collab-avatar">${escHtml(initials(c.first_name,c.last_name))}</div>
        <div class="collab-info">
          <div class="collab-name">${escHtml(c.first_name||"")} ${escHtml(c.last_name||"")}</div>
          <div class="collab-meta">${c.email?escHtml(c.email):""}</div>
        </div>
        <div class="collab-actions">
          <button class="btn btn-success btn-sm"
            data-invite-collab="${escHtml(String(c.id))}"
            data-invite-name="${escHtml(((c.first_name||"")+" "+(c.last_name||"")).trim())}">Invite</button>
        </div>`;
      list.appendChild(card);
    });
    container.appendChild(list);
    document.getElementById("inviteContractWrap").classList.remove("hidden");
  }catch(e){ container.innerHTML=`<div class="alert alert-error">${escHtml(e.message)}</div>`; }
});

/* INVITE BUTTON ‚Äî requires contract_type */
document.addEventListener("click",async function(ev){
  const btn=ev.target.closest("[data-invite-collab]"); if(!btn) return;
  if(!state.selectedTeam){ alert("No team selected."); return; }
  const contractType=document.getElementById("inviteContractType").value;
  if(!contractType){ alert("Please select a contract type for the invitation."); return; }
  const collabId=btn.dataset.inviteCollab;
  const collabName=btn.dataset.inviteName;
  const log=document.getElementById("inviteResultLog");
  btn.disabled=true; btn.textContent="‚Ä¶";
  try{
    const res=await apiPOST("api/v1/admin/enrolments",{
      enrolment:{volunteer_id:collabId, team_id:state.selectedTeam.id, contract_type:contractType, invitation:true}
    });
    const enrolId=(res.enrolment&&res.enrolment.id)||res.id||"?";
    appendResult(log,"success",`<b>Invitation sent</b> to ${escHtml(collabName)} for "${escHtml(state.selectedTeam.name||"")}" (#${escHtml(String(enrolId))})`);
    btn.textContent="‚úì Sent";
  }catch(e){
    appendResult(log,"error",`<b>Failed for ${escHtml(collabName||"?")}:</b> ${e.message}`);
    btn.disabled=false; btn.textContent="Invite";
  }
});

/* BREADCRUMB */
function setBreadcrumb(containerId, crumbs){
  const el=document.getElementById(containerId==="viewTeam"?"breadcrumbTeam":"breadcrumb");
  el.innerHTML="";
  crumbs.forEach((c,i)=>{
    if(i>0){ const sep=document.createElement("span"); sep.textContent="‚Ä∫"; el.appendChild(sep); }
    if(c.action){ const a=document.createElement("a"); a.textContent=c.label; a.addEventListener("click",c.action); el.appendChild(a); }
    else{ const s=document.createElement("span"); s.textContent=c.label; el.appendChild(s); }
  });
}

/* LOAD FUNCTIONS FOR FILTER */
async function loadFunctions(){
  try{
    const data=await apiGET("api/v1/admin/functions");
    const fns=data.functions||[];
    const sel=document.getElementById("fFunction");
    fns.forEach(f=>{ const o=document.createElement("option"); o.value=f.id; o.textContent=f.name; sel.appendChild(o); });
  }catch{}
}

/* DEBUG CLEAR */
if(DEBUG){
  document.getElementById("debugClearBtn").addEventListener("click",()=>{
    document.getElementById("debugLog").textContent="";
  });
}

/* INIT */
(function init(){
  const t=localStorage.getItem("theme")||"light";
  document.documentElement.setAttribute("data-theme",t);
  syncTheme();

  if(DEBUG){
    document.getElementById("debugSection").classList.remove("hidden");
    dlog("Debug mode ON. BASE="+BASE);
  }

  if(!BASE||!TOKEN){
    showView("viewNotConnected");
    document.getElementById("projListMsg").innerHTML=
      `<span style="color:var(--warn);">Please <a href="index.html">log in first</a>.</span>`;
    return;
  }

  loadProjects();
  loadFunctions();
})();
</script>
</body>
</html>
