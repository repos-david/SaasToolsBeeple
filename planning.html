<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>SaasTools.eu for Beeple — Planning</title>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="icon" href="icon.svg">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="TeamWizard">
<link rel="apple-touch-icon" href="icon.svg">
<meta name="theme-color" content="#4e6bff">
<style>
:root {
  --bg:#f0f4ff; --bg2:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#475569;
  --accent:#4e6bff; --accent2:#7da2ff; --accentSoft:#e9efff; --danger:#ef6b6b;
  --success:#22c55e; --successSoft:#dcfce7; --warn:#f59e0b; --warnSoft:#fef3c7;
  --border:rgba(15,23,42,.10); --field:#ffffff; --fieldBorder:#e5e7eb;
  --tableHead:#eef2ff; --radius:10px; --radius-lg:14px;
  --shadow:0 4px 20px rgba(15,23,42,.08),0 1px 0 rgba(15,23,42,.04);
}
[data-theme="dark"] {
  --bg:#0b1020; --bg2:#0e1428; --card:#0f1630; --text:#e8ecff; --muted:#b8c3ef;
  --accent:#5aa2ff; --accent2:#7ec3ff; --accentSoft:#0e2244; --danger:#e66d6d;
  --success:#4ade80; --successSoft:#052e16; --warn:#fbbf24; --warnSoft:#451a03;
  --border:rgba(255,255,255,.14); --field:#121b39; --fieldBorder:rgba(255,255,255,.18);
  --tableHead:#13224a; --shadow:0 8px 28px rgba(0,0,0,.35),0 1px 0 rgba(255,255,255,.04);
}
*,*::before,*::after { box-sizing:border-box; max-width:100%; }
html { overflow-x:clip; }
body {
  margin:0; overflow-x:clip;
  background:var(--bg); color:var(--text);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  font-size:15px; line-height:1.55;
  -webkit-text-size-adjust:100%; text-size-adjust:100%;
}
/* ACCENT STRIP */
.accent-strip {
  height:4px; background:linear-gradient(90deg,var(--accent),var(--accent2));
  flex-shrink:0;
}
/* TOP BAR */
.topbar {
  position:sticky; top:0; z-index:30;
  background:var(--card); border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px; padding:10px 16px;
}
.topbar .brand img { height:28px; width:28px; border-radius:6px; display:block; }
.topbar .title { font-weight:800; font-size:clamp(14px,3vw,17px); flex:1; text-align:center; display:flex; flex-direction:column; align-items:center; line-height:1.2; gap:1px; }
.topbar .page-subtitle { font-size:11px; font-weight:500; color:var(--muted); letter-spacing:.03em; text-transform:uppercase; }
.icon-btn {
  width:40px; height:40px; border-radius:10px; border:1px solid var(--border);
  background:var(--accentSoft); cursor:pointer; display:flex; align-items:center;
  justify-content:center; flex-shrink:0; color:var(--accent);
}
[data-theme="dark"] .icon-btn { color:var(--accent2); }
.icon-btn svg { width:20px; height:20px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
/* NAV MENU */
.nav-menu {
  position:fixed; top:59px; right:0; z-index:25;
  background:var(--card); border:1px solid var(--border);
  border-radius:0 0 0 var(--radius-lg);
  box-shadow:var(--shadow);
  min-width:210px;
  transform:translateX(110%);
  transition:transform .25s ease;
}
.nav-menu.open { transform:translateX(0); }
.nav-item {
  display:flex; align-items:center; gap:12px; min-height:50px;
  padding:0 20px; font-weight:600; font-size:15px;
  color:var(--text); text-decoration:none; cursor:pointer;
  border-bottom:1px solid var(--border); margin:0; line-height:1.4;
  box-sizing:border-box;
}
.nav-item:hover { background:var(--accentSoft); }
.nav-item.active { color:var(--accent); background:var(--accentSoft); border-right:3px solid var(--accent); }
button.nav-item {
  width:100%; text-align:left; background:none; border:none;
  border-bottom:1px solid var(--border);
  font-family:inherit; font-size:15px; font-weight:600;
  color:var(--text); cursor:pointer;
}
button.nav-item:hover { background:var(--accentSoft); }
button.nav-item.danger { color:var(--danger); }
.nav-overlay {
  display:none; position:fixed; inset:0; z-index:24; background:rgba(0,0,0,.3);
}
.nav-overlay.show { display:block; }
/* LAYOUT */
.content-area { display:flex; flex-direction:column; height:calc(100vh - 59px); }
/* MAIN */
.main { flex:1; min-width:0; padding:20px 16px 40px; overflow-y:auto; overflow-x:hidden; }
.proj-search { margin-bottom:12px; }
/* TOOLBAR */
.toolbar {
  display:flex; align-items:center; justify-content:space-between;
  padding:8px 14px; border-bottom:1px solid var(--border);
  background:var(--card); flex-wrap:wrap; gap:8px; flex-shrink:0;
}
.toolbar-left  { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.toolbar-right { display:flex; align-items:center; gap:6px; flex-shrink:0; }
.toolbar-nav { width:32px; height:32px; border-radius:8px; }
.toolbar-date-input { width:auto !important; font-size:13px !important; padding:5px 8px !important; min-height:auto !important; display:inline-block !important; }
.toolbar-search { width:160px; font-size:13px !important; padding:6px 10px !important; min-height:auto !important; }
/* FAB */
.fab { position:fixed; bottom:24px; right:20px; z-index:40; width:56px; height:56px; border-radius:50%; background:linear-gradient(160deg,var(--accent),var(--accent2)); color:#fff; display:flex; align-items:center; justify-content:center; text-decoration:none; box-shadow:0 4px 16px rgba(78,107,255,.45); transition:filter .15s; }
.fab svg { width:28px; height:28px; stroke:#fff; fill:none; stroke-width:2; stroke-linecap:round; }
.fab:hover { filter:brightness(1.1); }
/* VIEW TABS */
.view-tabs { display:flex; align-items:center; border-bottom:1px solid var(--border); background:var(--card); overflow-x:auto; flex-shrink:0; padding:0 6px; }
.tab-btn { padding:10px 14px; font-size:13px; font-weight:600; border:none; background:none; cursor:pointer; color:var(--muted); border-bottom:2px solid transparent; margin-bottom:-1px; white-space:nowrap; font-family:inherit; transition:color .15s; }
.tab-btn:hover { color:var(--text); }
.tab-btn.tab-active { color:var(--accent); border-bottom-color:var(--accent); }
/* BREADCRUMB */
.breadcrumb { display:flex; align-items:center; gap:6px; font-size:13px; color:var(--muted); margin-bottom:16px; flex-wrap:wrap; position:sticky; top:0; z-index:5; background:var(--bg); padding:20px 16px 8px; margin-top:-20px; margin-left:-16px; margin-right:-16px; }
/* SORT */
.sort-bar { display:flex; align-items:center; gap:6px; margin-bottom:10px; font-size:12px; color:var(--muted); }
.sort-bar label { margin:0; font-size:12px; font-weight:600; }
.sort-bar select { width:auto; font-size:12px; padding:4px 28px 4px 8px; min-height:auto; border-radius:6px; }
.breadcrumb a { color:var(--accent); cursor:pointer; text-decoration:none; }
.breadcrumb a:hover { text-decoration:underline; }
/* SECTION TITLE */
.section-title { font-size:20px; font-weight:800; margin:0 0 4px; }
.section-sub { color:var(--muted); font-size:13px; margin:0 0 16px; }
/* CARDS GRID */
.card-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px; }
.card { background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg); padding:14px; box-shadow:var(--shadow); cursor:pointer; transition:transform .15s,box-shadow .15s; min-width:0; }
.card:hover { transform:translateY(-2px); box-shadow:0 8px 28px rgba(15,23,42,.12); }
.card h3 { margin:0 0 6px; font-size:15px; }
.card .meta { font-size:12px; color:var(--muted); }
.card .meta span { margin-right:10px; }
/* STATUS CHIPS */
.chip { display:inline-block; font-size:11px; font-weight:700; padding:2px 8px; border-radius:20px; margin-right:4px; }
.chip-green  { background:var(--successSoft); color:var(--success); }
.chip-yellow { background:var(--warnSoft);    color:var(--warn); }
.chip-red    { background:#fee2e2;             color:#dc2626; }
.chip-blue   { background:var(--accentSoft);   color:var(--accent); }
.chip-grey   { background:#f1f5f9; color:#64748b; }
.card.card-ended { opacity:.55; }
.card.card-ended:hover { transform:none; box-shadow:var(--shadow); }
/* TEAM HEADER CARD */
.team-header-card {
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg);
  padding:16px 18px; box-shadow:var(--shadow); margin-bottom:12px;
}
.team-header-card h2 { margin:0; font-size:18px; }
/* SECTION CARD */
.sec-card {
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius-lg);
  padding:18px; box-shadow:var(--shadow); margin-bottom:12px;
}
.sec-card h3 { margin:0 0 14px; font-size:16px; font-weight:700; }
/* FORM */
input,select,textarea { display:block; width:100%; padding:10px 12px; border:1px solid var(--fieldBorder); border-radius:var(--radius); background:var(--field); color:var(--text); font-family:inherit; font-size:16px; line-height:1.4; transition:border-color .15s,box-shadow .15s; -webkit-appearance:none; appearance:none; }
input::placeholder,textarea::placeholder { color:var(--muted); opacity:.6; }
input:focus,select:focus,textarea:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(78,107,255,.18); }
select { background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' stroke-width='1.8' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 12px center; padding-right:36px; cursor:pointer; }
label { display:block; font-weight:600; font-size:13px; color:var(--muted); margin:14px 0 5px; }
label:first-child { margin-top:0; }
.required::after { content:" *"; color:var(--accent); }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
@media(max-width:560px){ .form-row { grid-template-columns:1fr; } }
/* BUTTONS */
.btn { display:inline-flex; align-items:center; justify-content:center; width:auto; border:none; border-radius:var(--radius); padding:10px 18px; font-family:inherit; font-size:14px; font-weight:700; line-height:1.2; cursor:pointer; min-height:42px; white-space:nowrap; transition:filter .15s,opacity .15s; }
.btn.primary { background:linear-gradient(160deg,var(--accent),var(--accent2)); color:#fff; }
.btn.primary:hover { filter:brightness(1.08); }
.btn.secondary { background:#edf2ff; color:#0f172a; border:1px solid var(--border); }
[data-theme="dark"] .btn.secondary { background:#1e2a45; color:#e5e7eb; }
.btn-danger { background:var(--danger); color:#fff; }
.btn-danger:hover { filter:brightness(1.08); }
.btn-success { background:var(--success); color:#fff; }
.btn-sm { padding:6px 12px; font-size:13px; min-height:32px; }
.btn-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:14px; }
@media(max-width:440px){ .btn-row{flex-direction:column;} .btn-row .btn{width:100%;} }
/* FILTERS */
.filters { margin-bottom:14px; }
/* VIEW TOGGLE */
.view-toggle { display:flex; border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; }
.view-btn { padding:5px 10px; border:none; background:none; cursor:pointer; font-size:12px; font-weight:600; color:var(--muted); font-family:inherit; display:flex; align-items:center; gap:4px; }
.view-btn.active { background:var(--accent); color:#fff; }
.view-btn:not(.active):hover { background:var(--accentSoft); color:var(--text); }
/* TIMELINE */
.timeline-wrap { overflow-x:auto; -webkit-overflow-scrolling:touch; margin:0 -16px; padding:0 4px; }
.timeline-table { border-collapse:collapse; min-width:100%; }
.timeline-table th { background:var(--tableHead); font-size:12px; font-weight:700; padding:8px 12px; text-align:center; border:1px solid var(--fieldBorder); min-width:130px; color:#0b1740; }
.timeline-table th.tl-today { background:var(--accentSoft); color:var(--accent); }
[data-theme="dark"] .timeline-table th { color:#d9e3ff; }
.timeline-table td { border:1px solid var(--fieldBorder); padding:6px; vertical-align:top; min-width:130px; }
.tl-team { background:var(--accentSoft); border:1px solid var(--accent2); border-radius:8px; padding:6px 8px; margin-bottom:4px; cursor:pointer; font-size:12px; transition:background .15s; }
.tl-team:hover { background:var(--accent); color:#fff; }
.tl-team-name { font-weight:700; white-space:normal; word-break:break-word; }
.tl-team-meta { color:var(--muted); font-size:11px; margin-top:2px; }
.tl-team:hover .tl-team-meta { color:rgba(255,255,255,.8); }
.tl-empty { font-size:12px; color:var(--muted); padding:8px; text-align:center; }
/* ADVANCED FILTER TOGGLE */
.adv-toggle { background:none; border:none; font-family:inherit; font-size:13px; font-weight:600; color:var(--accent); cursor:pointer; padding:0; display:inline-flex; align-items:center; gap:4px; }
.adv-toggle:hover { text-decoration:underline; }
/* NAV ITEM ICONS */
.nav-item svg { width:17px; height:17px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; flex-shrink:0; }
.filter-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:10px; }
.filter-grid input,.filter-grid select { font-size:14px; padding:8px 10px; }
.filter-grid select { padding-right:32px; }
/* COLLAB LIST */
.collab-list { display:grid; gap:10px; }
.collab-card {
  background:var(--field); border:1px solid var(--fieldBorder); border-radius:var(--radius);
  padding:12px 14px; display:grid; grid-template-columns:40px 1fr; column-gap:12px; row-gap:8px;
}
.collab-card-error { grid-column:1/-1; }
.collab-avatar { grid-row:span 2; align-self:start; }
.collab-actions { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.collab-avatar {
  width:40px; height:40px; border-radius:50%; background:var(--accentSoft);
  display:flex; align-items:center; justify-content:center;
  font-weight:800; font-size:14px; color:var(--accent); flex-shrink:0;
  cursor:pointer;
}
.collab-avatar:hover { background:var(--accent); color:#fff; }
.collab-info { flex:1; min-width:0; cursor:pointer; }
.collab-info:hover .collab-name { color:var(--accent); }
.collab-name { font-weight:700; font-size:14px; color:var(--accent); }
.collab-meta { font-size:12px; color:var(--muted); margin-top:2px; }
.collab-actions { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
/* ENROLMENT LIST */
.enrol-list { display:grid; gap:8px; }
.enrol-item { background:var(--field); border:1px solid var(--fieldBorder); border-radius:var(--radius); padding:10px 14px; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.enrol-info { flex:1; min-width:0; font-size:13px; }
.enrol-name { font-weight:700; font-size:14px; }
/* INLINE ACTION ROW (enrol/invite confirm) */
.inline-action {
  width:100%; border-top:1px solid var(--fieldBorder); padding-top:10px; margin-top:8px;
  display:flex; align-items:center; gap:8px; flex-wrap:wrap;
}
.inline-action select { width:auto; min-width:150px; font-size:13px; padding:6px 30px 6px 10px; }
/* ALERT BOXES */
.alert { padding:12px 14px; border-radius:var(--radius); font-size:14px; margin-bottom:12px; word-break:break-word; }
.alert-error   { background:#fee2e2; border:1px solid #fca5a5; color:#991b1b; }
.alert-success { background:var(--successSoft); border:1px solid #86efac; color:#166534; }
.alert-info    { background:var(--accentSoft); border:1px solid var(--accent2); color:var(--accent); }
.alert-warn    { background:var(--warnSoft); border:1px solid #fcd34d; color:#92400e; }
[data-theme="dark"] .alert-error   { color:#fca5a5; }
[data-theme="dark"] .alert-success { color:#86efac; }
[data-theme="dark"] .alert-warn    { color:#fbbf24; }
/* EMPTY */
.empty { text-align:center; padding:40px 20px; color:var(--muted); }
.empty svg { width:48px; height:48px; stroke:var(--muted); fill:none; stroke-width:1.5; margin:0 auto 12px; display:block; }
/* TABLE */
.table-wrap { width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; border-radius:var(--radius); }
table { min-width:500px; width:100%; border-collapse:separate; border-spacing:0; border:1px solid var(--fieldBorder); border-radius:10px; overflow:hidden; background:var(--field); }
th,td { padding:9px 11px; border-bottom:1px solid var(--fieldBorder); vertical-align:middle; white-space:nowrap; font-size:13px; }
th { background:var(--tableHead); color:#0b1740; text-align:left; font-weight:700; }
[data-theme="dark"] th { color:#d9e3ff; }
tr:last-child td { border-bottom:0; }
/* LOG */
pre.log { background:#f7f9ff; color:#111827; border:1px solid var(--fieldBorder); border-radius:var(--radius); padding:10px; font-size:11px; max-height:260px; overflow:auto; white-space:pre-wrap; word-break:break-word; width:100%; }
[data-theme="dark"] pre.log { background:#070e1f; color:#c7dbff; }
/* SPINNER */
.spinner { display:inline-block; width:18px; height:18px; border:2px solid var(--fieldBorder); border-top-color:var(--accent); border-radius:50%; animation:spin .7s linear infinite; vertical-align:middle; }
@keyframes spin { to { transform:rotate(360deg); } }
/* LOG */
.log-wrap { margin-top:12px; }
pre.log { background:#f7f9ff; color:#111827; border:1px solid var(--fieldBorder); border-radius:var(--radius); padding:10px; font-size:11px; max-height:160px; overflow:auto; white-space:pre-wrap; word-break:break-word; width:100%; }
[data-theme="dark"] pre.log { background:#070e1f; color:#c7dbff; }
/* UTILITY */
.hidden { display:none !important; }
.mt8 { margin-top:8px; }
.mt16 { margin-top:16px; }
/* RESULT FEED */
.result-feed { display:grid; gap:8px; max-height:280px; overflow-y:auto; }
/* PAGINATION */
.pagination { display:flex; gap:6px; align-items:center; margin-top:12px; flex-wrap:wrap; }
.page-btn { padding:6px 12px; border-radius:8px; border:1px solid var(--border); background:var(--card); color:var(--text); font-size:13px; font-weight:600; cursor:pointer; min-height:34px; }
.page-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
.page-btn:disabled { opacity:.4; cursor:default; }
/* Cookie banner */
.cookie { position:fixed; left:50%; bottom:14px; transform:translateX(-50%); width:min(92vw,520px); background:rgba(255,255,255,.8); backdrop-filter:blur(14px); border:1px solid var(--border); box-shadow:var(--shadow); border-radius:14px; padding:14px; display:flex; align-items:center; gap:12px; z-index:40; color:#0f172a; }
[data-theme="dark"] .cookie { background:rgba(11,16,32,.85); color:#e5e7eb; }
.cookie.hide { transition:transform .35s,opacity .35s; transform:translate(-50%,130%); opacity:0; }
.cookie .msg { flex:1; font-size:14px; }
.cookie .btn { width:auto; min-width:64px; min-height:36px; }
/* DEBUG BANNER */
.debug-banner { background:#fef3c7; border:1px solid #f59e0b; border-radius:var(--radius); padding:8px 14px; font-size:13px; color:#92400e; margin:12px 16px 0; }
[data-theme="dark"] .debug-banner { background:#451a03; color:#fbbf24; border-color:#b45309; }
/* FAB — now an inline toolbar button, kept for JS compat */
/* COLLABORATOR DETAIL MODAL */
.modal-overlay {
  position:fixed; inset:0; z-index:100; background:rgba(0,0,0,.5);
  backdrop-filter:blur(4px); display:flex; align-items:center;
  justify-content:center; padding:16px;
}
.modal-card {
  background:var(--card); border-radius:var(--radius-lg); box-shadow:var(--shadow);
  max-width:520px; width:100%; max-height:85vh; overflow-y:auto;
}
.modal-header {
  padding:16px 18px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px;
}
.modal-header h2 { margin:0; font-size:17px; flex:1; }
.modal-close {
  background:none; border:none; font-size:22px; line-height:1;
  cursor:pointer; color:var(--muted); padding:2px 8px; border-radius:6px;
}
.modal-close:hover { background:var(--accentSoft); color:var(--text); }
.modal-body { padding:18px; }
.detail-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px 20px; }
@media(max-width:440px) { .detail-grid { grid-template-columns:1fr; } }
.detail-item label { margin:0 0 2px; font-size:12px; color:var(--muted); font-weight:600; }
.detail-item span { display:block; font-size:14px; font-weight:500; }
/* PWA install overlay */
.pwa-overlay {
  position:fixed; bottom:80px; left:50%; transform:translateX(-50%);
  z-index:50; width:min(92vw,480px);
  background:var(--card); border:1px solid var(--border);
  border-radius:16px; box-shadow:0 8px 32px rgba(0,0,0,.18);
  padding:16px; display:flex; align-items:center; gap:14px;
  animation:slideUp .3s ease;
}
@keyframes slideUp {
  from { transform:translateX(-50%) translateY(20px); opacity:0; }
  to   { transform:translateX(-50%) translateY(0); opacity:1; }
}
.pwa-overlay.hidden { display:none !important; }
.pwa-icon { border-radius:12px; flex-shrink:0; }
.pwa-text { flex:1; }
.pwa-text strong { display:block; font-weight:700; margin-bottom:2px; }
.pwa-text span { font-size:13px; color:var(--muted); }
.pwa-actions { display:flex; gap:8px; flex-shrink:0; flex-wrap:wrap; }
</style>
</head>
<body>

<!-- ACCENT STRIP -->
<div class="accent-strip"></div>

<!-- TOP BAR -->
<div class="topbar">
  <div class="brand" onclick="return false;" style="cursor:default;">
    <img alt="SaasTools.eu" src="icon.svg">
  </div>
  <div class="title" onclick="return false;" style="cursor:default;">SaasTools.eu for Beeple<span class="page-subtitle">Planning</span></div>
  <button class="icon-btn" id="hamburgerBtn" title="Menu" aria-label="Menu">
    <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
</div>

<!-- NAV MENU -->
<nav id="navMenu" class="nav-menu" aria-label="Main navigation">
  <a href="teams.html" class="nav-item">
    <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
    Team creation
  </a>
  <a href="javascript:void(0)" class="nav-item active" onclick="navMenu.classList.remove('open');navOverlay.classList.remove('show');">
    <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    Planning
  </a>
  <button id="debugToggleBtn" class="nav-item">
    <svg id="debugToggleIcon" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
    <span id="debugToggleLabel">Debug mode</span>
  </button>
  <button id="themeMenuBtn" class="nav-item">
    <svg id="themeMenuIcon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
    <span id="themeMenuLabel">Dark mode</span>
  </button>
  <button id="pwaMenuBtn" class="nav-item hidden">
    <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    Install as app
  </button>
  <button id="logoutBtn" class="nav-item danger">
    <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
    Log out
  </button>
</nav>
<div id="navOverlay" class="nav-overlay"></div>

<!-- Debug banner -->
<div id="debugBanner" class="debug-banner hidden">Debug mode active — full API responses shown in logs.</div>

<!-- CONTENT AREA -->
<div class="content-area">

<!-- TOOLBAR (shown when a project is selected) -->
<div id="toolbar" class="toolbar hidden">
  <div class="toolbar-left">
    <input id="gridSearch" type="search" placeholder="Search by name…" autocomplete="off" class="toolbar-search">
    <div id="teamDateBar" class="hidden" style="display:none;align-items:center;gap:6px;">
      <input id="teamDateFrom" type="date" class="toolbar-date-input">
      <input id="teamDateTo" type="date" class="toolbar-date-input">
    </div>
  </div>
  <div class="toolbar-right">
    <select id="teamSort" title="Sort teams" style="width:auto;font-size:12px;padding:5px 28px 5px 8px;min-height:auto;border-radius:6px;">
      <option value="date-asc">Date ↑</option>
      <option value="date-desc">Date ↓</option>
      <option value="name-asc">Name A–Z</option>
      <option value="name-desc">Name Z–A</option>
    </select>
    <div class="view-toggle" id="viewToggle">
      <button class="view-btn active" id="viewGridBtn" title="Grid view">
        <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        Grid
      </button>
      <button class="view-btn" id="viewTimelineBtn" title="Timeline view">
        <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
        Timeline
      </button>
    </div>
  </div>
</div>


<!-- PWA install overlay -->
<div id="pwaOverlay" class="pwa-overlay hidden" role="dialog" aria-label="Install app">
  <img src="icon.svg" width="52" height="52" class="pwa-icon" alt="">
  <div class="pwa-text">
    <strong>Install TeamWizard</strong>
    <span>Add to home screen for quick access</span>
  </div>
  <div class="pwa-actions">
    <button id="pwaInstallBtn" class="btn primary btn-sm">Install</button>
    <button id="pwaDismissBtn" class="btn secondary btn-sm">Not now</button>
  </div>
</div>

<!-- Collaborator detail modal -->
<div id="collabModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-label="Collaborator details">
  <div class="modal-card">
    <div class="modal-header">
      <div id="collabModalAvatar" class="collab-avatar" style="width:44px;height:44px;font-size:16px;cursor:default;flex-shrink:0;"></div>
      <h2 id="collabModalName"></h2>
      <button class="modal-close" id="collabModalClose" aria-label="Close">×</button>
    </div>
    <div class="modal-body" id="collabModalBody">
      <div class="empty"><div class="spinner"></div><p>Loading…</p></div>
    </div>
  </div>
</div>

<!-- MAIN -->
<main class="main" id="main">

  <!-- LOADING STATE -->
  <div id="viewLoading">
    <div class="empty"><div class="spinner"></div><p>Loading projects…</p></div>
  </div>

  <!-- PROJECT LIST VIEW -->
  <div id="viewProjects" class="hidden">
    <h1 class="section-title">Select a project</h1>
    <p class="section-sub">Click a project to view its teams.</p>
    <div class="sort-bar">
      <label>Sort by</label>
      <select id="projectSort">
        <option value="name-asc">Name A–Z</option>
        <option value="name-desc">Name Z–A</option>
        <option value="date-asc">Start date ↑</option>
        <option value="date-desc">Start date ↓</option>
      </select>
    </div>
    <div id="projectGrid" class="card-grid"></div>
  </div>

  <!-- PENDING INVITATIONS VIEW -->
  <div id="viewInvitations" class="hidden">
    <div class="breadcrumb" id="breadcrumbInv"></div>
    <h1 class="section-title">Pending Invitations</h1>
    <p class="section-sub">Invitations sent to collaborators that are still waiting for acceptance.</p>
    <div style="margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
      <div style="flex:1;min-width:200px;">
        <label style="margin-bottom:6px;">Project</label>
        <select id="invProjectSelect" style="font-size:14px;"></select>
      </div>
      <button id="loadInvitationsBtn" class="btn primary btn-sm">Load invitations</button>
      <button id="invBackBtn" class="btn secondary btn-sm">← Back to projects</button>
    </div>
    <div id="invitationsFeed">
      <div class="empty"><p>Select a project and click "Load invitations".</p></div>
    </div>
  </div>

  <!-- SUBPROJECT / TEAMS VIEW -->
  <div id="viewProject" class="hidden">
    <div class="breadcrumb" id="breadcrumb"></div>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:4px;">
      <h1 class="section-title" id="viewProjectTitle" style="margin:0;flex:1;min-width:0;"></h1>
      <button id="projectInvitationsBtn" class="btn secondary btn-sm" style="flex-shrink:0;">
        <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        Invitations
      </button>
    </div>
    <p class="section-sub" id="viewProjectSub"></p>
    <div id="subSortBar" class="sort-bar hidden">
      <label>Sort by</label>
      <select id="subprojectSort">
        <option value="name-asc">Name A–Z</option>
        <option value="name-desc">Name Z–A</option>
        <option value="date-asc">Start date ↑</option>
        <option value="date-desc">Start date ↓</option>
      </select>
    </div>
    <div id="subprojectGrid" class="card-grid"></div>
  </div>

  <!-- TEAM DETAIL VIEW -->
  <div id="viewTeam" class="hidden">
    <div class="breadcrumb" id="breadcrumbTeam"></div>

    <!-- Team header -->
    <div class="team-header-card">
      <div style="display:flex;align-items:flex-start;gap:12px;flex-wrap:wrap;">
        <div style="flex:1;min-width:0;">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <h2 id="teamTitle" style="margin:0;"></h2>
            <span id="teamChips"></span>
          </div>
          <div style="font-size:13px;color:var(--muted);margin-top:4px;" id="teamMeta"></div>
        </div>
      </div>
    </div>

    <!-- Enrolments card -->
    <div id="enrolmentsCard" class="sec-card">
      <h3>Enrolments</h3>
      <div id="enrolmentsFeed"><div class="empty"><div class="spinner"></div><p>Loading…</p></div></div>
    </div>

    <!-- Candidacies card (shown only when there are candidacies) -->
    <div id="candidaciesCard" class="sec-card hidden">
      <h3>Candidacies</h3>
      <div id="candidaciesFeed"></div>
    </div>

    <!-- Find & add collaborators card -->
    <div class="sec-card">
      <h3>Find &amp; add collaborator</h3>

      <!-- Filters -->
      <div class="filters">
        <div class="filter-grid">
          <div>
            <label>Name search</label>
            <input id="fSearch" type="search" placeholder="John…" autocomplete="off">
          </div>
          <div>
            <label>Function</label>
            <select id="fFunction">
              <option value="">All functions</option>
            </select>
          </div>
          <div>
            <label>Language</label>
            <select id="fLanguage">
              <option value="">Any language</option>
              <option value="nl">Dutch</option>
              <option value="fr">French</option>
              <option value="en">English</option>
              <option value="de">German</option>
            </select>
          </div>
          <div>
            <label>Show archived</label>
            <select id="fArchived">
              <option value="false">Active only</option>
              <option value="true">Include archived</option>
            </select>
          </div>
          <div>
            <label>Show blocked</label>
            <select id="fBlocked">
              <option value="false">Not blocked</option>
              <option value="true">Include blocked</option>
            </select>
          </div>
          <div>
            <label>Min age</label>
            <input id="fMinAge" type="number" inputmode="numeric" min="16" max="99" placeholder="Any">
          </div>
        </div>
        <!-- Advanced fields -->
        <div id="advFilterWrap" class="hidden" style="margin-top:10px;">
          <div class="filter-grid">
            <div>
              <label>City</label>
              <input id="fCity" type="text" placeholder="Brussels…" autocomplete="off">
            </div>
            <div>
              <label>Postal code</label>
              <input id="fPostalCode" type="text" placeholder="1000…" autocomplete="off">
            </div>
            <div>
              <label>Max distance (km)</label>
              <input id="fDistance" type="number" inputmode="numeric" min="0" placeholder="50">
            </div>
            <div>
              <label>Available from</label>
              <input id="fAvailableFrom" type="date">
            </div>
            <div>
              <label>Available to</label>
              <input id="fAvailableTo" type="date">
            </div>
            <div>
              <label>Gender</label>
              <select id="fGender">
                <option value="">Any</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label>Nationality</label>
              <input id="fNationality" type="text" placeholder="BE…" autocomplete="off">
            </div>
            <div>
              <label>Driver's license</label>
              <select id="fDriverLicense">
                <option value="">Any</option>
                <option value="true">Has license</option>
                <option value="false">No license</option>
              </select>
            </div>
          </div>
        </div>
        <div class="btn-row" style="margin-top:10px;">
          <button id="searchCollabBtn" class="btn primary btn-sm">Search</button>
          <button id="clearFiltersBtn" class="btn secondary btn-sm">Clear</button>
          <button id="advFilterBtn" class="adv-toggle">
            <svg viewBox="0 0 24 24" width="13" height="13" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
            Advanced filters
          </button>
        </div>
      </div>

      <!-- Sort bar for collaborators -->
      <div id="collabSortBar" class="sort-bar hidden">
        <label>Sort by</label>
        <select id="collabSort">
          <option value="name-asc">Name A–Z</option>
          <option value="name-desc">Name Z–A</option>
          <option value="email-asc">Email A–Z</option>
          <option value="email-desc">Email Z–A</option>
        </select>
      </div>

      <!-- Contract type selector — shown only when results are visible -->
      <div id="contractTypeWrap" class="hidden" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px;">
        <label style="margin:0;font-size:13px;font-weight:600;color:var(--muted);white-space:nowrap;">Contract type</label>
        <select id="globalContractType" style="width:auto;min-width:170px;font-size:14px;padding:7px 32px 7px 10px;">
          <option value="">(select)</option>
          <option value="interim">Interim</option>
          <option value="intern">Intern</option>
          <option value="contractual">Contractual</option>
          <option value="freelancer">Freelancer</option>
          <option value="collaborator">Collaborator</option>
          <option value="volunteer">Volunteer</option>
        </select>
      </div>

      <!-- Results -->
      <div id="collabResults"></div>
      <div id="collabSentinel" style="height:40px;display:flex;align-items:center;justify-content:center;"></div>

      <!-- Result log -->
      <div id="enrolResults" class="result-feed mt16"></div>
    </div>

    <!-- Debug log (shown only when debug=Y) -->
    <div id="debugLogWrap" class="log-wrap hidden">
      <h4 style="margin:16px 0 4px;font-size:13px;color:var(--muted);">Debug log</h4>
      <pre class="log" id="debugLog"></pre>
    </div>

  </div><!-- viewTeam -->

</main>
</div><!-- /content-area -->

<!-- Floating action button -->
<a id="fabBtn" href="create.html" class="fab hidden" title="Create team for this project"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></a>

<!-- COOKIE BANNER -->
<div id="cookie" class="cookie hidden">
  <div class="msg">This page uses cookies for a better experience.</div>
  <div><button id="cookieOk" class="btn secondary">OK</button></div>
</div>

<script>
/* ================================================================
   CONFIG
   ================================================================ */
const PROXY_URL  = "https://coraligo.com/team-wizard/proxy.php";
const debugParam = new URLSearchParams(location.search).get("debug");
let DEBUG        = debugParam === "1" || debugParam === "Y" || debugParam === "y";

/* ================================================================
   AUTH
   ================================================================ */
const BASE  = localStorage.getItem("bwBase")   || "";
const TOKEN = sessionStorage.getItem("bwToken") || "";
if(!BASE || !TOKEN){ window.location.replace("index.html"); }

/* ================================================================
   THEME
   ================================================================ */
function syncTheme(){
  const dark = document.documentElement.getAttribute("data-theme") === "dark";
  const icon = dark
    ? '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>'
    : '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
  const el = document.getElementById("themeMenuIcon");
  if(el) el.innerHTML = icon;
  const lbl = document.getElementById("themeMenuLabel");
  if(lbl) lbl.textContent = dark ? "Light mode" : "Dark mode";
}
document.getElementById("themeMenuBtn").addEventListener("click", () => {
  const next = document.documentElement.getAttribute("data-theme") === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem("theme", next);
  syncTheme();
  navMenu.classList.remove("open"); navOverlay.classList.remove("show");
});

/* ================================================================
   NAV MENU
   ================================================================ */
const navMenu    = document.getElementById("navMenu");
const navOverlay = document.getElementById("navOverlay");
document.getElementById("hamburgerBtn").addEventListener("click", () => {
  navMenu.classList.toggle("open");
  navOverlay.classList.toggle("show");
});
navOverlay.addEventListener("click", () => {
  navMenu.classList.remove("open");
  navOverlay.classList.remove("show");
});
document.getElementById("logoutBtn").addEventListener("click", function() {
  this.disabled = true;
  this.innerHTML = `<span class="spinner" style="width:16px;height:16px;border-width:2px;margin-right:8px;"></span> Logging out…`;
  sessionStorage.removeItem("bwToken");
  localStorage.removeItem("bwBase");
  window.location.href = "index.html";
});

document.getElementById("projectInvitationsBtn").addEventListener("click", () => {
  const project = state.selectedProject;
  if(!project) return;
  showView("viewInvitations");
  setBreadcrumb("viewInvitations", [
    { label:"Projects", action: () => { showView("viewProjects"); history.pushState({view:"projects"}, ""); } },
    { label: project.name, action: () => selectProject(project) },
    { label:"Pending Invitations" }
  ]);
  // Pre-select the current project
  const sel = document.getElementById("invProjectSelect");
  sel.innerHTML = '<option value="">— select project —</option>';
  (state.projects || []).forEach(p => {
    const o = document.createElement("option"); o.value = p.id; o.textContent = p.name; sel.appendChild(o);
  });
  sel.value = project.id;
});

document.getElementById("invBackBtn").addEventListener("click", () => {
  if(state.selectedProject){
    selectProject(state.selectedProject);
  } else {
    showView("viewProjects");
    history.pushState({view:"projects"}, "");
  }
});

document.getElementById("loadInvitationsBtn").addEventListener("click", async () => {
  const projectId = document.getElementById("invProjectSelect").value;
  if(!projectId){ alert("Please select a project first."); return; }
  const feed = document.getElementById("invitationsFeed");
  feed.innerHTML = '<div class="empty"><div class="spinner"></div><p>Loading invitations…</p></div>';
  try {
    const fromVal = "2020-01-01", toVal = "2030-12-31";
    const data = await apiGET(`api/v1/admin/projects/${projectId}/teams`, { start_date: fromVal, end_date: toVal, per_page: 200 });
    const teams = (data.teams || []).filter(t => !t.deleted && !t.deleted_at);
    if(!teams.length){ feed.innerHTML = '<div class="empty"><p>No teams found for this project.</p></div>'; return; }
    const allInvitations = [];
    await Promise.allSettled(teams.slice(0, 50).map(async team => {
      try {
        const ed = await apiGET(`api/v1/admin/teams/${team.id}/enrolments`);
        const enrols = ed.enrolments || ed.team_registrations || [];
        enrols.filter(e => e.invitation && !e.confirmed && !e.cancelled).forEach(e => allInvitations.push({ ...e, _team: team }));
      } catch{}
    }));
    if(!allInvitations.length){ feed.innerHTML = '<div class="empty"><p>No pending invitations found.</p></div>'; return; }
    feed.innerHTML = '';
    const byTeam = {};
    allInvitations.forEach(inv => {
      const tid = String(inv._team.id);
      if(!byTeam[tid]) byTeam[tid] = { team: inv._team, invitations: [] };
      byTeam[tid].invitations.push(inv);
    });
    Object.values(byTeam).forEach(({ team, invitations }) => {
      const sec = document.createElement("div"); sec.className = "sec-card";
      sec.innerHTML = `<h3>${escHtml(team.name||"(auto-named)")} <span style="font-weight:400;font-size:13px;color:var(--muted);">${fmtShift(team)}</span></h3>`;
      const ul = document.createElement("div"); ul.className = "enrol-list";
      invitations.forEach(inv => {
        const c = inv.collaborator || inv.volunteer || {};
        const nm = ((c.first_name||"")+" "+(c.last_name||"")).trim() || c.email || "(unknown)";
        const av = initials(c.first_name, c.last_name) || "?";
        const row = document.createElement("div"); row.className = "enrol-item";
        row.innerHTML = `<div class="collab-avatar" style="cursor:pointer" data-view-collab="${escHtml(String(c.id||""))}">${escHtml(av)}</div>
          <div class="enrol-info"><div class="enrol-name">${escHtml(nm)}</div>
          <div style="font-size:12px;color:var(--muted);">${c.email?escHtml(c.email)+" · ":""}Invited ${inv.created_at?fmtDate(inv.created_at.slice(0,10)):""}</div></div>`;
        ul.appendChild(row);
      });
      sec.appendChild(ul); feed.appendChild(sec);
    });
  } catch(e) {
    feed.innerHTML = `<div class="alert alert-error"><b>Could not load invitations:</b> ${escHtml(e.message)}</div>`;
  }
});

/* ================================================================
   DEBUG TOGGLE
   ================================================================ */
function syncDebug(){
  const banner = document.getElementById("debugBanner");
  if(DEBUG){
    banner.classList.remove("hidden");
    clearTimeout(window._debugBannerTimer);
    window._debugBannerTimer = setTimeout(() => banner.classList.add("hidden"), 3000);
  } else {
    banner.classList.add("hidden");
  }
  const lbl = document.getElementById("debugToggleLabel");
  if(lbl) lbl.textContent = "Debug mode";
  const ico = document.getElementById("debugToggleIcon");
  if(ico) ico.innerHTML = DEBUG
    ? `<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>`
    : `<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>`;
  document.getElementById("debugLogWrap").classList.toggle("hidden", !DEBUG);
}
document.getElementById("debugToggleBtn").addEventListener("click", () => {
  DEBUG = !DEBUG;
  syncDebug();
  navMenu.classList.remove("open"); navOverlay.classList.remove("show");
});

/* ================================================================
   PWA INSTALL
   ================================================================ */
let pwaPrompt = null;
window.addEventListener("beforeinstallprompt", e => {
  e.preventDefault();
  pwaPrompt = e;
  document.getElementById("pwaMenuBtn").classList.remove("hidden");
});
window.addEventListener("appinstalled", () => {
  pwaPrompt = null;
  document.getElementById("pwaMenuBtn").classList.add("hidden");
  document.getElementById("pwaOverlay").classList.add("hidden");
  localStorage.setItem("pwa_installed", "1");
});
function triggerPwaInstall(){
  if(!pwaPrompt) return;
  pwaPrompt.prompt();
  pwaPrompt.userChoice.then(() => { pwaPrompt = null; });
}
document.getElementById("pwaMenuBtn").addEventListener("click", () => {
  triggerPwaInstall();
  navMenu.classList.remove("open"); navOverlay.classList.remove("show");
});
document.getElementById("pwaInstallBtn").addEventListener("click", () => { triggerPwaInstall(); });
document.getElementById("pwaDismissBtn").addEventListener("click", () => {
  document.getElementById("pwaOverlay").classList.add("hidden");
  localStorage.setItem("pwa_install_dismissed", "1");
});

/* ================================================================
   SERVICE WORKER
   ================================================================ */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").catch(() => {});
}

/* ================================================================
   COOKIE HELPERS
   ================================================================ */
function setCookie(k,v,days=365){ const e=new Date(Date.now()+days*864e5).toUTCString(); document.cookie=`${k}=${encodeURIComponent(v)};expires=${e};path=/;SameSite=Lax`; }
function getCookie(k){ return document.cookie.split("; ").reduce((r,v)=>{ const[n,...rest]=v.split("="); return n===k?decodeURIComponent(rest.join("=")):r; },""); }

/* ================================================================
   STATE
   ================================================================ */
const state = {
  projects:           [],
  functions:          [],
  selectedProject:    null,
  selectedSubproject: null,
  selectedTeam:       null,
  collabPage:         1,
  collabTotal:        0,
  departmentId:       null
};

/* ================================================================
   UTILS
   ================================================================ */
function escHtml(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":'&#39;'}[m])); }
const ICON_CAL = '<svg style="width:13px;height:13px;vertical-align:-2px;stroke:currentColor;fill:none;stroke-width:2;" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>';
const ICON_PIN = '<svg style="width:13px;height:13px;vertical-align:-2px;stroke:currentColor;fill:none;stroke-width:2;" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>';
const ICON_PERSON = '<svg style="width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
const ICON_PUBLISHED = '<svg style="width:13px;height:13px;vertical-align:-2px;stroke:currentColor;fill:none;stroke-width:2;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="9 12 11 14 15 10"/></svg>';
const ICON_DRAFT = '<svg style="width:13px;height:13px;vertical-align:-2px;stroke:currentColor;fill:none;stroke-width:2;stroke-dasharray:4 2;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>';

function parseApiErrors(json){
  if(!json) return "Unknown error.";
  if(json.errors){
    if(Array.isArray(json.errors) && json.errors.length===0) return null;
    const errs = json.errors;
    if(typeof errs === "object" && !Array.isArray(errs)){
      return Object.entries(errs).map(([k,v]) => {
        const msgs = Array.isArray(v) ? v.join(", ") : String(v);
        return k === "base" ? msgs : `<b>${escHtml(k)}</b>: ${escHtml(msgs)}`;
      }).join("<br>");
    }
    if(Array.isArray(errs)) return errs.map(e => escHtml(String(e))).join("<br>");
  }
  if(json.error) return escHtml(json.error);
  return null;
}

function extractErrorList(json){
  if(!json) return ["Unknown error"];
  if(json.errors){
    const errs = json.errors;
    if(Array.isArray(errs) && errs.length) return errs.map(String);
    if(typeof errs === "object" && !Array.isArray(errs)){
      return Object.entries(errs).flatMap(([k,v]) => {
        const msgs = Array.isArray(v) ? v : [String(v)];
        return k === "base" ? msgs : msgs.map(m => `${k}: ${m}`);
      });
    }
  }
  if(json.error) return [String(json.error)];
  return ["Unknown error"];
}
function initials(fn,ln){ return ((fn||"").charAt(0)+(ln||"").charAt(0)).toUpperCase(); }
function fmtDate(d){ if(!d)return"—"; return new Date(d).toLocaleDateString(undefined,{day:"2-digit",month:"short",year:"numeric"}); }
function isEnded(d){ if(!d)return false; return d < new Date().toISOString().slice(0,10); }

function fmtShift(team){
  if(!team) return "—";
  if(team.shifts && team.shifts.length){
    const s = team.shifts[0];
    const start = s.start_datetime ? new Date(s.start_datetime) : null;
    const end   = s.end_datetime   ? new Date(s.end_datetime)   : null;
    if(start && end){
      return start.toLocaleDateString(undefined,{day:"2-digit",month:"short"})+" "+
             start.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"})+" – "+
             end.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"});
    }
  }
  return "—";
}

function showView(id){
  ["viewLoading","viewProjects","viewProject","viewTeam","viewInvitations"].forEach(v => {
    document.getElementById(v).classList.toggle("hidden", v!==id);
  });
  const showToolbar = (id === "viewProject");
  document.getElementById("toolbar").classList.toggle("hidden", !showToolbar);
  // Hide FAB unless shown explicitly by caller
  if(id !== "viewProject" && id !== "viewTeam"){
    document.getElementById("fabBtn").classList.add("hidden");
  }
}

function dLog(...args){
  if(!DEBUG) return;
  const el = document.getElementById("debugLog");
  if(el) el.textContent += args.join(" ") + "\n";
}

/* HTTP VIA PROXY */
function proxyUrl(path, extra=""){
  return `${PROXY_URL}?base=${encodeURIComponent(BASE)}&path=${encodeURIComponent(path)}${extra}${DEBUG?"&debug=1":""}`;
}

async function apiGET(path, queryObj){
  let qs = "";
  if(queryObj){
    const params = Object.entries(queryObj)
      .filter(([,v])=>v!==""&&v!==null&&v!==undefined)
      .map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&");
    if(params) qs = "&"+params;
  }
  dLog("GET", path, qs);
  const res = await fetch(proxyUrl(path) + qs, { headers:{"X-Beeple-Token": TOKEN} });
  const txt = await res.text();
  if(DEBUG) dLog("<-", res.status, txt.slice(0,500));
  let json = {};
  try{ json = JSON.parse(txt); }catch{}
  if(!res.ok){
    const msg = parseApiErrors(json) || ("HTTP " + res.status);
    throw new Error(msg + (DEBUG ? ` [${txt.slice(0,300)}]` : ""));
  }
  if(DEBUG) dLog(`  body: ${txt.slice(0,300)}${txt.length>300?"…":""}`);
  return json;
}

async function apiPOST(path, payload){
  dLog("POST", path, JSON.stringify(payload).slice(0,200));
  const res = await fetch(proxyUrl(path), {
    method:"POST", headers:{"X-Beeple-Token":TOKEN,"Content-Type":"application/json"}, body: JSON.stringify(payload)
  });
  const txt = await res.text();
  if(DEBUG) dLog("<-", res.status, txt.slice(0,500));
  let json = {};
  try { json = JSON.parse(txt); } catch {}
  const apiErr = parseApiErrors(json);
  if(!res.ok || (apiErr && apiErr.length)){
    const err = new Error((apiErr || "HTTP " + res.status) + (DEBUG ? ` [${txt.slice(0,300)}]` : ""));
    err.apiErrors = extractErrorList(json);
    throw err;
  }
  return json;
}

async function apiDELETEorPOST(method, path, payload){
  dLog(method, path);
  const res = await fetch(proxyUrl(path), {
    method, headers:{"X-Beeple-Token": TOKEN, "Content-Type":"application/json"},
    body: payload ? JSON.stringify(payload) : undefined
  });
  const txt = await res.text();
  if(DEBUG) dLog("<-", res.status, txt.slice(0,500));
  let json = {};
  try { json = JSON.parse(txt); } catch {}
  const apiErr = parseApiErrors(json);
  if(!res.ok || (apiErr && apiErr.length)){
    throw new Error((apiErr || "HTTP " + res.status) + (DEBUG ? ` [${txt.slice(0,300)}]` : ""));
  }
  return json;
}

/* ALERT / RESULT HELPERS */
function makeAlert(type, html){
  const d = document.createElement("div");
  d.className = `alert alert-${type}`; d.innerHTML = html; return d;
}
function appendResult(container, type, html){
  const el = makeAlert(type, html);
  container.prepend(el);
  while(container.children.length > 20) container.lastChild.remove();
}

/* ================================================================
   HISTORY / BACK-BUTTON NAVIGATION
   ================================================================ */
function pushNav(state_obj){
  history.pushState(state_obj, "", location.pathname + (state_obj.search || ""));
}

window.addEventListener("popstate", e => {
  const s = e.state;
  if(!s || s.view === "projects"){
    showView("viewProjects");
    return;
  }
  if(s.view === "project" && s.project){
    selectProject(s.project, true);
    return;
  }
  if(s.view === "subproject" && s.subproject){
    state.selectedProject = s.project;
    selectSubproject(s.subproject, true);
    return;
  }
  if(s.view === "team" && s.team){
    state.selectedProject    = s.project;
    state.selectedSubproject = s.subproject || null;
    selectTeam(s.team, true);
    return;
  }
  showView("viewProjects");
});

/* ================================================================
   LOAD PROJECTS
   ================================================================ */
async function loadProjects(){
  showView("viewLoading");
  try {
    const data = await apiGET("api/v1/admin/projects");
    state.projects = (data.projects || []).filter(p => !p.deleted && !p.deleted_at);
    renderProjectGrid(state.projects);
    showView("viewProjects");
  } catch(e) {
    showView("viewProjects");
    document.getElementById("projectGrid").innerHTML =
      makeAlert("error", `<b>Could not load projects:</b> ${escHtml(e.message)}`).outerHTML +
      `<p>Check your connection settings. <a href="index.html">Log in again →</a></p>`;
  }
}

function renderProjectGrid(projects){
  const grid = document.getElementById("projectGrid");
  grid.innerHTML = "";
  // Apply sort
  const sortSel = document.getElementById("projectSort");
  if(sortSel){
    const sv = sortSel.value;
    if(sv === "name-asc")  projects.sort((a,b) => (a.name||"").localeCompare(b.name||""));
    if(sv === "name-desc") projects.sort((a,b) => (b.name||"").localeCompare(a.name||""));
    if(sv === "date-asc")  projects.sort((a,b) => (a.start_date||"").localeCompare(b.start_date||""));
    if(sv === "date-desc") projects.sort((a,b) => (b.start_date||"").localeCompare(a.start_date||""));
  }
  if(!projects.length){
    grid.innerHTML = `<div class="empty"><p>No projects found.</p></div>`;
    return;
  }
  projects.forEach(p => {
    const color = p.color_code || "#4e6bff";
    const ended = isEnded(p.end_date);
    const el = document.createElement("div");
    el.className = ended ? "card card-ended" : "card";
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
        <span style="background:${escHtml(color)};width:12px;height:12px;border-radius:3px;flex-shrink:0;display:inline-block;${ended?"filter:grayscale(1);":""}""></span>
        <h3 style="margin:0;flex:1;min-width:0;">${escHtml(p.name)}</h3>
        <span style="font-size:11px;color:var(--muted);display:inline-flex;align-items:center;gap:3px;flex-shrink:0;">${p.published?ICON_PUBLISHED:ICON_DRAFT}${p.published?"Published":"Draft"}</span>
      </div>
      <div class="meta">
        <span title="Date">
          <svg style="width:12px;height:12px;vertical-align:-1px;stroke:currentColor;fill:none;stroke-width:2;" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          ${fmtDate(p.start_date)} – ${fmtDate(p.end_date)}
        </span><br>
        ${p.department ? `<span title="Department"><svg style="width:12px;height:12px;vertical-align:-1px;stroke:currentColor;fill:none;stroke-width:2;" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg> ${escHtml(p.department.name)}</span>` : ""}
        ${p.customer   ? `<span title="Client"><svg style="width:12px;height:12px;vertical-align:-1px;stroke:currentColor;fill:none;stroke-width:2;" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> ${escHtml(p.customer.name)}</span>` : ""}
      </div>
      <div style="margin-top:8px;">
        <span class="chip chip-blue">${p.registrations_count||0}/${p.volunteers_needed||0} enrolled</span>
        ${ended ? '<span class="chip chip-grey">Ended</span>' : ""}
      </div>`;
    el.addEventListener("click",()=>selectProject(p));
    grid.appendChild(el);
  });
}


/* Grid search — filters the subproject/team grid */
document.getElementById("gridSearch").addEventListener("input", function(){
  const q = this.value.toLowerCase();
  document.querySelectorAll("#subprojectGrid .card").forEach(el => {
    el.style.display = el.textContent.toLowerCase().includes(q) ? "" : "none";
  });
});

/* Project sort */
document.getElementById("projectSort").addEventListener("change", () => {
  if(state.projects.length) renderProjectGrid([...state.projects]);
});
document.getElementById("subprojectSort").addEventListener("change", () => {
  if(state._currentSubs && state._currentSubs.length) renderSubprojectGrid(state._currentSubs);
});

/* ================================================================
   SELECT PROJECT
   ================================================================ */
function renderSubprojectGrid(subs){
  const grid = document.getElementById("subprojectGrid");
  const sortSel = document.getElementById("subprojectSort");
  const sorted = [...subs];
  if(sortSel){
    const sv = sortSel.value;
    if(sv === "name-asc")  sorted.sort((a,b) => (a.name||"").localeCompare(b.name||""));
    if(sv === "name-desc") sorted.sort((a,b) => (b.name||"").localeCompare(a.name||""));
    if(sv === "date-asc")  sorted.sort((a,b) => (a.start_date||"").localeCompare(b.start_date||""));
    if(sv === "date-desc") sorted.sort((a,b) => (b.start_date||"").localeCompare(a.start_date||""));
  }
  grid.innerHTML = "";
  sorted.forEach(s => {
    const ended = isEnded(s.end_date);
    const el = document.createElement("div");
    el.className = ended ? "card card-ended" : "card";
    el.innerHTML = `
      <h3>${escHtml(s.name)}</h3>
      <div class="meta">
        <span title="Date">${ICON_CAL} ${fmtDate(s.start_date)} – ${fmtDate(s.end_date)}</span>
      </div>
      <div style="margin-top:8px;">
        <span class="chip chip-blue">${s.registrations_count||0}/${s.volunteers_needed||0}</span>
        ${ended ? '<span class="chip chip-grey">Ended</span>' : ""}
      </div>`;
    el.addEventListener("click", () => selectSubproject(s));
    grid.appendChild(el);
  });
}

async function selectProject(project, noPush){
  state.selectedProject    = project;
  state.selectedSubproject = null;
  state.selectedTeam       = null;
  state.departmentId       = project.department ? project.department.id : null;

  if(!noPush) pushNav({ view:"project", project, search:"?view=project&id="+project.id });

  showView("viewProject");

  const title = document.getElementById("viewProjectTitle");
  const sub   = document.getElementById("viewProjectSub");
  const grid  = document.getElementById("subprojectGrid");
  title.textContent = project.name;
  grid.innerHTML = `<div class="empty"><div class="spinner"></div><p>Loading…</p></div>`;

  setBreadcrumb("viewProject", [
    { label:"Projects", action: () => { showView("viewProjects"); history.pushState({view:"projects"}, ""); } },
    { label: project.name }
  ]);
  try{
    if(project.subprojects_enabled){
      // Subprojects view — no date bar
      hideDateBar();
      document.getElementById("fabBtn").classList.add("hidden");
      sub.textContent = "Select a subproject to see its teams.";
      const data = await apiGET(`api/v1/admin/projects/${project.id}/subprojects`);
      const subs = (data.subprojects||[]).filter(s => !s.deleted && !s.deleted_at);
      if(!subs.length){ grid.innerHTML=`<div class="empty"><p>No subprojects found.</p></div>`; return; }
      state._currentSubs = subs;
      document.getElementById("subSortBar").classList.remove("hidden");
      renderSubprojectGrid(subs);
    } else {
      // Direct teams view — show date bar + FAB
      initDateBar();
      sub.textContent = "All teams in this project:";
      document.getElementById("subSortBar").classList.add("hidden");
      state._currentSubs = null;
      showFab(project.id, null);
      await loadTeamsIntoGrid(grid, project.id, null);
    }
  }catch(e){ grid.innerHTML=`<div class="alert alert-error">Error loading: ${escHtml(e.message)}</div>`; }
}

/* ================================================================
   SELECT SUBPROJECT
   ================================================================ */
async function selectSubproject(sub, noPush){
  state.selectedSubproject = sub;
  state.selectedTeam       = null;

  if(!noPush) pushNav({ view:"subproject", project:state.selectedProject, subproject:sub, search:"?view=subproject&id="+sub.id });

  showView("viewProject");
  initDateBar();

  const project  = state.selectedProject;
  const title    = document.getElementById("viewProjectTitle");
  const subtitle = document.getElementById("viewProjectSub");
  const grid     = document.getElementById("subprojectGrid");

  title.textContent    = sub.name;
  subtitle.textContent = "";
  grid.innerHTML = `<div class="empty"><div class="spinner"></div><p>Loading teams…</p></div>`;

  setBreadcrumb("viewProject", [
    { label:"Projects",    action: () => { showView("viewProjects"); history.pushState({view:"projects"}, ""); } },
    { label: project.name, action: () => selectProject(project) },
    { label: sub.name }
  ]);

  showFab(project.id, sub.id);

  try {
    await loadTeamsIntoGrid(grid, project.id, sub.id);
  } catch(e) {
    grid.innerHTML = `<div class="alert alert-error">Error loading teams: ${escHtml(e.message)}</div>`;
  }
}

/* ================================================================
   FAB — floating action button linking to create page
   ================================================================ */
function showFab(projectId, subprojectId){
  const fab = document.getElementById("fabBtn");
  let url = `create.html?project=${encodeURIComponent(projectId)}`;
  if(subprojectId) url += `&subproject=${encodeURIComponent(subprojectId)}`;
  fab.href = url;
  fab.classList.remove("hidden");
}

function hideDateBar(){
  const bar = document.getElementById("teamDateBar");
  bar.style.display = "none";
  bar.classList.add("hidden");
  document.getElementById("teamSort").classList.add("hidden");
}

/* ================================================================
   DATE BAR
   ================================================================ */
function isoDate(d){ return d.toISOString().slice(0,10); }
function defaultDateFrom(){ const d=new Date(); d.setDate(d.getDate()-7); return isoDate(d); }
function defaultDateTo(){ const d=new Date(); d.setMonth(d.getMonth()+1); return isoDate(d); }

let _dateBarInited = false;
function initDateBar(){
  const bar  = document.getElementById("teamDateBar");
  const from = document.getElementById("teamDateFrom");
  const to   = document.getElementById("teamDateTo");
  if(!from.value) from.value = defaultDateFrom();
  if(!to.value)   to.value   = defaultDateTo();
  bar.style.display = "flex";
  bar.classList.remove("hidden");
  document.getElementById("teamSort").classList.remove("hidden");
  if(_dateBarInited) return;
  _dateBarInited = true;
  from.addEventListener("change", () => reloadCurrentTeamGrid());
  to.addEventListener("change",   () => reloadCurrentTeamGrid());
}
function reloadCurrentTeamGrid(){
  const grid=document.getElementById("subprojectGrid");
  const p=state.selectedProject; const s=state.selectedSubproject;
  if(!p) return;
  grid.innerHTML=`<div class="empty"><div class="spinner"></div><p>Loading…</p></div>`;
  loadTeamsIntoGrid(grid,p.id,s?s.id:null).then(()=>applyGridSearch()).catch(e=>{
    grid.innerHTML=`<div class="alert alert-error">Error: ${escHtml(e.message)}</div>`;
  });
}
function applyGridSearch(){
  const q = (document.getElementById("gridSearch").value||"").toLowerCase();
  if(!q) return;
  document.querySelectorAll("#subprojectGrid .card, #subprojectGrid .tl-team").forEach(el => {
    el.style.display = el.textContent.toLowerCase().includes(q) ? "" : "none";
  });
}

/* DATE NAVIGATION */
function shiftDateBar(days){
  const from = document.getElementById("teamDateFrom");
  const to   = document.getElementById("teamDateTo");
  if(!from.value || !to.value) return;
  const f = new Date(from.value); const t = new Date(to.value);
  f.setDate(f.getDate() + days); t.setDate(t.getDate() + days);
  from.value = isoDate(f); to.value = isoDate(t);
  reloadCurrentTeamGrid();
}
/* VIEW MODE: grid / timeline */
let viewMode = "grid";
const _tlTeamMap = {};

document.getElementById("viewGridBtn").addEventListener("click", () => {
  viewMode = "grid";
  document.getElementById("viewGridBtn").classList.add("active");
  document.getElementById("viewTimelineBtn").classList.remove("active");
  reloadCurrentTeamGrid();
});
document.getElementById("viewTimelineBtn").addEventListener("click", () => {
  viewMode = "timeline";
  document.getElementById("viewTimelineBtn").classList.add("active");
  document.getElementById("viewGridBtn").classList.remove("active");
  reloadCurrentTeamGrid();
});
document.getElementById("teamSort").addEventListener("change", () => reloadCurrentTeamGrid());

async function loadTeamsIntoGrid(grid, projectId, subprojectId){
  const path = subprojectId
    ? `api/v1/admin/subprojects/${subprojectId}/teams`
    : `api/v1/admin/projects/${projectId}/teams`;
  const fromVal = document.getElementById("teamDateFrom").value || defaultDateFrom();
  const toVal   = document.getElementById("teamDateTo").value   || defaultDateTo();
  const data  = await apiGET(path, { start_date: fromVal, end_date: toVal });
  const teams = (data.teams || []).filter(t => !t.deleted && !t.deleted_at);
  if(!teams.length){
    grid.innerHTML = `<div class="empty"><p>No teams found in the selected date range.</p></div>`;
    return;
  }
  // Apply sort
  const teamSortSel = document.getElementById("teamSort");
  if(teamSortSel){
    const sv = teamSortSel.value;
    if(sv === "name-asc")  teams.sort((a,b) => (a.name||"").localeCompare(b.name||""));
    if(sv === "name-desc") teams.sort((a,b) => (b.name||"").localeCompare(a.name||""));
    if(sv === "date-asc")  teams.sort((a,b) => (a.shifts?.[0]?.start_datetime||"").localeCompare(b.shifts?.[0]?.start_datetime||""));
    if(sv === "date-desc") teams.sort((a,b) => (b.shifts?.[0]?.start_datetime||"").localeCompare(a.shifts?.[0]?.start_datetime||""));
  }
  if(viewMode === "timeline"){
    renderTimeline(grid, teams, fromVal, toVal);
  } else {
    grid.innerHTML = "";
    teams.forEach(t => {
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <h3>${escHtml(t.name||"(auto-named)")}</h3>
        <div class="meta">
          <div title="Shift">${ICON_CAL} ${fmtShift(t)}</div>
          <div style="margin-top:4px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <span style="font-size:12px;color:var(--muted);display:inline-flex;align-items:center;gap:3px;">${t.published?ICON_PUBLISHED:ICON_DRAFT}${t.published?"Published":"Draft"}</span>
            <span class="chip chip-blue">${t.registrations_count||t.team_registrations_count||0}/${t.volunteers_needed||t.volunteers_needed_count||0} filled</span>
          </div>
          ${t.function ? `<div style="margin-top:4px;" title="Function">⚙ ${escHtml(t.function.name)}</div>` : ""}
          ${t.address  ? `<div title="Location">${ICON_PIN} ${escHtml(t.address.name||t.address.city||"")}</div>` : ""}
        </div>`;
      el.addEventListener("click",()=>selectTeam(t)); grid.appendChild(el);
    });
  }
}

function renderTimeline(grid, teams, fromVal, toVal){
  // Index teams for click handlers
  teams.forEach(t => { _tlTeamMap[String(t.id)] = t; });

  // Generate date columns
  const dates = [];
  const today = isoDate(new Date());
  for(let d = new Date(fromVal + "T00:00:00"); isoDate(d) <= toVal; d.setDate(d.getDate()+1)){
    dates.push(isoDate(new Date(d)));
  }

  // Group teams by shift start date
  const byDate = {};
  dates.forEach(d => { byDate[d] = []; });
  teams.forEach(t => {
    const shiftDate = t.shifts && t.shifts[0] && t.shifts[0].start_datetime
      ? t.shifts[0].start_datetime.slice(0, 10) : null;
    if(shiftDate && byDate[shiftDate] !== undefined) byDate[shiftDate].push(t);
  });

  // Build table
  let html = `<div class="timeline-wrap"><table class="timeline-table"><thead><tr>`;
  dates.forEach(d => {
    const dt = new Date(d + "T00:00:00");
    const lbl = dt.toLocaleDateString(undefined, {weekday:"short", day:"numeric", month:"short"});
    html += `<th class="${d === today ? "tl-today" : ""}">${escHtml(lbl)}${d === today ? ' <span class="chip chip-blue" style="font-size:10px;padding:1px 5px;">Today</span>' : ""}</th>`;
  });
  html += `</tr></thead><tbody><tr>`;
  dates.forEach(d => {
    html += `<td>`;
    const dayTeams = byDate[d] || [];
    if(!dayTeams.length){
      html += `<div class="tl-empty">—</div>`;
    } else {
      dayTeams.forEach(t => {
        const name   = escHtml(t.name || "(auto-named)");
        const filled = `${t.registrations_count||t.team_registrations_count||0}/${t.volunteers_needed||t.volunteers_needed_count||0}`;
        const timeStr = (() => {
          if(t.shifts && t.shifts[0]){
            const s = new Date(t.shifts[0].start_datetime);
            const e = new Date(t.shifts[0].end_datetime);
            if(!isNaN(s.getTime()) && !isNaN(e.getTime())){
              return s.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"}) + "–" +
                     e.toLocaleTimeString(undefined,{hour:"2-digit",minute:"2-digit"});
            }
          }
          return "";
        })();
        html += `<div class="tl-team" data-tl-id="${escHtml(String(t.id))}">
          <div class="tl-team-name">${name}</div>
          <div class="tl-team-meta">${timeStr ? escHtml(timeStr) + " · " : ""}${escHtml(filled)} ${t.published?ICON_PUBLISHED:ICON_DRAFT}</div>
          ${t.function ? `<div class="tl-team-meta">⚙ ${escHtml(t.function.name)}</div>` : ""}
        </div>`;
      });
    }
    html += `</td>`;
  });
  html += `</tr></tbody></table></div>`;
  grid.innerHTML = html;

  // Wire click handlers
  grid.querySelectorAll(".tl-team").forEach(el => {
    el.addEventListener("click", () => {
      const t = _tlTeamMap[el.dataset.tlId];
      if(t) selectTeam(t);
    });
  });
}

/* ================================================================
   SELECT TEAM
   ================================================================ */
async function selectTeam(team, noPush){
  state.selectedTeam = team;

  if(!noPush) pushNav({
    view:"team", team,
    project: state.selectedProject,
    subproject: state.selectedSubproject,
    search:"?view=team&id="+team.id
  });

  showView("viewTeam");
  document.getElementById("fabBtn").classList.add("hidden");

  document.getElementById("debugLogWrap").classList.toggle("hidden", !DEBUG);
  if(DEBUG) document.getElementById("debugLog").textContent = "";

  const project = state.selectedProject;
  const sub     = state.selectedSubproject;

  const crumbs = [
    { label:"Projects", action: () => { showView("viewProjects"); history.pushState({view:"projects"}, ""); } }
  ];
  if(project) crumbs.push({ label: project.name, action: () => selectProject(project) });
  if(sub) crumbs.push({ label: sub.name, action: () => selectSubproject(sub) });
  crumbs.push({ label: team.name || "(team)" });
  setBreadcrumb("viewTeam", crumbs);

  document.getElementById("teamTitle").textContent = team.name || "(auto-named)";
  document.getElementById("teamChips").innerHTML =
    `<span style="font-size:13px;color:var(--muted);display:inline-flex;align-items:center;gap:3px;">${team.published?ICON_PUBLISHED:ICON_DRAFT}${team.published?"Published":"Draft"}</span>
     <span class="chip chip-blue">${team.registrations_count||team.team_registrations_count||0}/${team.volunteers_needed||team.volunteers_needed_count||0} filled</span>`;
  document.getElementById("teamMeta").innerHTML =
    [fmtShift(team),
     team.function ? `<span title="Function">⚙ ${escHtml(team.function.name)}</span>` : "",
     team.address  ? `<span title="Location">${ICON_PIN} ${escHtml(team.address.name||team.address.city||"")}</span>` : ""
    ].filter(Boolean).join(" &nbsp;·&nbsp; ");

  document.getElementById("enrolResults").innerHTML  = "";
  document.getElementById("collabResults").innerHTML = "";
  document.getElementById("collabSentinel").innerHTML = "";
  document.getElementById("candidaciesCard").classList.add("hidden");
  document.getElementById("candidaciesFeed").innerHTML = "";
  document.getElementById("enrolmentsFeed").innerHTML = `<div class="empty"><div class="spinner"></div><p>Loading enrolments…</p></div>`;

  // Fetch individual team to get accurate counts (volunteers_needed + registrations_count)
  apiGET(`api/v1/admin/teams/${team.id}`).then(td => {
    const t = td.team || td;
    const needed = t.volunteers_needed || t.volunteers_needed_count || team.volunteers_needed || team.volunteers_needed_count || 0;
    const enrolled = t.registrations_count || t.team_registrations_count || team.registrations_count || team.team_registrations_count || 0;
    // Update state with fresh data
    if(state.selectedTeam && String(state.selectedTeam.id) === String(team.id)){
      state.selectedTeam.volunteers_needed = needed;
      state.selectedTeam.registrations_count = enrolled;
    }
    const chipsEl = document.getElementById("teamChips");
    if(chipsEl){
      const chip = chipsEl.querySelector(".chip-blue");
      if(chip) chip.textContent = `${enrolled}/${needed} filled`;
    }
    // Also update title/meta if team has fresher name/info
    if(t.name) document.getElementById("teamTitle").textContent = t.name;
  }).catch(()=>{});

  loadEnrolments(team.id);
  loadCandidacies(team.id);
}

/* ================================================================
   LOAD ENROLMENTS
   ================================================================ */
async function loadEnrolments(teamId){
  const feed = document.getElementById("enrolmentsFeed");
  if(!feed) return;
  feed.innerHTML = `<div class="empty"><div class="spinner"></div><p>Loading enrolments…</p></div>`;
  try {
    const data   = await apiGET(`api/v1/admin/teams/${teamId}/enrolments`);
    const enrols = data.enrolments || data.team_registrations || [];
    // Update the filled count chip with the actual enrolment count
    const activeCount = enrols.filter(e => !e.cancelled).length;
    const chipsEl = document.getElementById("teamChips");
    if(chipsEl){
      const chip = chipsEl.querySelector(".chip-blue");
      if(chip){
        const needed = state.selectedTeam
          ? (state.selectedTeam.volunteers_needed || state.selectedTeam.volunteers_needed_count || 0)
          : 0;
        chip.textContent = `${activeCount}/${needed} filled`;
      }
    }
    if(!enrols.length){
      feed.innerHTML = `<div class="empty"><p>No enrolments yet for this team.</p></div>`;
      return;
    }
    feed.innerHTML = `<div class="enrol-list" id="enrolListInner"></div>`;
    const list = document.getElementById("enrolListInner");
    enrols.forEach(e => {
      const c   = e.collaborator || e.volunteer || {};
      const row = document.createElement("div");
      row.className = "enrol-item";
      row.dataset.enrolId = e.id;
      row.innerHTML = `
        <div class="collab-avatar" style="cursor:pointer;" title="View details" data-view-collab="${escHtml(String(c.id||""))}">${escHtml(initials(c.first_name,c.last_name))}</div>
        <div class="enrol-info" style="cursor:pointer;" data-view-collab="${escHtml(String(c.id||""))}">
          <div class="enrol-name">${escHtml(c.first_name||"")} ${escHtml(c.last_name||"")}</div>
          <div style="font-size:12px;color:var(--muted);">
            ${e.contract_type?`<span class="chip chip-grey">${escHtml(e.contract_type)}</span>`:""}
            ${e.confirmed?'<span class="chip chip-green">Confirmed</span>':'<span class="chip chip-yellow">Unconfirmed</span>'}
            ${e.cancelled?'<span class="chip chip-red">Cancelled</span>':""}
            ${c.email?`<span>${escHtml(c.email)}</span>`:""}
          </div>
        </div>
        <div><button class="btn btn-sm btn-danger" data-cancel-enrol="${escHtml(String(e.id))}">Cancel</button></div>`;
      list.appendChild(row);
    });
  }catch(ex){
    feed.innerHTML=`<div class="alert alert-error"><b>Could not load enrolments:</b> ${escHtml(ex.message)}</div>`;
  }
}

/* ================================================================
   CANCEL ENROLMENT
   ================================================================ */
document.addEventListener("click", async function(ev){
  const btn=ev.target.closest("[data-cancel-enrol]"); if(!btn) return;
  const enrolId=btn.dataset.cancelEnrol;
  if(!confirm("Cancel this enrolment?")) return;
  btn.disabled = true; btn.textContent = "…";
  try {
    await apiDELETEorPOST("POST", `api/v1/admin/enrolments/${enrolId}/cancel`, {});
    const row = btn.closest(".enrol-item");
    if(row){
      row.style.opacity = ".4";
      row.querySelectorAll("button").forEach(b => b.disabled = true);
      row.querySelector(".enrol-info").innerHTML += '<span class="chip chip-red" style="margin-left:6px;">Cancelled</span>';
    }
    btn.textContent = "Cancelled";
  } catch(e) {
    btn.disabled = false; btn.textContent = "Cancel";
    alert("Cancel failed: " + e.message);
  }
});

/* ================================================================
   CANDIDACIES
   ================================================================ */
async function loadCandidacies(teamId){
  const card = document.getElementById("candidaciesCard");
  const feed = document.getElementById("candidaciesFeed");
  if(!card || !feed) return;
  try {
    const data = await apiGET(`api/v1/admin/teams/${teamId}/candidacies`);
    const candidacies = data.candidacies || [];
    if(!candidacies.length){ card.classList.add("hidden"); return; }
    card.classList.remove("hidden");
    feed.innerHTML = `<div class="enrol-list" id="candidaciesListInner"></div>`;
    const list = document.getElementById("candidaciesListInner");
    candidacies.forEach(cand => {
      const c = cand.collaborator || cand.volunteer || {};
      const nm = ((c.first_name||"")+" "+(c.last_name||"")).trim() || c.email || "(unknown)";
      const av = initials(c.first_name, c.last_name) || "?";
      const row = document.createElement("div");
      row.className = "enrol-item";
      row.dataset.candidacyId = cand.id;
      row.innerHTML = `
        <div class="collab-avatar" style="cursor:pointer;" title="View details" data-view-collab="${escHtml(String(c.id||""))}">${escHtml(av)}</div>
        <div class="enrol-info">
          <div class="enrol-name">${escHtml(nm)}</div>
          <div style="font-size:12px;color:var(--muted);">${c.email ? escHtml(c.email) : ""}</div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="btn btn-success btn-sm" data-accept-candidacy="${escHtml(String(cand.id))}">Accept</button>
          <button class="btn btn-danger btn-sm" data-reject-candidacy="${escHtml(String(cand.id))}">Reject</button>
        </div>`;
      list.appendChild(row);
    });
  } catch(ex) {
    card.classList.add("hidden");
  }
}

document.addEventListener("click", async function(ev){
  const acceptBtn = ev.target.closest("[data-accept-candidacy]");
  const rejectBtn = ev.target.closest("[data-reject-candidacy]");
  if(!acceptBtn && !rejectBtn) return;

  const isAccept = !!acceptBtn;
  const btn = isAccept ? acceptBtn : rejectBtn;
  const candId = btn.dataset[isAccept ? "acceptCandidacy" : "rejectCandidacy"];
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner" style="width:14px;height:14px;border-width:2px;"></span>';

  try {
    await apiDELETEorPOST("POST", `api/v1/admin/candidacies/${candId}/${isAccept ? "accept" : "reject"}`, {});
    const row = btn.closest(".enrol-item");
    if(row){
      row.style.opacity = ".4";
      row.querySelectorAll("button").forEach(b => b.disabled = true);
      const chip = document.createElement("span");
      chip.className = isAccept ? "chip chip-green" : "chip chip-red";
      chip.textContent = isAccept ? "Accepted" : "Rejected";
      chip.style.marginLeft = "6px";
      row.querySelector(".enrol-info").appendChild(chip);
    }
    btn.textContent = isAccept ? "Accepted" : "Rejected";
  } catch(e) {
    btn.disabled = false;
    btn.textContent = isAccept ? "Accept" : "Reject";
    alert((isAccept ? "Accept" : "Reject") + " failed: " + e.message);
  }
});

/* ================================================================
   COLLABORATOR SEARCH — INFINITE SCROLL
   ================================================================ */
let _collabQuery = null;
let _collabPage  = 0;
let _collabTotalPages = 1;
let _collabLoading = false;
let _collabAllItems = [];
let _collabObserver = null;

function _buildCollabQuery(){
  const driverLicVal = document.getElementById("fDriverLicense").value;
  return {
    q:                  document.getElementById("fSearch").value.trim() || undefined,
    function_id:        document.getElementById("fFunction").value      || undefined,
    language:           document.getElementById("fLanguage").value      || undefined,
    archived:           document.getElementById("fArchived").value === "true" ? true : undefined,
    blocked:            document.getElementById("fBlocked").value  === "true" ? true : undefined,
    minimum_age:        document.getElementById("fMinAge").value         || undefined,
    city:               document.getElementById("fCity").value           || undefined,
    postal_code:        document.getElementById("fPostalCode").value     || undefined,
    distance:           document.getElementById("fDistance").value       || undefined,
    available_from:     document.getElementById("fAvailableFrom").value  || undefined,
    available_to:       document.getElementById("fAvailableTo").value    || undefined,
    gender:             document.getElementById("fGender").value         || undefined,
    nationality:        document.getElementById("fNationality").value    || undefined,
    has_driver_license: driverLicVal === "" ? undefined : (driverLicVal === "true"),
    department_id:      state.departmentId                               || undefined,
    per_page:           100
  };
}

async function searchCollaborators(){
  _collabPage = 0; _collabTotalPages = 1; _collabLoading = false; _collabAllItems = [];
  const container = document.getElementById("collabResults");
  container.innerHTML = '<div class="empty"><div class="spinner"></div><p>Searching…</p></div>';
  document.getElementById("collabSentinel").innerHTML = "";
  document.getElementById("contractTypeWrap").classList.add("hidden");
  document.getElementById("collabSortBar").classList.add("hidden");

  const searchVal = document.getElementById("fSearch").value.trim().toLowerCase();
  _collabQuery = _buildCollabQuery();
  _collabQuery._searchVal = searchVal;
  Object.keys(_collabQuery).forEach(k => _collabQuery[k]===undefined && delete _collabQuery[k]);

  await _loadCollabPage();

  if(_collabObserver) _collabObserver.disconnect();
  const sentinel = document.getElementById("collabSentinel");
  _collabObserver = new IntersectionObserver(entries => {
    if(entries[0].isIntersecting && !_collabLoading && _collabPage < _collabTotalPages) _loadCollabPage();
  }, { rootMargin:"200px" });
  _collabObserver.observe(sentinel);
}

async function _loadCollabPage(){
  if(_collabLoading) return;
  if(_collabPage > 0 && _collabPage >= _collabTotalPages) return;
  _collabLoading = true;
  const sentinel = document.getElementById("collabSentinel");
  if(sentinel && _collabPage > 0) sentinel.innerHTML = '<div class="spinner" style="width:24px;height:24px;border-width:2px;margin:8px auto;"></div>';

  const query = { ..._collabQuery };
  const searchVal = query._searchVal || "";
  delete query._searchVal;
  query.page = _collabPage + 1;

  try {
    const data   = await apiGET("api/v1/admin/collaborators", query);
    let collabs  = data.volunteers || data.collaborators || [];
    const meta   = data.meta || {};

    _collabPage = meta.current_page || query.page;
    _collabTotalPages = meta.total_pages || Math.ceil((meta.total_count || collabs.length) / (meta.per_page || 100)) || 1;

    if(searchVal) collabs = collabs.filter(c => {
      const full = ((c.first_name||"")+" "+(c.last_name||"")).toLowerCase();
      return full.includes(searchVal);
    });

    _collabAllItems = [..._collabAllItems, ...collabs];

    const container = document.getElementById("collabResults");
    if(_collabPage === 1) container.innerHTML = "";

    if(_collabAllItems.length === 0 && _collabPage >= _collabTotalPages){
      container.innerHTML = '<div class="empty"><p>No collaborators found.</p></div>';
      if(sentinel) sentinel.innerHTML = "";
      _collabLoading = false; return;
    }

    let list = container.querySelector(".collab-list");
    if(!list){ list = document.createElement("div"); list.className = "collab-list"; container.appendChild(list); }
    collabs.forEach(c => _renderCollabCard(c, list));

    document.getElementById("contractTypeWrap").classList.remove("hidden");
    document.getElementById("collabSortBar").classList.remove("hidden");
    _updateCollabSort();

    const allLoaded = _collabPage >= _collabTotalPages;
    if(sentinel) sentinel.innerHTML = allLoaded ? "" : "";

  } catch(e) {
    document.getElementById("collabResults").innerHTML = `<div class="alert alert-error"><b>Search failed:</b> ${escHtml(e.message)}</div>`;
    if(sentinel) sentinel.innerHTML = "";
  }
  _collabLoading = false;
}

function _updateCollabSort(){
  const sortSel = document.getElementById("collabSort");
  if(!sortSel) return;
  const allLoaded = _collabPage >= _collabTotalPages;
  sortSel.disabled = !allLoaded;
  const bar = document.getElementById("collabSortBar");
  if(bar) bar.title = allLoaded ? "" : "Sorting is only possible when all collaborators are loaded";
}

function _applyCollabSort(){
  const container = document.getElementById("collabResults");
  let list = container.querySelector(".collab-list");
  if(!list || !_collabAllItems.length) return;
  const sorted = [..._collabAllItems];
  const sv = document.getElementById("collabSort").value;
  if(sv === "name-asc")  sorted.sort((a,b) => ((a.last_name||"")+(a.first_name||"")).localeCompare((b.last_name||"")+(b.first_name||"")));
  if(sv === "name-desc") sorted.sort((a,b) => ((b.last_name||"")+(b.first_name||"")).localeCompare((a.last_name||"")+(a.first_name||"")));
  if(sv === "email-asc")  sorted.sort((a,b) => (a.email||"").localeCompare(b.email||""));
  if(sv === "email-desc") sorted.sort((a,b) => (b.email||"").localeCompare(a.email||""));
  list.innerHTML = "";
  sorted.forEach(c => _renderCollabCard(c, list));
}

function _renderCollabCard(c, list){
  const card = document.createElement("div");
  card.className = "collab-card";
  const av = initials(c.first_name, c.last_name);
  const avatarContent = av ? escHtml(av) : ICON_PERSON;
  const displayName = ((c.first_name||"")+" "+(c.last_name||"")).trim() || c.email || "(unknown)";
  const hasRealName = !!(c.first_name || c.last_name);
  const metaEmail = hasRealName ? (c.email || "") : "";
  card.innerHTML = `
    <div class="collab-avatar" data-view-collab="${escHtml(String(c.id))}" title="View details">${avatarContent}</div>
    <div class="collab-info" data-view-collab="${escHtml(String(c.id))}">
      <div class="collab-name">${escHtml(displayName)}</div>
      <div class="collab-meta">
        ${metaEmail ? escHtml(metaEmail) : ""}
        ${c.function ? (metaEmail ? " · " : "") + "<span title='Function'>⚙ " + escHtml(c.function.name) + "</span>" : ""}
        ${c.language ? " · " + escHtml(c.language.toUpperCase()) : ""}
        ${c.blocked  ? ' <span class="chip chip-red">Blocked</span>' : ""}
        ${c.archived ? ' <span class="chip chip-grey">Archived</span>' : ""}
      </div>
    </div>
    <div class="collab-actions">
      <button class="btn primary btn-sm"
              data-enrol-id="${escHtml(String(c.id))}"
              data-enrol-name="${escHtml(displayName)}">Enrol</button>
      <button class="btn btn-success btn-sm"
              data-invite-id="${escHtml(String(c.id))}"
              data-invite-name="${escHtml(displayName)}">Invite</button>
    </div>
    <div class="collab-card-error" hidden></div>`;
  list.appendChild(card);
}

document.getElementById("collabSort").addEventListener("change", () => {
  if(_collabPage >= _collabTotalPages) _applyCollabSort();
});
document.getElementById("searchCollabBtn").addEventListener("click", () => searchCollaborators());
document.getElementById("fSearch").addEventListener("keydown", e => { if(e.key==="Enter") searchCollaborators(); });
document.getElementById("clearFiltersBtn").addEventListener("click", () => {
  ["fSearch","fMinAge","fCity","fPostalCode","fDistance","fNationality","fAvailableFrom","fAvailableTo"].forEach(id => document.getElementById(id).value = "");
  ["fFunction","fLanguage","fArchived","fBlocked","fGender","fDriverLicense"].forEach(id => document.getElementById(id).selectedIndex = 0);
  document.getElementById("collabResults").innerHTML    = "";
  document.getElementById("collabSentinel").innerHTML  = "";
  document.getElementById("contractTypeWrap").classList.add("hidden");
  document.getElementById("collabSortBar").classList.add("hidden");
  _collabAllItems = []; _collabPage = 0; _collabTotalPages = 1;
  if(_collabObserver) _collabObserver.disconnect();
});

document.getElementById("advFilterBtn").addEventListener("click", function(){
  const wrap = document.getElementById("advFilterWrap");
  const isHidden = wrap.classList.toggle("hidden");
  const arrow = this.querySelector("svg");
  if(arrow) arrow.style.transform = isHidden ? "" : "rotate(180deg)";
  this.childNodes[1] && (this.lastChild.textContent = isHidden ? " Advanced filters" : " Hide advanced");
});

/* ================================================================
   ENROL / INVITE (buttons on each collaborator card)
   ================================================================ */
document.addEventListener("click", async function(ev){
  const enrolBtn  = ev.target.closest("[data-enrol-id]");
  const inviteBtn = ev.target.closest("[data-invite-id]");
  if(!enrolBtn && !inviteBtn) return;

  const isInvite   = !!inviteBtn;
  const btn        = isInvite ? inviteBtn : enrolBtn;
  const collabId   = btn.dataset[isInvite ? "inviteId"   : "enrolId"];
  const collabName = btn.dataset[isInvite ? "inviteName" : "enrolName"];

  if(!state.selectedTeam){ alert("No team selected."); return; }

  const contractType = document.getElementById("globalContractType").value;
  if(!contractType){ alert("Please select a contract type above before enrolling or inviting."); return; }

  const log = document.getElementById("enrolResults");
  const origText = btn.textContent;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner" style="width:14px;height:14px;border-width:2px;"></span>';

  try {
    const res = await apiPOST(`api/v1/admin/collaborators/enrolments`, {
      team_registration: {
        collaborator_id: collabId,
        team_id:         state.selectedTeam.id,
        contract_type:   contractType,
        invitation:      isInvite
      }
    });
    const enrolId = (res.team_registration && res.team_registration.id) || (res.enrolment && res.enrolment.id) || res.id || "?";
    const action  = isInvite ? "Invitation sent" : "Enrolled";
    // Replace any existing error block, keep successes
    const oldErr = log.querySelector(".alert-error");
    if(oldErr) oldErr.remove();
    appendResult(log, "success",
      `<b>${action}:</b> ${escHtml(collabName)} → "${escHtml(state.selectedTeam.name||"")}" (#${escHtml(String(enrolId))})`);
    btn.textContent = isInvite ? "✓ Invited" : "✓ Enrolled";
    const card = btn.closest(".collab-card");
    if(card){ const ce = card.querySelector(".collab-card-error"); if(ce) ce.hidden = true; }
    if(!isInvite) loadEnrolments(state.selectedTeam.id);
  } catch(e) {
    const errList = e.apiErrors || [e.message];
    const errHtml = `<b>Error overview</b><ul style="margin:4px 0 0;padding-left:20px;">${errList.map(p => `<li>${escHtml(String(p).trim())}</li>`).join("")}</ul>`;
    const card = btn.closest(".collab-card");
    const cardError = card ? card.querySelector(".collab-card-error") : null;
    if(cardError){
      cardError.innerHTML = `<div class="alert alert-error" style="margin:4px 0 0;padding:8px 12px;font-size:13px;">${errHtml}</div>`;
      cardError.hidden = false;
    } else {
      const oldErr = log.querySelector(".alert-error");
      if(oldErr) oldErr.remove();
      appendResult(log, "error", errHtml);
    }
    btn.disabled = false; btn.textContent = origText;
  }
});

/* ================================================================
   COLLABORATOR DETAIL MODAL
   ================================================================ */
document.addEventListener("click", async function(ev){
  const trigger = ev.target.closest("[data-view-collab]");
  if(!trigger) return;
  const collabId = trigger.dataset.viewCollab;
  if(!collabId || collabId === "undefined") return;
  openCollabModal(collabId);
});

document.getElementById("collabModalClose").addEventListener("click", () => {
  document.getElementById("collabModal").classList.add("hidden");
});
document.getElementById("collabModal").addEventListener("click", e => {
  if(e.target === e.currentTarget) e.currentTarget.classList.add("hidden");
});

async function openCollabModal(collabId){
  const modal  = document.getElementById("collabModal");
  const body   = document.getElementById("collabModalBody");
  const avatar = document.getElementById("collabModalAvatar");
  const name   = document.getElementById("collabModalName");

  avatar.textContent = "…";
  name.textContent   = "Loading…";
  body.innerHTML     = `<div class="empty"><div class="spinner"></div><p>Loading…</p></div>`;
  modal.classList.remove("hidden");

  try {
    const data = await apiGET(`api/v1/admin/collaborators/${collabId}`);
    const c    = data.volunteer || data.collaborator || data;

    const av = initials(c.first_name, c.last_name);
    if(av){ avatar.textContent = av; } else { avatar.innerHTML = ICON_PERSON; }
    name.textContent   = [c.first_name, c.last_name].filter(Boolean).join(" ") || "(no name)";

    const rows = [
      ["Email",        c.email],
      ["Phone",        c.phone || c.mobile],
      ["Language",     c.language ? c.language.toUpperCase() : null],
      ["Function",     c.function ? c.function.name : null],
      ["Department",   c.department ? c.department.name : null],
      ["Date of birth",c.date_of_birth ? fmtDate(c.date_of_birth) : null],
      ["Status",       [c.archived?"Archived":null, c.blocked?"Blocked":null].filter(Boolean).join(", ") || "Active"],
      ["Address",      c.address ? [c.address.street, c.address.number, c.address.city].filter(Boolean).join(" ") : null],
    ];

    let html = `<div class="detail-grid">`;
    rows.forEach(([label, val]) => {
      if(!val && val !== 0) return;
      html += `<div class="detail-item"><label>${escHtml(label)}</label><span>${escHtml(String(val))}</span></div>`;
    });
    html += `</div>`;

    // Profile properties if present
    const props = c.profile_properties || c.profile_property_answers || [];
    if(props.length){
      html += `<hr style="border:none;border-top:1px solid var(--border);margin:16px 0;">`;
      html += `<div style="font-weight:700;font-size:13px;color:var(--muted);margin-bottom:10px;">Profile properties</div>`;
      html += `<div class="detail-grid">`;
      props.forEach(p => {
        html += `<div class="detail-item"><label>${escHtml(p.name||p.label||"")}</label><span>${escHtml(String(p.value||p.answer||"—"))}</span></div>`;
      });
      html += `</div>`;
    }

    // Availabilities around team start date
    const teamStartDate = state.selectedTeam?.shifts?.[0]?.start_datetime?.slice(0,10);
    if(teamStartDate){
      try{
        const d0 = new Date(teamStartDate + "T00:00:00");
        const d1 = new Date(d0); d1.setDate(d1.getDate()-7);
        const d2 = new Date(d0); d2.setDate(d2.getDate()+7);
        const fromDate = isoDate(d1);
        const toDate   = isoDate(d2);
        const avData   = await apiGET(`api/v1/admin/collaborators/${collabId}/availabilities`, { from: fromDate, to: toDate });
        const avList   = avData.availabilities || avData.volunteer_availabilities || [];
        html += `<hr style="border:none;border-top:1px solid var(--border);margin:16px 0;">`;
        html += `<div style="font-weight:700;font-size:13px;color:var(--muted);margin-bottom:10px;">Availabilities <span style="font-weight:400;">(${fmtDate(fromDate)} – ${fmtDate(toDate)})</span></div>`;
        if(avList.length){
          html += `<div style="display:flex;flex-direction:column;gap:0;">`;
          avList.forEach(a => {
            const dateStr = a.date || a.start_date || (a.from_datetime?.slice(0,10)) || (a.starts_at?.slice(0,10)) || "";
            const t1 = a.start_time || a.from_time || a.starts_at?.slice(11,16) || "";
            const t2 = a.end_time   || a.to_time   || a.ends_at?.slice(11,16)   || "";
            const timeStr = t1 && t2 ? `${t1} – ${t2}` : (t1 || t2 || "All day");
            const unavail = a.available === false || a.type === "unavailable";
            const color = unavail ? "var(--danger)" : "var(--accent)";
            const label = unavail ? "Unavailable" : (a.type ? a.type.charAt(0).toUpperCase()+a.type.slice(1) : "Available");
            html += `<div style="display:flex;gap:12px;font-size:13px;padding:5px 0;border-bottom:1px solid var(--border);">
              <span style="min-width:90px;">${fmtDate(dateStr)}</span>
              <span style="flex:1;color:var(--muted);">${escHtml(timeStr)}</span>
              <span style="color:${color};font-weight:600;">${escHtml(label)}</span>
            </div>`;
          });
          html += `</div>`;
        } else {
          html += `<p style="font-size:13px;color:var(--muted);margin:0;">No availabilities recorded for this period.</p>`;
        }
      }catch(avErr){
        dLog("Availabilities error:", avErr.message);
      }
    }

    body.innerHTML = html;
  } catch(e) {
    body.innerHTML = `<div class="alert alert-error"><b>Could not load collaborator:</b> ${escHtml(e.message)}</div>`;
  }
}

/* ================================================================
   PAGINATION
   ================================================================ */
function renderPagination(container, current, total, callback){
  container.innerHTML = "";
  const prev = document.createElement("button");
  prev.className = "page-btn"; prev.textContent = "← Prev"; prev.disabled = current <= 1;
  prev.addEventListener("click", () => callback(current-1));
  container.appendChild(prev);

  const info = document.createElement("span");
  info.style.cssText = "font-size:13px;color:var(--muted);padding:0 8px;";
  info.textContent = `Page ${current} of ${total}`;
  container.appendChild(info);

  const next = document.createElement("button");
  next.className = "page-btn"; next.textContent = "Next →"; next.disabled = current >= total;
  next.addEventListener("click", () => callback(current+1));
  container.appendChild(next);
}

/* BREADCRUMB */
function setBreadcrumb(containerId, crumbs){
  const idMap = { viewTeam:"breadcrumbTeam", viewInvitations:"breadcrumbInv" };
  const el = document.getElementById(idMap[containerId] || "breadcrumb");
  el.innerHTML = "";
  crumbs.forEach((c, i) => {
    if(i > 0){ const sep = document.createElement("span"); sep.textContent = "›"; el.appendChild(sep); }
    if(c.action){
      const a = document.createElement("a"); a.textContent = c.label; a.addEventListener("click", c.action); el.appendChild(a);
    } else {
      const s = document.createElement("span"); s.textContent = c.label; el.appendChild(s);
    }
  });
}

/* LOAD FUNCTIONS FOR FILTER */
async function loadFunctions(){
  try{
    const data=await apiGET("api/v1/admin/functions");
    const fns=data.functions||[];
    const sel=document.getElementById("fFunction");
    fns.forEach(f=>{ const o=document.createElement("option"); o.value=f.id; o.textContent=f.name; sel.appendChild(o); });
  }catch{}
}

/* DEBUG CLEAR */
const _dbgClearBtn = document.getElementById("debugClearBtn");
if(_dbgClearBtn) _dbgClearBtn.addEventListener("click",()=>{ document.getElementById("debugLog").textContent=""; });

/* INIT */
(function init(){
  const t=localStorage.getItem("theme")||"light";
  document.documentElement.setAttribute("data-theme",t);
  syncTheme();

  /* Debug */
  syncDebug();

  /* Replace the initial history entry so back-button works from first step */
  history.replaceState({ view:"projects" }, "", location.href);

  /* Cookie banner */
  if(!getCookie("beeple_cookie_ok")){
    document.getElementById("cookie").classList.remove("hidden");
  }

  if(!BASE||!TOKEN){
    window.location.replace("index.html");
    return;
  }

  loadFunctions();

  /* Load projects, then pre-select from URL params if navigated via FAB or create page */
  const sp = new URLSearchParams(location.search);
  const targetProject = sp.get("project");
  const targetSub     = sp.get("subproject");
  const targetTeam    = sp.get("team");
  (async () => {
    await loadProjects();
    if(targetTeam){
      // Navigate directly to team detail page
      try {
        const td = await apiGET(`api/v1/admin/teams/${targetTeam}`);
        const team = td.team || td;
        // Try to find the project in the loaded list, or build a minimal object from team data
        const projId = team.project_id || (team.project && team.project.id) || (team.subproject && team.subproject.project_id);
        const projObj = state.projects.find(x => String(x.id) === String(projId))
          || (team.project ? team.project : (projId ? { id: projId, name: "Project" } : null));
        if(projObj){
          state.selectedProject = projObj;
          const subObj = team.subproject || null;
          if(subObj) state.selectedSubproject = subObj;
        }
        await selectTeam(team);
      } catch(e) {
        // Fall back to projects view
      }
    } else if(targetProject){
      const p = state.projects.find(x => String(x.id) === targetProject);
      if(p){
        await selectProject(p);
        if(targetSub && p.subprojects_enabled){
          try{
            const data = await apiGET(`api/v1/admin/projects/${p.id}/subprojects`);
            const s = (data.subprojects||[]).find(x => String(x.id) === targetSub);
            if(s) await selectSubproject(s);
          }catch(e){ /* subproject not found or failed to load, stay on project view */ }
        }
      }
    }
  })();
})();
</script>
</body>
</html>
